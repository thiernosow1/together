"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _chokidar = require("chokidar");

var _defineProperties = _interopRequireDefault(require("../../lib/helpers/defineProperties"));

var _identity = _interopRequireDefault(require("../../lib/helpers/identity"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function aggregate(fn, combiner = _identity.default, delay) {
  const calls = new Map();
  let timerId;
  return (...args) => {
    clearTimeout(timerId);
    timerId = setTimeout(() => {
      fn([...calls.values()]);
      calls.clear();
    }, delay);
    calls.set(combiner(...args), args);
  };
}

class Watcher extends _chokidar.FSWatcher {
  constructor(opts) {
    super(_objectSpread({
      ignoreInitial: true,
      persistent: true
    }, opts));

    _defineProperty(this, "scopes", new Map());

    (0, _defineProperties.default)(this, {
      ready: {
        value: false,
        writable: true
      },
      size: {
        get: () => [...this.scopes.values()].reduce((acc, {
          size
        }) => acc + size, 0)
      }
    });
    this.reset();
    this.setMaxListeners(100);
    this.once('ready', () => {
      this.ready = true;
    });
  }

  getPaths() {
    const paths = new Set();

    for (const [, scopePaths] of this.scopes) {
      for (const path of scopePaths) {
        paths.add(path);
      }
    }

    return paths;
  }

  getWatched() {
    return new Set(Object.entries(super.getWatched()).reduce((acc, [base, files]) => {
      files.forEach(file => {
        acc.push(_path.default.join(base, file));
      });
      return acc;
    }, []));
  }

  addUnwatched() {
    const watched = this.getWatched();
    this.add([...this.getPaths()].filter(path => !watched.has(path)));
  }

  start() {
    return new Promise(resolve => {
      this.addUnwatched();

      if (this.ready || this.size === 0) {
        resolve(this);
      } else {
        this.once('ready', () => resolve(this));
      }
    });
  }

  register(resource) {
    const {
      scopeKey
    } = resource.options;

    if (!this.scopes.has(scopeKey)) {
      this.scopes.set(scopeKey, new Set());
    }

    const scopePaths = this.scopes.get(scopeKey);
    [resource, ...resource.getDeepDependencySet(r => r.isNormal())].forEach(r => {
      scopePaths.add(r.origin);
    });

    if (resource.options.rcpath) {
      scopePaths.add(resource.options.rcpath);
    }
  }

  subscribe(resourceFactory, fn) {
    const wrappedFn = async events => {
      let mainResource = resourceFactory();
      const pickedEvents = [];

      for (const [type, path] of events) {
        if (path === mainResource.options.rcpath) {
          // eslint-disable-next-line no-await-in-loop
          await resourceFactory.reset();
          resourceFactory.uncache();
          mainResource = resourceFactory();
          pickedEvents.push([type, mainResource]);
        } else {
          // unwatch deleted resources
          if (type === 'unlink') {
            this.unwatch(path);
          }

          const resource = resourceFactory(path);

          if (resource && (resource.sameAs(mainResource) || resource.dependencyOf(mainResource))) {
            pickedEvents.push([type, resource]);
          }
        }
      }

      if (pickedEvents.length) {
        try {
          this.emit('beforeupdate', mainResource);
          await fn(pickedEvents);
          this.register(mainResource);
          this.addUnwatched();
          this.emit('update', mainResource);
        } catch (err) {
          if (this.listenerCount('error')) {
            this.emit('error', err);
          } else {
            throw err;
          }
        }
      }
    };

    this.register(resourceFactory());
    this.on('all:aggregated', wrappedFn);
    return () => this.removeListener('all:aggregated', wrappedFn);
  }

  close() {
    super.close();
    this.scopes.clear();
    this.removeAllListeners();
    return this;
  }

  reset() {
    this.close();
    this.subscribeAggregator = aggregate(events => this.emit('all:aggregated', events), (type, path) => `${type}:${path}`, this.options.interval);
    this.on('all', this.subscribeAggregator);
  }

}

exports.default = Watcher;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvaW5zdGFsbGVyL3dhdGNoZXIuanMiXSwibmFtZXMiOlsiYWdncmVnYXRlIiwiZm4iLCJjb21iaW5lciIsImlkZW50aXR5IiwiZGVsYXkiLCJjYWxscyIsIk1hcCIsInRpbWVySWQiLCJhcmdzIiwiY2xlYXJUaW1lb3V0Iiwic2V0VGltZW91dCIsInZhbHVlcyIsImNsZWFyIiwic2V0IiwiV2F0Y2hlciIsIkZTV2F0Y2hlciIsImNvbnN0cnVjdG9yIiwib3B0cyIsImlnbm9yZUluaXRpYWwiLCJwZXJzaXN0ZW50IiwicmVhZHkiLCJ2YWx1ZSIsIndyaXRhYmxlIiwic2l6ZSIsImdldCIsInNjb3BlcyIsInJlZHVjZSIsImFjYyIsInJlc2V0Iiwic2V0TWF4TGlzdGVuZXJzIiwib25jZSIsImdldFBhdGhzIiwicGF0aHMiLCJTZXQiLCJzY29wZVBhdGhzIiwicGF0aCIsImFkZCIsImdldFdhdGNoZWQiLCJPYmplY3QiLCJlbnRyaWVzIiwiYmFzZSIsImZpbGVzIiwiZm9yRWFjaCIsImZpbGUiLCJwdXNoIiwiUGF0aCIsImpvaW4iLCJhZGRVbndhdGNoZWQiLCJ3YXRjaGVkIiwiZmlsdGVyIiwiaGFzIiwic3RhcnQiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlZ2lzdGVyIiwicmVzb3VyY2UiLCJzY29wZUtleSIsIm9wdGlvbnMiLCJnZXREZWVwRGVwZW5kZW5jeVNldCIsInIiLCJpc05vcm1hbCIsIm9yaWdpbiIsInJjcGF0aCIsInN1YnNjcmliZSIsInJlc291cmNlRmFjdG9yeSIsIndyYXBwZWRGbiIsImV2ZW50cyIsIm1haW5SZXNvdXJjZSIsInBpY2tlZEV2ZW50cyIsInR5cGUiLCJ1bmNhY2hlIiwidW53YXRjaCIsInNhbWVBcyIsImRlcGVuZGVuY3lPZiIsImxlbmd0aCIsImVtaXQiLCJlcnIiLCJsaXN0ZW5lckNvdW50Iiwib24iLCJyZW1vdmVMaXN0ZW5lciIsImNsb3NlIiwicmVtb3ZlQWxsTGlzdGVuZXJzIiwi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LGdCQUFNbEUsRUFBRSxDQUFDbUUsWUFBRCxDQUFSO0FBQ0EsZUFBS2QsUUFBTCxDQUFjYSxZQUFkO0FBQ0EsZUFBS3BCLFlBQUw7QUFDQSxlQUFLNEIsSUFBTCxDQUFVLFFBQVYsRUFBb0JSLFlBQXBCO0FBQ0EsU0FORCxDQU1FLE9BQU9TLEdBQVAsRUFBWTtBQUNiLGNBQUksS0FBS0MsYUFBTCxDQUFtQixPQUFuQixDQUFKLEVBQWlDO0FBQ2hDLGlCQUFLRixJQUFMLENBQVUsT0FBVixFQUFtQkMsR0FBbkI7QUFDQSxXQUZELE1BRU87QUFDTixrQkFBTUEsR0FBTjtBQUNBO0FBQ0Q7QUFDRDtBQUNELEtBckNEOztBQXVDQSxTQUFLdEIsUUFBTCxDQUFjVSxlQUFlLEVBQTdCO0FBQ0EsU0FBS2MsRUFBTCxDQUFRLGdCQUFSLEVBQTBCYixTQUExQjtBQUVBLFdBQU8sTUFBTSxLQUFLYyxjQUFMLENBQW9CLGdCQUFwQixFQUFzQ2QsU0FBdEMsQ0FBYjtBQUNBOztBQUVEZSxFQUFBQSxLQUFLLEdBQUc7QUFDUCxVQUFNQSxLQUFOO0FBQ0EsU0FBS3ZELE1BQUwsQ0FBWWIsS0FBWjtBQUNBLFNBQUtxRSxrQkFBTDtBQUNBLFdBQU8sSUFBUDtBQUNBOztBQUVEckQsRUFBQUEsS0FBSyxHQUFHO0FBQ1AsU0FBS29ELEtBQUw7QUFDQSxTQUFLRSxtQkFBTCxHQUEyQmxGLFNBQVMsQ0FDbkNrRSxNQUFNLElBQUksS0FBS1MsSUFBTCxDQUFVLGdCQUFWLEVBQTRCVCxNQUE1QixDQUR5QixFQUVuQyxDQUFDRyxJQUFELEVBQU9sQyxJQUFQLEtBQWlCLEdBQUVrQyxJQUFLLElBQUdsQyxJQUFLLEVBRkcsRUFHbkMsS0FBS3NCLE9BQUwsQ0FBYTBCLFFBSHNCLENBQXBDO0FBS0EsU0FBS0wsRUFBTCxDQUFRLEtBQVIsRUFBZSxLQUFLSSxtQkFBcEI7QUFDQTs7QUE1STZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFBhdGggZnJvbSAncGF0aCc7XG5cbmltcG9ydCB7IEZTV2F0Y2hlciB9IGZyb20gJ2Nob2tpZGFyJztcblxuaW1wb3J0IGRlZmluZVByb3BlcnRpZXMgZnJvbSAnLi4vLi4vbGliL2hlbHBlcnMvZGVmaW5lUHJvcGVydGllcyc7XG5pbXBvcnQgaWRlbnRpdHkgZnJvbSAnLi4vLi4vbGliL2hlbHBlcnMvaWRlbnRpdHknO1xuXG5mdW5jdGlvbiBhZ2dyZWdhdGUoZm4sIGNvbWJpbmVyID0gaWRlbnRpdHksIGRlbGF5KSB7XG5cdGNvbnN0IGNhbGxzID0gbmV3IE1hcCgpO1xuXHRsZXQgdGltZXJJZDtcblx0cmV0dXJuICguLi5hcmdzKSA9PiB7XG5cdFx0Y2xlYXJUaW1lb3V0KHRpbWVySWQpO1xuXHRcdHRpbWVySWQgPSBzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdGZuKFsuLi5jYWxscy52YWx1ZXMoKV0pO1xuXHRcdFx0Y2FsbHMuY2xlYXIoKTtcblx0XHR9LCBkZWxheSk7XG5cdFx0Y2FsbHMuc2V0KGNvbWJpbmVyKC4uLmFyZ3MpLCBhcmdzKTtcblx0fTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgV2F0Y2hlciBleHRlbmRzIEZTV2F0Y2hlciB7XG5cdGNvbnN0cnVjdG9yKG9wdHMpIHtcblx0XHRzdXBlcih7XG5cdFx0XHRpZ25vcmVJbml0aWFsOiB0cnVlLFxuXHRcdFx0cGVyc2lzdGVudDogdHJ1ZSxcblx0XHRcdC4uLm9wdHNcblx0XHR9KTtcblxuXHRcdGRlZmluZVByb3BlcnRpZXModGhpcywge1xuXHRcdFx0cmVhZHk6IHtcblx0XHRcdFx0dmFsdWU6IGZhbHNlLFxuXHRcdFx0XHR3cml0YWJsZTogdHJ1ZVxuXHRcdFx0fSxcblx0XHRcdHNpemU6IHtcblx0XHRcdFx0Z2V0OiAoKSA9PiBbLi4udGhpcy5zY29wZXMudmFsdWVzKCldLnJlZHVjZSgoYWNjLCB7IHNpemUgfSkgPT4gYWNjICsgc2l6ZSwgMClcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdHRoaXMucmVzZXQoKTtcblx0XHR0aGlzLnNldE1heExpc3RlbmVycygxMDApO1xuXG5cdFx0dGhpcy5vbmNlKCdyZWFkeScsICgpID0+IHtcblx0XHRcdHRoaXMucmVhZHkgPSB0cnVlO1xuXHRcdH0pO1xuXHR9XG5cblx0c2NvcGVzID0gbmV3IE1hcCgpO1xuXG5cdGdldFBhdGhzKCkge1xuXHRcdGNvbnN0IHBhdGhzID0gbmV3IFNldCgpO1xuXHRcdGZvciAoY29uc3QgWywgc2NvcGVQYXRoc10gb2YgdGhpcy5zY29wZXMpIHtcblx0XHRcdGZvciAoY29uc3QgcGF0aCBvZiBzY29wZVBhdGhzKSB7XG5cdFx0XHRcdHBhdGhzLmFkZChwYXRoKTtcblx0XHRcdH1cblx0XHR9XG5cdFx0cmV0dXJuIHBhdGhzO1xuXHR9XG5cblx0Z2V0V2F0Y2hlZCgpIHtcblx0XHRyZXR1cm4gbmV3IFNldChcblx0XHRcdE9iamVjdC5lbnRyaWVzKHN1cGVyLmdldFdhdGNoZWQoKSkucmVkdWNlKChhY2MsIFtiYXNlLCBmaWxlc10pID0+IHtcblx0XHRcdFx0ZmlsZXMuZm9yRWFjaChmaWxlID0+IHtcblx0XHRcdFx0XHRhY2MucHVzaChQYXRoLmpvaW4oYmFzZSwgZmlsZSkpO1xuXHRcdFx0XHR9KTtcblx0XHRcdFx0cmV0dXJuIGFjYztcblx0XHRcdH0sIFtdKVxuXHRcdCk7XG5cdH1cblxuXHRhZGRVbndhdGNoZWQoKSB7XG5cdFx0Y29uc3Qgd2F0Y2hlZCA9IHRoaXMuZ2V0V2F0Y2hlZCgpO1xuXHRcdHRoaXMuYWRkKFsuLi50aGlzLmdldFBhdGhzKCldLmZpbHRlcihwYXRoID0+ICF3YXRjaGVkLmhhcyhwYXRoKSkpO1xuXHR9XG5cblx0c3RhcnQoKSB7XG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuXHRcdFx0dGhpcy5hZGRVbndhdGNoZWQoKTtcblx0XHRcdGlmICh0aGlzLnJlYWR5IHx8IHRoaXMuc2l6ZSA9PT0gMCkge1xuXHRcdFx0XHRyZXNvbHZlKHRoaXMpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy5vbmNlKCdyZWFkeScsICgpID0+IHJlc29sdmUodGhpcykpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0cmVnaXN0ZXIocmVzb3VyY2UpIHtcblx0XHRjb25zdCB7IHNjb3BlS2V5IH0gPSByZXNvdXJjZS5vcHRpb25zO1xuXHRcdGlmICghdGhpcy5zY29wZXMuaGFzKHNjb3BlS2V5KSkge1xuXHRcdFx0dGhpcy5zY29wZXMuc2V0KHNjb3BlS2V5LCBuZXcgU2V0KCkpO1xuXHRcdH1cblx0XHRjb25zdCBzY29wZVBhdGhzID0gdGhpcy5zY29wZXMuZ2V0KHNjb3BlS2V5KTtcblx0XHRbcmVzb3VyY2UsIC4uLnJlc291cmNlLmdldERlZXBEZXBlbmRlbmN5U2V0KHIgPT4gci5pc05vcm1hbCgpKV0uZm9yRWFjaChyID0+IHtcblx0XHRcdHNjb3BlUGF0aHMuYWRkKHIub3JpZ2luKTtcblx0XHR9KTtcblx0XHRpZiAocmVzb3VyY2Uub3B0aW9ucy5yY3BhdGgpIHtcblx0XHRcdHNjb3BlUGF0aHMuYWRkKHJlc291cmNlLm9wdGlvbnMucmNwYXRoKTtcblx0XHR9XG5cdH1cblxuXHRzdWJzY3JpYmUocmVzb3VyY2VGYWN0b3J5LCBmbikge1xuXHRcdGNvbnN0IHdyYXBwZWRGbiA9IGFzeW5jIGV2ZW50cyA9PiB7XG5cdFx0XHRsZXQgbWFpblJlc291cmNlID0gcmVzb3VyY2VGYWN0b3J5KCk7XG5cdFx0XHRjb25zdCBwaWNrZWRFdmVudHMgPSBbXTtcblx0XHRcdGZvciAoY29uc3QgW3R5cGUsIHBhdGhdIG9mIGV2ZW50cykge1xuXHRcdFx0XHRpZiAocGF0aCA9PT0gbWFpblJlc291cmNlLm9wdGlvbnMucmNwYXRoKSB7XG5cdFx0XHRcdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWF3YWl0LWluLWxvb3Bcblx0XHRcdFx0XHRhd2FpdCByZXNvdXJjZUZhY3RvcnkucmVzZXQoKTtcblx0XHRcdFx0XHRyZXNvdXJjZUZhY3RvcnkudW5jYWNoZSgpO1xuXHRcdFx0XHRcdG1haW5SZXNvdXJjZSA9IHJlc291cmNlRmFjdG9yeSgpO1xuXHRcdFx0XHRcdHBpY2tlZEV2ZW50cy5wdXNoKFt0eXBlLCBtYWluUmVzb3VyY2VdKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHQvLyB1bndhdGNoIGRlbGV0ZWQgcmVzb3VyY2VzXG5cdFx0XHRcdFx0aWYgKHR5cGUgPT09ICd1bmxpbmsnKSB7XG5cdFx0XHRcdFx0XHR0aGlzLnVud2F0Y2gocGF0aCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGNvbnN0IHJlc291cmNlID0gcmVzb3VyY2VGYWN0b3J5KHBhdGgpO1xuXHRcdFx0XHRcdGlmIChyZXNvdXJjZSAmJiAocmVzb3VyY2Uuc2FtZUFzKG1haW5SZXNvdXJjZSkgfHwgcmVzb3VyY2UuZGVwZW5kZW5jeU9mKG1haW5SZXNvdXJjZSkpKSB7XG5cdFx0XHRcdFx0XHRwaWNrZWRFdmVudHMucHVzaChbdHlwZSwgcmVzb3VyY2VdKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0aWYgKHBpY2tlZEV2ZW50cy5sZW5ndGgpIHtcblx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHR0aGlzLmVtaXQoJ2JlZm9yZXVwZGF0ZScsIG1haW5SZXNvdXJjZSk7XG5cdFx0XHRcdFx0YXdhaXQgZm4ocGlja2VkRXZlbnRzKTtcblx0XHRcdFx0XHR0aGlzLnJlZ2lzdGVyKG1haW5SZXNvdXJjZSk7XG5cdFx0XHRcdFx0dGhpcy5hZGRVbndhdGNoZWQoKTtcblx0XHRcdFx0XHR0aGlzLmVtaXQoJ3VwZGF0ZScsIG1haW5SZXNvdXJjZSk7XG5cdFx0XHRcdH0gY2F0Y2ggKGVycikge1xuXHRcdFx0XHRcdGlmICh0aGlzLmxpc3RlbmVyQ291bnQoJ2Vycm9yJykpIHtcblx0XHRcdFx0XHRcdHRoaXMuZW1pdCgnZXJyb3InLCBlcnIpO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHR0aHJvdyBlcnI7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fTtcblxuXHRcdHRoaXMucmVnaXN0ZXIocmVzb3VyY2VGYWN0b3J5KCkpO1xuXHRcdHRoaXMub24oJ2FsbDphZ2dyZWdhdGVkJywgd3JhcHBlZEZuKTtcblxuXHRcdHJldHVybiAoKSA9PiB0aGlzLnJlbW92ZUxpc3RlbmVyKCdhbGw6YWdncmVnYXRlZCcsIHdyYXBwZWRGbik7XG5cdH1cblxuXHRjbG9zZSgpIHtcblx0XHRzdXBlci5jbG9zZSgpO1xuXHRcdHRoaXMuc2NvcGVzLmNsZWFyKCk7XG5cdFx0dGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHJlc2V0KCkge1xuXHRcdHRoaXMuY2xvc2UoKTtcblx0XHR0aGlzLnN1YnNjcmliZUFnZ3JlZ2F0b3IgPSBhZ2dyZWdhdGUoXG5cdFx0XHRldmVudHMgPT4gdGhpcy5lbWl0KCdhbGw6YWdncmVnYXRlZCcsIGV2ZW50cyksXG5cdFx0XHQodHlwZSwgcGF0aCkgPT4gYCR7dHlwZX06JHtwYXRofWAsXG5cdFx0XHR0aGlzLm9wdGlvbnMuaW50ZXJ2YWxcblx0XHQpO1xuXHRcdHRoaXMub24oJ2FsbCcsIHRoaXMuc3Vic2NyaWJlQWdncmVnYXRvcik7XG5cdH1cbn1cbiJdfQ==