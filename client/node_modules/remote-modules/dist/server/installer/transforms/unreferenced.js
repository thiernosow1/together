"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var t = _interopRequireWildcard(require("@babel/types"));

var _generator = _interopRequireDefault(require("@babel/generator"));

var _traverse = _interopRequireDefault(require("@babel/traverse"));

var _codeFrame = require("@babel/code-frame");

var _helpers = require("../../../lib/helpers");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function containsReferences(path, nodes) {
  let result = false;
  const identifiers = nodes.filter(Boolean);

  if (path && identifiers.length) {
    path.traverse({
      Identifier(innerPath) {
        if (result) {
          innerPath.skip();
        } else if (identifiers.some(({
          name
        }) => name === innerPath.node.name)) {
          innerPath.stop();
          result = true;
        }
      }

    });
  }

  return result;
}

function generateRemovalFrame(path, reason) {
  const {
    code
  } = (0, _generator.default)(path.node);
  const lineCount = code.split('\n').length;
  const location = {
    start: {
      column: 1,
      line: lineCount
    },
    end: {
      column: 2,
      line: lineCount
    }
  };
  return (0, _codeFrame.codeFrameColumns)(code, location, {
    highlightCode: true,
    linesAbove: lineCount,
    message: `Removing ${reason} ${path.node.type}`
  });
}

var _default = (api, {
  logger,
  moduleId
}) => ({
  visitor: {
    Program: {
      exit() {
        _traverse.default.cache.clear();
      }

    },
    Scope: {
      exit(outerPath, state) {
        /**
         * Avoid clearing cache more than necessary.
         * minify-dead-code-elimination will have already done this.
         */
        if (!state.file.opts.plugins.some(({
          key
        }) => key === 'minify-dead-code-elimination')) {
          _traverse.default.cache.clear();
        }

        outerPath.scope.crawl();
        outerPath.traverse({
          ConditionalExpression: {
            exit(innerPath) {
              const {
                confident,
                value
              } = innerPath.get('test').evaluate();

              if (confident) {
                const {
                  consequent,
                  alternate
                } = innerPath.node;
                innerPath.replaceWith(value ? consequent : alternate);
                innerPath.scope.crawl();
              }
            }

          },
          IfStatement: {
            exit(innerPath) {
              let targetPath = innerPath;

              while (t.isIfStatement(targetPath)) {
                const testPath = targetPath.get('test');
                const {
                  confident,
                  value
                } = testPath.evaluate();

                if (confident) {
                  const lastTargetPath = targetPath;

                  if (value) {
                    if (targetPath.get('alternate')) {
                      targetPath.get('alternate').remove();
                    }

                    targetPath = targetPath.get('consequent');
                  } else {
                    targetPath.get('consequent').remove();
                    targetPath = targetPath.get('alternate');
                  }

                  lastTargetPath.scope.crawl();
                } else {
                  break;
                }
              }
            }

          },
          VariableDeclarator: {
            exit(innerPath) {
              if (!innerPath.node.init) {
                const binding = innerPath.scope.getBinding(innerPath.node.id.name);

                if (binding && binding.constant && !t.isLoop(innerPath.scope.block)) {
                  // eslint-disable-next-line no-param-reassign
                  innerPath.node.init = t.Identifier('undefined');
                }
              }
            }

          },

          ReferencedIdentifier(innerPath) {
            if (innerPath.scope.getBinding(innerPath.node.name)) {
              const {
                confident,
                value
              } = innerPath.evaluate();

              if (confident && (0, _helpers.isPrimitive)(value)) {
                let replacementNode;

                switch (true) {
                  case typeof value === 'string':
                    replacementNode = t.StringLiteral(value);
                    break;

                  case typeof value === 'number':
                    replacementNode = t.NumericLiteral(value);
                    break;

                  case typeof value === 'boolean':
                    replacementNode = t.BooleanLiteral(value);
                    break;

                  case value === null:
                  case value === undefined:
                    replacementNode = t.Identifier(String(value));
                    break;

                  default:
                    // noop
                    break;
                }

                if (replacementNode) {
                  innerPath.replaceWith(replacementNode);
                }
              }
            }
          }

        });

        (function removeUnreferenced() {
          const possiblyUnreferenced = new Map();
          Object.keys(outerPath.scope.references).forEach(key => {
            const binding = outerPath.scope.getBinding(key);

            if (binding && !binding.referenced && !possiblyUnreferenced.has(key)) {
              possiblyUnreferenced.set(key, binding.path);
            }
          });

          if (possiblyUnreferenced.size > 0) {
            outerPath.traverse({
              ImportDeclaration(innerPath) {
                const specifiers = innerPath.get('specifiers'); // Don't remove imports with no specifiers

                if (specifiers.length > 0) {
                  const referencedSpecifiers = specifiers.filter(specifierPath => !possiblyUnreferenced.has(specifierPath.node.local.name)); // Only remove the import if none of its specifiers are referenced

                  if (referencedSpecifiers.length === 0) {
                    possiblyUnreferenced.set(innerPath, innerPath);
                  }
                }
              },

              Identifier(innerPath) {
                if (possiblyUnreferenced.has(innerPath.node.name)) {
                  const declaratorPath = innerPath.findParent(p => p.isVariableDeclarator()); // Don't remove identifiers that are referenced in child scopes
                  // or have references to module or exports in the declarator path

                  if (!innerPath.scope.hasOwnBinding(innerPath.node.name) || containsReferences(declaratorPath, [outerPath.scope.globals.exports, outerPath.scope.globals.module])) {
                    possiblyUnreferenced.delete(innerPath.node.name);
                  }
                }
              },

              FunctionDeclaration(innerPath) {
                const {
                  name
                } = innerPath.node.id;

                if (possiblyUnreferenced.has(name)) {
                  // Don't remove identifiers that are referenced in child scopes
                  if (!innerPath.parentPath.scope.hasOwnBinding(name)) {
                    possiblyUnreferenced.delete(name);
                  } else {
                    // This path is going to be removed so we don't care about traversing any further
                    innerPath.skip();
                  }
                }
              }

            });
            possiblyUnreferenced.forEach(bindingPath => {
              logger.trace(`${moduleId}:\n\n${generateRemovalFrame(bindingPath, 'unreferenced')}\n`);
              bindingPath.remove();
            }); // If any references were removed, crawl the scope and traverse again

            if (possiblyUnreferenced.size > 0) {
              outerPath.scope.crawl();
              removeUnreferenced();
            }
          }
        })();
      }

    }
  }
});

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9zZXJ2ZXIvaW5zdGFsbGVyL3RyYW5zZm9ybXMvdW5yZWZlcmVuY2VkLmpzIl0sIm5hbWVzIjpbImNvbnRhaW5zUmVmZXJlbmNlcyIsInBhdGgiLCJub2RlcyIsInJlc3VsdCIsImlkZW50aWZpZXJzIiwiZmlsdGVyIiwiQm9vbGVhbiIsImxlbmd0aCIsInRyYXZlcnNlIiwiSWRlbnRpZmllciIsImlubmVyUGF0aCIsInNraXAiLCJzb21lIiwibmFtZSIsIm5vZGUiLCJzdG9wIiwiZ2VuZXJhdGVSZW1vdmFsRnJhbWUiLCJyZWFzb24iLCJjb2RlIiwibGluZUNvdW50Iiwic3BsaXQiLCJsb2NhdGlvbiIsInN0YXJ0IiwiY29sdW1uIiwibGluZSIsImVuZCIsImhpZ2hsaWdodENvZGUiLCJsaW5lc0Fib3ZlIiwibWVzc2FnZSIsInR5cGUiLCJhcGkiLCJsb2dnZXIiLCJtb2R1bGVJZCIsInZpc2l0b3IiLCJQcm9ncmFtIiwiZXhpdCIsImNhY2hlIiwiY2xlYXIiLCJTY29wZSIsIm91dGVyUGF0aCIsInN0YXRlIiwiZmlsZSIsIm9wdHMiLCJwbHVnaW5zIiwia2V5Iiwic2NvcGUiLCJjcmF3bCIsIkNvbmRpdGlvbmFsRXhwcmVzc2lvbiIsImNvbmZpZGVudCIsInZhbHVlIiwiZ2V0IiwiZXZhbHVhdGUiLCJjb25zZXF1ZW50IiwiYWx0ZXJuYXRlIiwicmVwbGFjZVdpdGgiLCJJZlN0YXRlbWVudCIsInRhcmdldFBhdGgiLCJ0IiwiaXNJZlN0YXRlbWVudCIsInRlc3RQYXRoIiwibGFzdFRhcmdldFBhdGgiLCJyZW1vdmUiLCJWYXJpYWJsZURlY2xhcmF0b3IiLCJpbml0IiwiYmluZGluZyIsImdldEJpbmRpbmciLCJpZCIsImNvbnN0YW50IiwiaXNMb29wIiwiYmxvY2siLCJSZWZlcmVuY2VkSWRlbnRpZmllciIsInJlcGxhY2VtZW50Tm9kZSIsIlN0cmluZ0xpdGVyYWwiLCJOdW1lcmljTGl0ZXJhbCIsIkJvb2xlYW5MaXRlcmFsIiwidW5kZWZpbmVkIiwiU3RyaW5nIiwicmVtb3ZlVW5yZWZlcmVuY2VkIiwicG9zc2libHlVbnJlZmVyZW5jZWQiLCJNYXAiLCJPYmplY3QiLCJrZXlzIiwicmVmZXJlbmNlcyIsImZvckVhY2giLCJyZWZlcmVuY2VkIiwiaGFzIiwic2V0Iiwic2l6ZSIsIkltcG9ydERlY2xhcmF0aW9uIiwic3BlY2lmaWVycyIsInJlZmVyZW5jZWRTcGVjaWZpZXJzIiwic3BlY2lmaWVyUGF0aCIsImxvY2FsIiwiZGVjbGFyYXRvclBhdGgiLCJmaW5kUGFyZW50IiwicCIsImlzVmFyaWFibGVEZWNsYXJhdG9yIiwiaGFzT3duQmluZGluZyIsImdsb2JhbHMiLCJleHBvcnRzIiwibW9kdWxlIiwiZGVsZXRlIiwiRnVuY3Rpb25EZWNsYXJhdGlvbiIsInBhcmVudFBhdGgiLCJiaW5kaW5nUGF0aCIsInRyYWNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7OztBQUVBLFNBQVNBLGtCQUFULENBQTRCQyxJQUE1QixFQUFrQ0MsS0FBbEMsRUFBeUM7QUFDeEMsTUFBSUMsTUFBTSxHQUFHLEtBQWI7QUFDQSxRQUFNQyxXQUFXLEdBQUdGLEtBQUssQ0FBQ0csTUFBTixDQUFhQyxPQUFiLENBQXBCOztBQUNBLE1BQUlMLElBQUksSUFBSUcsV0FBVyxDQUFDRyxNQUF4QixFQUFnQztBQUMvQk4sSUFBQUEsSUFBSSxDQUFDTyxRQUFMLENBQWM7QUFDYkMsTUFBQUEsVUFBVSxDQUFDQyxTQUFELEVBQVk7QUFDckIsWUFBSVAsTUFBSixFQUFZO0FBQ1hPLFVBQUFBLFNBQVMsQ0FBQ0MsSUFBVjtBQUNBLFNBRkQsTUFFTyxJQUFJUCxXQUFXLENBQUNRLElBQVosQ0FBaUIsQ0FBQztBQUFFQyxVQUFBQTtBQUFGLFNBQUQsS0FBY0EsSUFBSSxLQUFLSCxTQUFTLENBQUNJLElBQVYsQ0FBZUQsSUFBdkQsQ0FBSixFQUFrRTtBQUN4RUgsVUFBQUEsU0FBUyxDQUFDSyxJQUFWO0FBQ0Fa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QW9CLENBQUN1QixNQUFyQixDQUE0QnhGLElBQTVCO0FBQ0EsbUJBRkQsTUFFTztBQUNOO0FBQ0FILG9CQUFBQSxTQUFTLENBQUNDLElBQVY7QUFDQTtBQUNEO0FBQ0Q7O0FBekNpQixhQUFuQjtBQTRDQW1FLFlBQUFBLG9CQUFvQixDQUFDSyxPQUFyQixDQUE2QnFCLFdBQVcsSUFBSTtBQUMzQ3pFLGNBQUFBLE1BQU0sQ0FBQzBFLEtBQVAsQ0FDRSxHQUFFekUsUUFBUyxRQUFPaEIsb0JBQW9CLENBQUN3RixXQUFELEVBQWMsY0FBZCxDQUE4QixJQUR0RTtBQUdBQSxjQUFBQSxXQUFXLENBQUMzQyxNQUFaO0FBQ0EsYUFMRCxFQTdDa0MsQ0FvRGxDOztBQUNBLGdCQUFJaUIsb0JBQW9CLENBQUNTLElBQXJCLEdBQTRCLENBQWhDLEVBQW1DO0FBQ2xDaEQsY0FBQUEsU0FBUyxDQUFDTSxLQUFWLENBQWdCQyxLQUFoQjtBQUNBK0IsY0FBQUEsa0JBQWtCO0FBQ2xCO0FBQ0Q7QUFDRCxTQXBFRDtBQXFFQTs7QUE5Sks7QUFOQztBQURxQyxDQUFoQyxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgdCBmcm9tICdAYmFiZWwvdHlwZXMnO1xuaW1wb3J0IGdlbmVyYXRlIGZyb20gJ0BiYWJlbC9nZW5lcmF0b3InO1xuaW1wb3J0IHRyYXZlcnNlIGZyb20gJ0BiYWJlbC90cmF2ZXJzZSc7XG5pbXBvcnQgeyBjb2RlRnJhbWVDb2x1bW5zIH0gZnJvbSAnQGJhYmVsL2NvZGUtZnJhbWUnO1xuXG5pbXBvcnQgeyBpc1ByaW1pdGl2ZSB9IGZyb20gJy4uLy4uLy4uL2xpYi9oZWxwZXJzJztcblxuZnVuY3Rpb24gY29udGFpbnNSZWZlcmVuY2VzKHBhdGgsIG5vZGVzKSB7XG5cdGxldCByZXN1bHQgPSBmYWxzZTtcblx0Y29uc3QgaWRlbnRpZmllcnMgPSBub2Rlcy5maWx0ZXIoQm9vbGVhbik7XG5cdGlmIChwYXRoICYmIGlkZW50aWZpZXJzLmxlbmd0aCkge1xuXHRcdHBhdGgudHJhdmVyc2Uoe1xuXHRcdFx0SWRlbnRpZmllcihpbm5lclBhdGgpIHtcblx0XHRcdFx0aWYgKHJlc3VsdCkge1xuXHRcdFx0XHRcdGlubmVyUGF0aC5za2lwKCk7XG5cdFx0XHRcdH0gZWxzZSBpZiAoaWRlbnRpZmllcnMuc29tZSgoeyBuYW1lIH0pID0+IG5hbWUgPT09IGlubmVyUGF0aC5ub2RlLm5hbWUpKSB7XG5cdFx0XHRcdFx0aW5uZXJQYXRoLnN0b3AoKTtcblx0XHRcdFx0XHRyZXN1bHQgPSB0cnVlO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblx0cmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVSZW1vdmFsRnJhbWUocGF0aCwgcmVhc29uKSB7XG5cdGNvbnN0IHsgY29kZSB9ID0gZ2VuZXJhdGUocGF0aC5ub2RlKTtcblx0Y29uc3QgbGluZUNvdW50ID0gY29kZS5zcGxpdCgnXFxuJykubGVuZ3RoO1xuXHRjb25zdCBsb2NhdGlvbiA9IHtcblx0XHRzdGFydDogeyBjb2x1bW46IDEsIGxpbmU6IGxpbmVDb3VudCB9LFxuXHRcdGVuZDogeyBjb2x1bW46IDIsIGxpbmU6IGxpbmVDb3VudCB9XG5cdH07XG5cdHJldHVybiBjb2RlRnJhbWVDb2x1bW5zKGNvZGUsIGxvY2F0aW9uLCB7XG5cdFx0aGlnaGxpZ2h0Q29kZTogdHJ1ZSxcblx0XHRsaW5lc0Fib3ZlOiBsaW5lQ291bnQsXG5cdFx0bWVzc2FnZTogYFJlbW92aW5nICR7cmVhc29ufSAke3BhdGgubm9kZS50eXBlfWBcblx0fSk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IChhcGksIHsgbG9nZ2VyLCBtb2R1bGVJZCB9KSA9PiAoe1xuXHR2aXNpdG9yOiB7XG5cdFx0UHJvZ3JhbToge1xuXHRcdFx0ZXhpdCgpIHtcblx0XHRcdFx0dHJhdmVyc2UuY2FjaGUuY2xlYXIoKTtcblx0XHRcdH1cblx0XHR9LFxuXHRcdFNjb3BlOiB7XG5cdFx0XHRleGl0KG91dGVyUGF0aCwgc3RhdGUpIHtcblx0XHRcdFx0LyoqXG5cdFx0XHRcdCAqIEF2b2lkIGNsZWFyaW5nIGNhY2hlIG1vcmUgdGhhbiBuZWNlc3NhcnkuXG5cdFx0XHRcdCAqIG1pbmlmeS1kZWFkLWNvZGUtZWxpbWluYXRpb24gd2lsbCBoYXZlIGFscmVhZHkgZG9uZSB0aGlzLlxuXHRcdFx0XHQgKi9cblx0XHRcdFx0aWYgKCFzdGF0ZS5maWxlLm9wdHMucGx1Z2lucy5zb21lKCh7IGtleSB9KSA9PiBrZXkgPT09ICdtaW5pZnktZGVhZC1jb2RlLWVsaW1pbmF0aW9uJykpIHtcblx0XHRcdFx0XHR0cmF2ZXJzZS5jYWNoZS5jbGVhcigpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0b3V0ZXJQYXRoLnNjb3BlLmNyYXdsKCk7XG5cblx0XHRcdFx0b3V0ZXJQYXRoLnRyYXZlcnNlKHtcblx0XHRcdFx0XHRDb25kaXRpb25hbEV4cHJlc3Npb246IHtcblx0XHRcdFx0XHRcdGV4aXQoaW5uZXJQYXRoKSB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IHsgY29uZmlkZW50LCB2YWx1ZSB9ID0gaW5uZXJQYXRoLmdldCgndGVzdCcpLmV2YWx1YXRlKCk7XG5cdFx0XHRcdFx0XHRcdGlmIChjb25maWRlbnQpIHtcblx0XHRcdFx0XHRcdFx0XHRjb25zdCB7IGNvbnNlcXVlbnQsIGFsdGVybmF0ZSB9ID0gaW5uZXJQYXRoLm5vZGU7XG5cdFx0XHRcdFx0XHRcdFx0aW5uZXJQYXRoLnJlcGxhY2VXaXRoKHZhbHVlID8gY29uc2VxdWVudCA6IGFsdGVybmF0ZSk7XG5cdFx0XHRcdFx0XHRcdFx0aW5uZXJQYXRoLnNjb3BlLmNyYXdsKCk7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdElmU3RhdGVtZW50OiB7XG5cdFx0XHRcdFx0XHRleGl0KGlubmVyUGF0aCkge1xuXHRcdFx0XHRcdFx0XHRsZXQgdGFyZ2V0UGF0aCA9IGlubmVyUGF0aDtcblx0XHRcdFx0XHRcdFx0d2hpbGUgKHQuaXNJZlN0YXRlbWVudCh0YXJnZXRQYXRoKSkge1xuXHRcdFx0XHRcdFx0XHRcdGNvbnN0IHRlc3RQYXRoID0gdGFyZ2V0UGF0aC5nZXQoJ3Rlc3QnKTtcblx0XHRcdFx0XHRcdFx0XHRjb25zdCB7IGNvbmZpZGVudCwgdmFsdWUgfSA9IHRlc3RQYXRoLmV2YWx1YXRlKCk7XG5cdFx0XHRcdFx0XHRcdFx0aWYgKGNvbmZpZGVudCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0Y29uc3QgbGFzdFRhcmdldFBhdGggPSB0YXJnZXRQYXRoO1xuXHRcdFx0XHRcdFx0XHRcdFx0aWYgKHZhbHVlKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdGlmICh0YXJnZXRQYXRoLmdldCgnYWx0ZXJuYXRlJykpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHR0YXJnZXRQYXRoLmdldCgnYWx0ZXJuYXRlJykucmVtb3ZlKCk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRcdFx0dGFyZ2V0UGF0aCA9IHRhcmdldFBhdGguZ2V0KCdjb25zZXF1ZW50Jyk7XG5cdFx0XHRcdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHR0YXJnZXRQYXRoLmdldCgnY29uc2VxdWVudCcpLnJlbW92ZSgpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHR0YXJnZXRQYXRoID0gdGFyZ2V0UGF0aC5nZXQoJ2FsdGVybmF0ZScpO1xuXHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdFx0bGFzdFRhcmdldFBhdGguc2NvcGUuY3Jhd2woKTtcblx0XHRcdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRWYXJpYWJsZURlY2xhcmF0b3I6IHtcblx0XHRcdFx0XHRcdGV4aXQoaW5uZXJQYXRoKSB7XG5cdFx0XHRcdFx0XHRcdGlmICghaW5uZXJQYXRoLm5vZGUuaW5pdCkge1xuXHRcdFx0XHRcdFx0XHRcdGNvbnN0IGJpbmRpbmcgPSBpbm5lclBhdGguc2NvcGUuZ2V0QmluZGluZyhpbm5lclBhdGgubm9kZS5pZC5uYW1lKTtcblx0XHRcdFx0XHRcdFx0XHRpZiAoYmluZGluZyAmJiBiaW5kaW5nLmNvbnN0YW50ICYmICF0LmlzTG9vcChpbm5lclBhdGguc2NvcGUuYmxvY2spKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcGFyYW0tcmVhc3NpZ25cblx0XHRcdFx0XHRcdFx0XHRcdGlubmVyUGF0aC5ub2RlLmluaXQgPSB0LklkZW50aWZpZXIoJ3VuZGVmaW5lZCcpO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0UmVmZXJlbmNlZElkZW50aWZpZXIoaW5uZXJQYXRoKSB7XG5cdFx0XHRcdFx0XHRpZiAoaW5uZXJQYXRoLnNjb3BlLmdldEJpbmRpbmcoaW5uZXJQYXRoLm5vZGUubmFtZSkpIHtcblx0XHRcdFx0XHRcdFx0Y29uc3QgeyBjb25maWRlbnQsIHZhbHVlIH0gPSBpbm5lclBhdGguZXZhbHVhdGUoKTtcblx0XHRcdFx0XHRcdFx0aWYgKGNvbmZpZGVudCAmJiBpc1ByaW1pdGl2ZSh2YWx1ZSkpIHtcblx0XHRcdFx0XHRcdFx0XHRsZXQgcmVwbGFjZW1lbnROb2RlO1xuXHRcdFx0XHRcdFx0XHRcdHN3aXRjaCAodHJ1ZSkge1xuXHRcdFx0XHRcdFx0XHRcdFx0Y2FzZSB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnOlxuXHRcdFx0XHRcdFx0XHRcdFx0XHRyZXBsYWNlbWVudE5vZGUgPSB0LlN0cmluZ0xpdGVyYWwodmFsdWUpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRcdFx0XHRcdGNhc2UgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJzpcblx0XHRcdFx0XHRcdFx0XHRcdFx0cmVwbGFjZW1lbnROb2RlID0gdC5OdW1lcmljTGl0ZXJhbCh2YWx1ZSk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdFx0XHRcdFx0Y2FzZSB0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJzpcblx0XHRcdFx0XHRcdFx0XHRcdFx0cmVwbGFjZW1lbnROb2RlID0gdC5Cb29sZWFuTGl0ZXJhbCh2YWx1ZSk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdFx0XHRcdFx0Y2FzZSB2YWx1ZSA9PT0gbnVsbDpcblx0XHRcdFx0XHRcdFx0XHRcdGNhc2UgdmFsdWUgPT09IHVuZGVmaW5lZDpcblx0XHRcdFx0XHRcdFx0XHRcdFx0cmVwbGFjZW1lbnROb2RlID0gdC5JZGVudGlmaWVyKFN0cmluZyh2YWx1ZSkpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRcdFx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdFx0XHRcdFx0XHRcdC8vIG5vb3Bcblx0XHRcdFx0XHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdGlmIChyZXBsYWNlbWVudE5vZGUpIHtcblx0XHRcdFx0XHRcdFx0XHRcdGlubmVyUGF0aC5yZXBsYWNlV2l0aChyZXBsYWNlbWVudE5vZGUpO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cblx0XHRcdFx0KGZ1bmN0aW9uIHJlbW92ZVVucmVmZXJlbmNlZCgpIHtcblx0XHRcdFx0XHRjb25zdCBwb3NzaWJseVVucmVmZXJlbmNlZCA9IG5ldyBNYXAoKTtcblxuXHRcdFx0XHRcdE9iamVjdC5rZXlzKG91dGVyUGF0aC5zY29wZS5yZWZlcmVuY2VzKS5mb3JFYWNoKGtleSA9PiB7XG5cdFx0XHRcdFx0XHRjb25zdCBiaW5kaW5nID0gb3V0ZXJQYXRoLnNjb3BlLmdldEJpbmRpbmcoa2V5KTtcblx0XHRcdFx0XHRcdGlmIChiaW5kaW5nICYmICFiaW5kaW5nLnJlZmVyZW5jZWQgJiYgIXBvc3NpYmx5VW5yZWZlcmVuY2VkLmhhcyhrZXkpKSB7XG5cdFx0XHRcdFx0XHRcdHBvc3NpYmx5VW5yZWZlcmVuY2VkLnNldChrZXksIGJpbmRpbmcucGF0aCk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSk7XG5cblx0XHRcdFx0XHRpZiAocG9zc2libHlVbnJlZmVyZW5jZWQuc2l6ZSA+IDApIHtcblx0XHRcdFx0XHRcdG91dGVyUGF0aC50cmF2ZXJzZSh7XG5cdFx0XHRcdFx0XHRcdEltcG9ydERlY2xhcmF0aW9uKGlubmVyUGF0aCkge1xuXHRcdFx0XHRcdFx0XHRcdGNvbnN0IHNwZWNpZmllcnMgPSBpbm5lclBhdGguZ2V0KCdzcGVjaWZpZXJzJyk7XG5cdFx0XHRcdFx0XHRcdFx0Ly8gRG9uJ3QgcmVtb3ZlIGltcG9ydHMgd2l0aCBubyBzcGVjaWZpZXJzXG5cdFx0XHRcdFx0XHRcdFx0aWYgKHNwZWNpZmllcnMubGVuZ3RoID4gMCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0Y29uc3QgcmVmZXJlbmNlZFNwZWNpZmllcnMgPSBzcGVjaWZpZXJzLmZpbHRlcihcblx0XHRcdFx0XHRcdFx0XHRcdFx0c3BlY2lmaWVyUGF0aCA9PiAhcG9zc2libHlVbnJlZmVyZW5jZWQuaGFzKHNwZWNpZmllclBhdGgubm9kZS5sb2NhbC5uYW1lKVxuXHRcdFx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0XHRcdC8vIE9ubHkgcmVtb3ZlIHRoZSBpbXBvcnQgaWYgbm9uZSBvZiBpdHMgc3BlY2lmaWVycyBhcmUgcmVmZXJlbmNlZFxuXHRcdFx0XHRcdFx0XHRcdFx0aWYgKHJlZmVyZW5jZWRTcGVjaWZpZXJzLmxlbmd0aCA9PT0gMCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRwb3NzaWJseVVucmVmZXJlbmNlZC5zZXQoaW5uZXJQYXRoLCBpbm5lclBhdGgpO1xuXHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdFx0SWRlbnRpZmllcihpbm5lclBhdGgpIHtcblx0XHRcdFx0XHRcdFx0XHRpZiAocG9zc2libHlVbnJlZmVyZW5jZWQuaGFzKGlubmVyUGF0aC5ub2RlLm5hbWUpKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRjb25zdCBkZWNsYXJhdG9yUGF0aCA9IGlubmVyUGF0aC5maW5kUGFyZW50KHAgPT4gcC5pc1ZhcmlhYmxlRGVjbGFyYXRvcigpKTtcblx0XHRcdFx0XHRcdFx0XHRcdC8vIERvbid0IHJlbW92ZSBpZGVudGlmaWVycyB0aGF0IGFyZSByZWZlcmVuY2VkIGluIGNoaWxkIHNjb3Blc1xuXHRcdFx0XHRcdFx0XHRcdFx0Ly8gb3IgaGF2ZSByZWZlcmVuY2VzIHRvIG1vZHVsZSBvciBleHBvcnRzIGluIHRoZSBkZWNsYXJhdG9yIHBhdGhcblx0XHRcdFx0XHRcdFx0XHRcdGlmIChcblx0XHRcdFx0XHRcdFx0XHRcdFx0IWlubmVyUGF0aC5zY29wZS5oYXNPd25CaW5kaW5nKGlubmVyUGF0aC5ub2RlLm5hbWUpIHx8XG5cdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnRhaW5zUmVmZXJlbmNlcyhkZWNsYXJhdG9yUGF0aCwgW1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdG91dGVyUGF0aC5zY29wZS5nbG9iYWxzLmV4cG9ydHMsXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0b3V0ZXJQYXRoLnNjb3BlLmdsb2JhbHMubW9kdWxlXG5cdFx0XHRcdFx0XHRcdFx0XHRcdF0pXG5cdFx0XHRcdFx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0cG9zc2libHlVbnJlZmVyZW5jZWQuZGVsZXRlKGlubmVyUGF0aC5ub2RlLm5hbWUpO1xuXHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdFx0RnVuY3Rpb25EZWNsYXJhdGlvbihpbm5lclBhdGgpIHtcblx0XHRcdFx0XHRcdFx0XHRjb25zdCB7IG5hbWUgfSA9IGlubmVyUGF0aC5ub2RlLmlkO1xuXHRcdFx0XHRcdFx0XHRcdGlmIChwb3NzaWJseVVucmVmZXJlbmNlZC5oYXMobmFtZSkpIHtcblx0XHRcdFx0XHRcdFx0XHRcdC8vIERvbid0IHJlbW92ZSBpZGVudGlmaWVycyB0aGF0IGFyZSByZWZlcmVuY2VkIGluIGNoaWxkIHNjb3Blc1xuXHRcdFx0XHRcdFx0XHRcdFx0aWYgKCFpbm5lclBhdGgucGFyZW50UGF0aC5zY29wZS5oYXNPd25CaW5kaW5nKG5hbWUpKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdHBvc3NpYmx5VW5yZWZlcmVuY2VkLmRlbGV0ZShuYW1lKTtcblx0XHRcdFx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdC8vIFRoaXMgcGF0aCBpcyBnb2luZyB0byBiZSByZW1vdmVkIHNvIHdlIGRvbid0IGNhcmUgYWJvdXQgdHJhdmVyc2luZyBhbnkgZnVydGhlclxuXHRcdFx0XHRcdFx0XHRcdFx0XHRpbm5lclBhdGguc2tpcCgpO1xuXHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fSk7XG5cblx0XHRcdFx0XHRcdHBvc3NpYmx5VW5yZWZlcmVuY2VkLmZvckVhY2goYmluZGluZ1BhdGggPT4ge1xuXHRcdFx0XHRcdFx0XHRsb2dnZXIudHJhY2UoXG5cdFx0XHRcdFx0XHRcdFx0YCR7bW9kdWxlSWR9OlxcblxcbiR7Z2VuZXJhdGVSZW1vdmFsRnJhbWUoYmluZGluZ1BhdGgsICd1bnJlZmVyZW5jZWQnKX1cXG5gXG5cdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRcdGJpbmRpbmdQYXRoLnJlbW92ZSgpO1xuXHRcdFx0XHRcdFx0fSk7XG5cblx0XHRcdFx0XHRcdC8vIElmIGFueSByZWZlcmVuY2VzIHdlcmUgcmVtb3ZlZCwgY3Jhd2wgdGhlIHNjb3BlIGFuZCB0cmF2ZXJzZSBhZ2FpblxuXHRcdFx0XHRcdFx0aWYgKHBvc3NpYmx5VW5yZWZlcmVuY2VkLnNpemUgPiAwKSB7XG5cdFx0XHRcdFx0XHRcdG91dGVyUGF0aC5zY29wZS5jcmF3bCgpO1xuXHRcdFx0XHRcdFx0XHRyZW1vdmVVbnJlZmVyZW5jZWQoKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pKCk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG59KTtcbiJdfQ==