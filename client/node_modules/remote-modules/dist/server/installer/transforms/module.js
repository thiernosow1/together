"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var t = _interopRequireWildcard(require("@babel/types"));

var _template = _interopRequireDefault(require("@babel/template"));

var _generator = _interopRequireDefault(require("@babel/generator"));

var _codeFrame = require("@babel/code-frame");

var _resourceRequest = _interopRequireDefault(require("../generators/resource-request"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

const moduleNotFoundTemplate = (0, _template.default)(`
	MODULE._throwNotFound(REQUEST);
`);

function isRequireResolve(path) {
  return path.isCallExpression() && path.get('callee.property').isIdentifier({
    name: 'resolve'
  }) && path.get('callee.object').isIdentifier({
    name: 'require'
  });
}

function isRequire(path) {
  return path.node.callee.name === 'require' && !isRequireResolve(path.get('arguments.0'));
}

var _default = (api, {
  logger,
  resource
}) => {
  const moduleIdentifier = t.Identifier('module');
  const requireIdentifier = t.Identifier('$require');
  const importIdentifier = t.MemberExpression(moduleIdentifier, t.Identifier('import'));

  const buildQuery = (...args) => resource.adapter.parser.buildQuery(...args);

  function printRequestWarning(path) {
    const program = path.scope.getProgramParent();
    const {
      code
    } = (0, _generator.default)(program.block, {
      retainLines: true
    });
    const location = path.node.loc;
    const frame = (0, _codeFrame.codeFrameColumns)(code, location, {
      message: 'Cannot statically determine request value',
      highlightCode: true
    });
    logger.warn(`${resource.moduleId}:\n\n${frame}\n`);
  }

  function replaceDefault(path, request) {
    const ctx = resource.contextFactory(request, resource.getResolverPaths());

    switch (true) {
      case Boolean(ctx.error):
        path.replaceWith(moduleNotFoundTemplate({
          MODULE: moduleIdentifier,
          REQUEST: request.node
        }));
        break;

      case ctx.isExternal():
        path.replaceWith(t.CallExpression(requireIdentifier, [t.StringLiteral(ctx.moduleId)]));
        break;

      case ctx.isNull():
        {
          const declaratorPath = path.findParent(p => p.isVariableDeclarator());
          const targetPath = declaratorPath ? declaratorPath.get('init') : path;
          targetPath.replaceWith(t.Identifier('null'));
          targetPath.addComment('leading', request.value);
          break;
        }

      default:
        path.replaceWith(t.CallExpression(requireIdentifier, [t.NumericLiteral(ctx.pid)]));
        path.addComment('leading', request.value);
        break;
    }
  }

  function replaceRequest(path) {
    const request = (0, _resourceRequest.default)(path.node, buildQuery);

    switch (true) {
      case isRequireResolve(path):
        if (request.dynamic) {
          path.replaceWith(t.CallExpression(t.MemberExpression(moduleIdentifier, t.Identifier('resolveDynamic')), [request.node]));
        } else {
          const ctx = resource.contextFactory(request, resource.getResolverPaths());

          if (ctx.isNull()) {
            path.replaceWith(moduleNotFoundTemplate({
              MODULE: moduleIdentifier,
              REQUEST: request.node
            }));
          } else {
            path.replaceWith(t.StringLiteral(ctx.moduleId));
          }
        }

        break;

      case request.async:
        if (request.dynamic) {
          path.replaceWith(t.CallExpression(importIdentifier, [t.CallExpression(t.MemberExpression(moduleIdentifier, t.Identifier('resolveDynamic')), [request.node])]));
        } else {
          const ctx = resource.contextFactory(request, resource.getResolverPaths());
          path.replaceWith(t.CallExpression(importIdentifier, [t.StringLiteral(ctx.moduleId)]));
        }

        break;

      case request.href:
        {
          if (request.dynamic) {
            printRequestWarning(path);
            path.replaceWith(t.CallExpression(t.MemberExpression(moduleIdentifier, t.Identifier('resolveURL')), [t.CallExpression(t.MemberExpression(moduleIdentifier, t.Identifier('resolveDynamic')), [request.node])]));
          } else {
            const ctx = resource.contextFactory(request, resource.getResolverPaths());
            path.replaceWith(t.StringLiteral(ctx.url));
          }

          break;
        }

      case request.dynamic:
        printRequestWarning(path);
        path.replaceWith(t.CallExpression(requireIdentifier, [t.CallExpression(t.MemberExpression(moduleIdentifier, t.Identifier('resolveDynamic')), [request.node])]));
        break;

      default:
        replaceDefault(path, request);
        break;
    }
  }

  return {
    visitor: {
      MemberExpression(path) {
        const {
          object,
          property
        } = path.node;

        if (object.name === 'System' && property.name === 'import') {
          // FIXME: Move this to a CallExpression visitor?
          replaceRequest(path.parentPath);
        } else if (object.name === 'require' && property.name === 'cache') {
          // FIXME: Move this to an Identifier visitor?
          const registryIdentifier = t.MemberExpression(moduleIdentifier, t.Identifier('registry'));

          if (t.isMemberExpression(path.parent)) {
            path.parentPath.replaceWith(t.CallExpression(t.MemberExpression(registryIdentifier, t.Identifier('get')), [path.parent.property]));
          } else {
            path.replaceWith(registryIdentifier);
          }
        }
      },

      CallExpression(path) {
        if (t.isImport(path.node.callee) || isRequire(path) || isRequireResolve(path)) {
          replaceRequest(path);
        }
      }

    }
  };
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9zZXJ2ZXIvaW5zdGFsbGVyL3RyYW5zZm9ybXMvbW9kdWxlLmpzIl0sIm5hbWVzIjpbIm1vZHVsZU5vdEZvdW5kVGVtcGxhdGUiLCJpc1JlcXVpcmVSZXNvbHZlIiwicGF0aCIsImlzQ2FsbEV4cHJlc3Npb24iLCJnZXQiLCJpc0lkZW50aWZpZXIiLCJuYW1lIiwiaXNSZXF1aXJlIiwibm9kZSIsImNhbGxlZSIsImFwaSIsImxvZ2dlciIsInJlc291cmNlIiwibW9kdWxlSWRlbnRpZmllciIsInQiLCJJZGVudGlmaWVyIiwicmVxdWlyZUlkZW50aWZpZXIiLCJpbXBvcnRJZGVudGlmaWVyIiwiTWVtYmVyRXhwcmVzc2lvbiIsImJ1aWxkUXVlcnkiLCJhcmdzIiwiYWRhcHRlciIsInBhcnNlciIsInByaW50UmVxdWVzdFdhcm5pbmciLCJwcm9ncmFtIiwic2NvcGUiLCJnZXRQcm9ncmFtUGFyZW50IiwiY29kZSIsImJsb2NrIiwicmV0YWluTGluZXMiLCJsb2NhdGlvbiIsImxvYyIsImZyYW1lIiwibWVzc2FnZSIsImhpZ2hsaWdodENvZGUiLCJ3YXJuIiwibW9kdWxlSWQiLCJyZXBsYWNlRGVmYXVsdCIsInJlcXVlc3QiLCJjdHgiLCJjb250ZXh0RmFjdG9yeSIsImdldFJlc29sdmVyUGF0aHMiLCJCb29sZWFuIiwiZXJyb3IiLCJyZXBsYWNlV2l0aCIsIk1PRFVMRSIsIlJFUVVFU1QiLCJpc0V4dGVybmFsIiwiQ2FsbEV4cHJlc3Npb24iLCJTdHJpbmdMaXRlcmFsIiwiaXNOdWxsIiwiZGVjbGFyYXRvclBhdGgiLCJmaW5kUGFyZW50IiwicCIsImlzVmFyaWFibGVEZWNsYXJhdG9yIiwidGFyZ2V0UGF0aCIsImFkZENvbW1lbnQiLCJ2YWx1ZSIsIk51bWVyaWNMaXRlcmFsIiwicGlkIiwicmVwbGFjZVJlcXVlc3QiLCJkeW5hbWljIiwiYXN5bmMiLCJocmVmIiwidXJsIiwidmlzaXRvciIsIm9iamVjdCIsInByb3BlcnR5IiwicGFyZW50UGF0aCIsInJlZ2lzdHJ5SWRlbnRpZmllciIsImlzTWVtYmVyRXhwcmVzc2lvbiIsInBhcmVudCIsImlzSW1wb3J0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7OztBQUVBLE1BQU1BLHNCQUFzQixHQUFHLHVCQUFVOztDQUFWLENBQS9COztBQUlBLFNBQVNDLGdCQUFULENBQTBCQyxJQUExQixFQUFnQztBQUMvQixTQUNDQSxJQUFJLENBQUNDLGdCQUFMLE1BQ0FELElBQUksQ0FBQ0UsR0FBTCxDQUFTLGlCQUFULEVBQTRCQyxZQUE1QixDQUF5QztBQUFFQyxJQUFBQSxJQUFJLEVBQUU7QUFBUixHQUF6QyxDQURBLElBRUFKLElBQUksQ0FBQ0UsR0FBTCxDQUFTLGVBQVQsRUFBMEJDLFlBQTFCLENBQXVDO0FBQUVDLElBQUFBLElBQUksRUFBRTtBQUFSLEdBQXZDLENBSEQ7QUFLQTs7QUFFRCxTQUFTQyxTQUFULENBQW1CTCxJQUFuQixFQUF5QjtBQUN4QixTQUFPQSxJQUFJLENBQUNNLElBQUwsQ0FBVUMsTUFBVixDQUFpQkgsSUFBakIsS0FBMEIsU0FBMUIsSUFBdUMsQ0FBQ0wsZ0JBQWdCLENBQUNDLElBQUksQ0FBQ0UsR0FBTCxDQUFTLGFBQVQsQ0FBRCxDQUEvRDtBQUNBOztlQUVjLENBQUNNLEdBQUQsRUFBTTtBQUFFQyxFQUFBQSxNQUFGO0FBQVVDLEVBQUFBO0FBQVYsQ0FBTixLQUErQjtBQUM3QyxRQUFNQyxnQkFBZ0IsR0FBR0MsQ0FBQyxDQUFDQyxVQUFGLENBQWEsUUFBYixDQUF6QjtBQUNBLFFBQU1DLGlCQUFpQixHQUFHRixDQUFDLENBQUNDLFVBQUYsQ0FBYSxVQUFiLENBQTFCO0FBQ0EsUUFBTUUsZ0JBQWdCLEdBQUdILENBQUMsQ0FBQ0ksZ0JBQUYsQ0FBbUJMLGdCQUFuQixFQUFxQ0MsQ0FBQyxDQUFDQyxVQUFGLENBQWEsUUFBYixDQUFyQyxDQUF6Qjs7QUFDQSxRQUFNSSxVQUFVLEdBQUcsQ0FBQyxHQUFHQyxJQUFKLEtBQWFSLFFBQVEsQ0FBQ1MsT0FBVCxDQUFpQkMsTUFBakIsQ0FBd0JILFVBQXhCLENBQW1DLEdBQUdDLElBQXRDLENBQWhDOztBQUVBLFdBQVNHLG1CQUFULENBQTZCckIsSUFBN0IsRUFBbUM7QUFDbEMsVUFBTXNCLE9BQU8sR0FBR3RCLElBQUksQ0FBQ3VCLEtBQUwsQ0FBV0MsZ0JBQVgsRUFBaEI7QUFDQSxVQUFNO0FBQUVDLE1BQUFBO0FBQUYsUUFBVyx3QkFBU0gsT0FBTyxDQUFDSSxLQUFqQixFQUF3QjtBQUFFQyxNQUFBQSxXQUFXLEVBQUU7QUFBZixLQUF4QixDQUFqQjtBQUNBLFVBQU1DLFFBQVEsR0FBRzVCLElBQUksQ0FBQ00sSUFBTCxDQUFVdUIsR0FBM0I7QUFDQSxVQUFNQyxLQUFLLEdBQUcsaUNBQWlCTCxJQUFqQixFQUF1QkcsUUFBdkIsRUFBaUM7QUFDOUNHLE1BQUFBLE9BQU8sRUFBRSwyQ0FEcUM7QUFFOUNDLE1BQUFBLGFBQWEsRUFBRTtBQUYrQixLQUFqQyxDQUFkO0FBSUF2QixJQUFBQSxNQUFNLENBQUN3QixJQUFQLENBQWEsR0FBRXZCLFFBQVEsQ0FBQ3dCLFFBQVMsUUFBT0osS0FBTSxJQUE5QztBQUNBOztBQUVELFdBQVNLLGNBQVQsQ0FBd0JuQyxJQUF4QixFQUE4Qm9DLE9BQTlCLEVBQXVDO0FBQ3RDLFVBQU1DLEdBQUcsR0FBRzNCLFFBQVEsQ0FBQzRCLGNBQVQsQ0FBd0JGLE9BQXhCLEVBQWlDMUIsUUFBUSxDQUFDNkIsZ0JBQVQsRUFBakMsQ0FBWjs7QUFDQSxZQUFRLElBQVI7QUFDQyxXQUFLQyxPQUFPLENBQUNILEdBQUcsQ0FBQ0ksS0FBTCxDQUFaO0FBQ0N6QyxRQUFBQSxJQUFJLENBQUMwQyxXQUFMLENBQ0M1QyxzQkFBc0IsQ0FBQztBQUN0QjZDLFVBQUFBLE1BQU0sRUFBRWhDLGdCQURjO0FBRXRCaUMsVUFBQUEsT0FBTyxFQUFFUixPQUFPLENBQUM5QjtBQUZLLFNBQUQsQ0FEdkI7QUFNQTs7QUFDRCxXQUFLK0IsR0FBRyxDQUFDUSxVQUFKLEVBQUw7QUFDQzdDLFFBQUFBLElBQUksQ0FBQzBDLFdBQUwsQ0FBaUI5QixDQUFDLENBQUNrQyxjQUFGLENBQWlCaEMsaUJBQWpCLEVBQW9DLENBQUNGLENBQUMsQ0FBQ21DLGFBQUYsQ0FBZ0JWLEdBQUcsQ0FBQ0gsUUFBcEIsQ0FBRCxDQUFwQyxDQUFqQjtBQUNBOztBQUNELFdBQUtHLEdBQUcsQ0FBQ1csTUFBSixFQUFMO0FBQW1CO0FBQ2xCLGdCQUFNQyxjQUFjLEdBQUdqRCxJQUFJLENBQUNrRCxVQUFMLENBQWdCQyxDQUFDLElBQUlBLENBQUMsQ0FBQ0Msb0JBQUYsRUFBckIsQ0FBdkI7QUFDQSxnQkFBTUMsVUFBVSxHQUFHSixjQUFjLEdBQUdBLGNBQWMsQ0FBQy9DLEdBQWYsQ0FBbUIsTUFBbkIsQ0FBSCxHQUFnQ0YsSUFBakU7QUFDQXFELFVBQUFBLFVBQVUsQ0FBQ1gsV0FBWCxDQUF1QjlCLENBQUMsQ0FBQ0MsVUFBRixDQUFhLE1BQWIsQ0FBdkI7QUFDQXdDLFVBQUFBLFVBQVUsQ0FBQ0MsVUFBWCxDQUFzQixTQUF0QixFQUFpQ2xCLE9BQU8sQ0FBQ21CLEtBQXpDO0FBQ0E7QUFDQTs7QUFDRDtBQUNDdkQsUUFBQUEsSUFBSSxDQUFDMEMsV0FBTCxDQUFpQjlCLENBQUMsQ0FBQ2tDLGNBQUYsQ0FBaUJoQyxpQkFBakIsRUFBb0MsQ0FBQ0YsQ0FBQyxDQUFDNEMsY0FBRixDQUFpQm5CLEdBQUcsQ0FBQ29CLEdBQXJCLENBQUQsQ0FBcEMsQ0FBakI7QUFDQXpELFFBQUFBLElBQUksQ0FBQ3NELFVBQUwsQ0FBZ0IsU0FBaEIsRUFBMkJsQixPQUFPLENBQUNtQixLQUFuQztBQUNBO0FBdEJGO0FBd0JBOztBQUVELFdBQVNHLGNBQVQsQ0FBd0IxRCxJQUF4QixFQUE4QjtBQUM3QixVQUFNb0MsT0FBTyxHQUFHLDhCQUF3QnBDLElBQUksQ0FBQ00sSUFBN0IsRUFBbUNXLFVBQW5DLENBQWhCOztBQUNBLFlBQVEsSUFBUjtBQUNDLFdBQUtsQixnQkFBZ0IsQ0FBQ0MsSUFBRCxDQUFyQjtBQUNDLFlBQUlvQyxPQUFPLENBQUN1QixPQUFaLEVBQXFCO0FBQ3BCM0QsVUFBQUEsSUFBSSxDQUFDMEMsV0FBTCxDQUNDOUIsQ0FBQyxDQUFDa0MsY0FBRixDQUFpQmxDLENBQUMsQ0FBQ0ksZ0JBQUYsQ0FBbUJMLGdCQUFuQixFQUFxQ0MsQ0FBQyxDQUFDQyxVQUFGLENBQWEsZ0JBQWIsQ0FBckMsQ0FBakIsRUFBdUYsQ0FDdEZ1QixPQUFPLENBQUM5QixJQUQ4RSxDQUF2RixDQUREO0FBS0EsU0FORCxNQU1PO0FBQ04sZ0JBQU0rQixHQUFHLEdBQUczQixRQUFRLENBQUM0QixjQUFULENBQXdCRixPQUF4QixFQUFpQzFCLFFBQVEsQ0FBQzZCLGdCQUFULEVBQWpDLENBQVo7O0FBQ0EsY0FBSUYsR0FBRyxDQUFDVyxNQUFKLEVBQUosRUFBa0I7QUFDakJoRCxZQUFBQSxJQUFJLENBQUMwQyxXQUFMLENBQ0M1QyxzQkFBc0IsQ0FBQztBQUN0QjZDLGNBQUFBLE1BQU0sRUFBRWhDLGdCQURjO0FBRXRCaUMsY0FBQUEsT0FBTyxFQUFFUixPQUFPLENBQUM5QjtBQUZLLGFBQUQsQ0FEdkI7QUFNQSxXQVBELE1BT087QUFDTk4sWUFBQUEsSUFBSSxDQUFDMEMsV0FBTCxDQUFpQjlCLENBQUMsQ0FBQ21DLGFBQUYsQ0FBZ0JWLEdBQUcsQ0FBQ0gsUUFBcEIsQ0FBakI7QUFDQTtBQUNEOztBQUNEOztBQUNELFdBQUtFLE9BQU8sQ0FBQ3dCLEtBQWI7QUFDQyxZQUFJeEIsT0FBTyxDQUFDdUIsT0FBWixFQUFxQjtBQUNwQjNELFVBQUFBLElBQUksQ0FBQzBDLFdBQUwsQ0FDQzlCLENBQUMsQ0FBQ2tDLGNBQUYsQ0FBaUIvQixnQkFBakIsRUFBbUMsQ0FDbENILENBQUMsQ0FBQ2tDLGNBQUYsQ0FDQ2xDLENBQUMsQ0FBQ0ksZ0JBQUYsQ0FBbUJMLGdCQUFuQixFQUFxQ0MsQ0FBQyxDQUFDQyxVQUFGLENBQWEsZ0JBQWIsQ0FBckMsQ0FERCxFQUVDLENBQUN1QixPQUFPLENBQUM5QixJQUFULENBRkQsQ0FEa0MsQ0FBbkMsQ0FERDtBQVFBLFNBVEQsTUFTTztBQUNOLGdCQUFNK0IsR0FBRyxHQUFHM0IsUUFBUSxDQUFDNEIsY0FBVCxDQUF3QkYsT0FBeEIsRUFBaUMxQixRQUFRLENBQUM2QixnQkFBVCxFQUFqQyxDQUFaO0FBQ0F2QyxVQUFBQSxJQUFJLENBQUMwQyxXQUFMLENBQWlCOUIsQ0FBQyxDQUFDa0MsY0FBRixDQUFpQi9CLGdCQUFqQixFQUFtQyxDQUFDSCxDQUFDLENBQUNtQyxhQUFGLENBQWdCVixHQUFHLENBQUNILFFBQXBCLENBQUQsQ0FBbkMsQ0FBakI7QUFDQTs7QUFDRDs7QUFDRCxXQUFLRSxPQUFPLENBQUN5QixJQUFiO0FBQW1CO0FBQ2xCLGNBQUl6QixPQUFPLENBQUN1QixPQUFaLEVBQXFCO0FBQ3BCdEMsWUFBQUEsbUJBQW1CLENBQUNyQixJQUFELENBQW5CO0FBQ0FBLFlBQUFBLElBQUksQ0FBQzBDLFdBQUwsQ0FDQzlCLENBQUMsQ0FBQ2tDLGNBQUYsQ0FBaUJsQyxDQUFDLENBQUNJLGdCQUFGLENBQW1CTCxnQkFBbkIsRUFBcUNDLENBQUMsQ0FBQ0MsVUFBRixDQUFhLFlBQWIsQ0FBckMsQ0FBakIsRUFBbUYsQ0FDbEZELENBQUMsQ0FBQ2tDLGNBQUYsQ0FDQ2xDLENBQUMsQ0FBQ0ksZ0JBQUYsQ0FBbUJMLGdCQUFuQixFQUFxQ0MsQ0FBQyxDQUFDQyxVQUFGLENBQWEsZ0JBQWIsQ0FBckMsQ0FERCxFQUVDLENBQUN1QixPQUFPLENBQUM5QixJQUFULENBRkQsQ0FEa0YsQ0FBbkYsQ0FERDtBQVFBLFdBVkQsTUFVTztBQUNOLGtCQUFNK0IsR0FBRyxHQUFHM0IsUUFBUSxDQUFDNEIsY0FBVCxDQUF3QkYsT0FBeEIsRUFBaUMxQixRQUFRLENBQUM2QixnQkFBVCxFQUFqQyxDQUFaO0FBQ0F2QyxZQUFBQSxJQUFJLENBQUMwQyxXQUFMLENBQWlCOUIsQ0FBQyxDQUFDbUMsYUFBRixDQUFnQlYsR0FBRyxDQUFDeUIsR0FBcEIsQ0FBakI7QUFDQTs7QUFDRDtBQUNBOztBQUNELFdBQUsxQixPQUFPLENBQUN1QixPQUFiO0FBQ0N0QyxRQUFBQSxtQkFBbUIsQ0FBQ3JCLElBQUQsQ0FBbkI7QUFDQUEsUUFBQUEsSUFBSSxDQUFDMEMsV0FBTCxDQUNDOUIsQ0FBQyxDQUFDa0MsY0FBRixDQUFpQmhDLGlCQUFqQixFQUFvQyxDQUNuQ0YsQ0FBQyxDQUFDa0MsY0FBRixDQUFpQmxDLENBQUMsQ0FBQ0ksZ0JBQUYsQ0FBbUJMLGdCQUFuQixFQUFxQ0MsQ0FBQyxDQUFDQyxVQUFGLENBQWEsZ0JBQWIsQ0FBckMsQ0FBakIsRUFBdUYsQ0FDdEZ1QixPQUFPLENBQUM5QixJQUQ4RSxDQUF2RixDQURtQyxDQUFwQyxDQUREO0FBT0E7O0FBQ0Q7QUFDQzZCLFFBQUFBLGNBQWMsQ0FBQ25DLElBQUQsRUFBT29DLE9BQVAsQ0FBZDtBQUNBO0FBbEVGO0FBb0VBOztBQUVELFNBQU87QUFDTjJCLElBQUFBLE9BQU8sRUFBRTtBQUNSL0MsTUFBQUEsZ0JBQWdCLENBQUNoQixJQUFELEVBQU87QUFDdEIsY0FBTTtBQUFFZ0UsVUFBQUEsTUFBRjtBQUFVQyxVQUFBQTtBQUFWLFlBQXVCakUsSUFBSSxDQUFDTSxJQUFsQzs7QUFDQSxZQUFJMEQsTUFBTSxDQUFDNUQsSUFBUCxLQUFnQixRQUFoQixJQUE0QjZELFFBQVEsQ0FBQzdELElBQVQsS0FBa0IsUUFBbEQsRUFBNEQ7QUFDM0Q7QUFDQXNELFVBQUFBLGNBQWMsQ0FBQzFELElBQUksQ0FBQ2tFLFVBQU4sQ0FBZDtBQUNBLFNBSEQsTUFHTyxJQUFJRixNQUFNLENBQUM1RCxJQUFQLEtBQWdCLFNBQWhCLElBQTZCNkQsUUFBUSxDQUFDN0QsSUFBVCxLQUFrQixPQUFuRCxFQUE0RDtBQUNsRTtBQUNBLGdCQUFNK0Qsa0JBQWtCLEdBQUd2RCxDQUFDLENBQUNJLGdCQUFGLENBQW1CTCxnQkFBbkIsRUFBcUNDLENBQUMsQ0FBQ0MsVUFBRixDQUFhLFVBQWIsQ0FBckMsQ0FBM0I7O0FBQ0EsY0FBSUQsQ0FBQyxDQUFDd0Qsa0JBQUYsQ0FBcUJwRSxJQUFJLENBQUNxRSxNQUExQixDQUFKLEVBQXVDO0FBQ3RDckUsWUFBQUEsSUFBSSxDQUFDa0UsVUFBTCxDQUFnQnhCLFdBQWhCLENBQ0M5QixDQUFDLENBQUNrQyxjQUFGLENBQWlCbEMsQ0FBQyxDQUFDSSxnQkFBRixDQUFtQm1ELGtCQUFuQixFQUF1Q3ZELENBQUMsQ0FBQ0MsVUFBRixDQUFhLEtBQWIsQ0FBdkMsQ0FBakIsRUFBOEUsQ0FDN0ViLElBQUksQ0FBQ3FFLE1BQUwsQ0FBWUosUUFEaUUsQ0FBOUUsQ0FERDtBQUtBLFdBTkQsTUFNTztBQUNOakUsWUFBQUEsSUFBSSxDQUFDMEMsV0FBTCxDQUFpQnlCLGtCQUFqQjtBQUNBO0FBQ0Q7QUFDRCxPQW5CTzs7QUFvQlJyQixNQUFBQSxjQUFjLENBQUM5QyxJQUFELEVBQU87QUFDcEIsWUFBSVksQ0FBQyxDQUFDMEQsUUFBRixDQUFXdEUsSUFBSSxDQUFDTSxJQUFMLENBQVVDLE1BQXJCLEtBQWdDRixTQUFTLENBQUNMLElBQUQsQ0FBekMsSUFBbURELGdCQUFnQixDQUFDQyxJQUFELENBQXZFLEVBQStFO0FBQzlFMEQsVUFBQUEsY0FBYyxDQUFDMUQsSUFBRCxDQUFkO0FBQ0E7QUFDRDs7QUF4Qk87QUFESCxHQUFQO0FBNEJBLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB0IGZyb20gJ0BiYWJlbC90eXBlcyc7XG5pbXBvcnQgVGVtcGxhdGUgZnJvbSAnQGJhYmVsL3RlbXBsYXRlJztcbmltcG9ydCBnZW5lcmF0ZSBmcm9tICdAYmFiZWwvZ2VuZXJhdG9yJztcbmltcG9ydCB7IGNvZGVGcmFtZUNvbHVtbnMgfSBmcm9tICdAYmFiZWwvY29kZS1mcmFtZSc7XG5cbmltcG9ydCBnZW5lcmF0ZVJlc291cmNlUmVxdWVzdCBmcm9tICcuLi9nZW5lcmF0b3JzL3Jlc291cmNlLXJlcXVlc3QnO1xuXG5jb25zdCBtb2R1bGVOb3RGb3VuZFRlbXBsYXRlID0gVGVtcGxhdGUoYFxuXHRNT0RVTEUuX3Rocm93Tm90Rm91bmQoUkVRVUVTVCk7XG5gKTtcblxuZnVuY3Rpb24gaXNSZXF1aXJlUmVzb2x2ZShwYXRoKSB7XG5cdHJldHVybiAoXG5cdFx0cGF0aC5pc0NhbGxFeHByZXNzaW9uKCkgJiZcblx0XHRwYXRoLmdldCgnY2FsbGVlLnByb3BlcnR5JykuaXNJZGVudGlmaWVyKHsgbmFtZTogJ3Jlc29sdmUnIH0pICYmXG5cdFx0cGF0aC5nZXQoJ2NhbGxlZS5vYmplY3QnKS5pc0lkZW50aWZpZXIoeyBuYW1lOiAncmVxdWlyZScgfSlcblx0KTtcbn1cblxuZnVuY3Rpb24gaXNSZXF1aXJlKHBhdGgpIHtcblx0cmV0dXJuIHBhdGgubm9kZS5jYWxsZWUubmFtZSA9PT0gJ3JlcXVpcmUnICYmICFpc1JlcXVpcmVSZXNvbHZlKHBhdGguZ2V0KCdhcmd1bWVudHMuMCcpKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgKGFwaSwgeyBsb2dnZXIsIHJlc291cmNlIH0pID0+IHtcblx0Y29uc3QgbW9kdWxlSWRlbnRpZmllciA9IHQuSWRlbnRpZmllcignbW9kdWxlJyk7XG5cdGNvbnN0IHJlcXVpcmVJZGVudGlmaWVyID0gdC5JZGVudGlmaWVyKCckcmVxdWlyZScpO1xuXHRjb25zdCBpbXBvcnRJZGVudGlmaWVyID0gdC5NZW1iZXJFeHByZXNzaW9uKG1vZHVsZUlkZW50aWZpZXIsIHQuSWRlbnRpZmllcignaW1wb3J0JykpO1xuXHRjb25zdCBidWlsZFF1ZXJ5ID0gKC4uLmFyZ3MpID0+IHJlc291cmNlLmFkYXB0ZXIucGFyc2VyLmJ1aWxkUXVlcnkoLi4uYXJncyk7XG5cblx0ZnVuY3Rpb24gcHJpbnRSZXF1ZXN0V2FybmluZyhwYXRoKSB7XG5cdFx0Y29uc3QgcHJvZ3JhbSA9IHBhdGguc2NvcGUuZ2V0UHJvZ3JhbVBhcmVudCgpO1xuXHRcdGNvbnN0IHsgY29kZSB9ID0gZ2VuZXJhdGUocHJvZ3JhbS5ibG9jaywgeyByZXRhaW5MaW5lczogdHJ1ZSB9KTtcblx0XHRjb25zdCBsb2NhdGlvbiA9IHBhdGgubm9kZS5sb2M7XG5cdFx0Y29uc3QgZnJhbWUgPSBjb2RlRnJhbWVDb2x1bW5zKGNvZGUsIGxvY2F0aW9uLCB7XG5cdFx0XHRtZXNzYWdlOiAnQ2Fubm90IHN0YXRpY2FsbHkgZGV0ZXJtaW5lIHJlcXVlc3QgdmFsdWUnLFxuXHRcdFx0aGlnaGxpZ2h0Q29kZTogdHJ1ZVxuXHRcdH0pO1xuXHRcdGxvZ2dlci53YXJuKGAke3Jlc291cmNlLm1vZHVsZUlkfTpcXG5cXG4ke2ZyYW1lfVxcbmApO1xuXHR9XG5cblx0ZnVuY3Rpb24gcmVwbGFjZURlZmF1bHQocGF0aCwgcmVxdWVzdCkge1xuXHRcdGNvbnN0IGN0eCA9IHJlc291cmNlLmNvbnRleHRGYWN0b3J5KHJlcXVlc3QsIHJlc291cmNlLmdldFJlc29sdmVyUGF0aHMoKSk7XG5cdFx0c3dpdGNoICh0cnVlKSB7XG5cdFx0XHRjYXNlIEJvb2xlYW4oY3R4LmVycm9yKTpcblx0XHRcdFx0cGF0aC5yZXBsYWNlV2l0aChcblx0XHRcdFx0XHRtb2R1bGVOb3RGb3VuZFRlbXBsYXRlKHtcblx0XHRcdFx0XHRcdE1PRFVMRTogbW9kdWxlSWRlbnRpZmllcixcblx0XHRcdFx0XHRcdFJFUVVFU1Q6IHJlcXVlc3Qubm9kZVxuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdCk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSBjdHguaXNFeHRlcm5hbCgpOlxuXHRcdFx0XHRwYXRoLnJlcGxhY2VXaXRoKHQuQ2FsbEV4cHJlc3Npb24ocmVxdWlyZUlkZW50aWZpZXIsIFt0LlN0cmluZ0xpdGVyYWwoY3R4Lm1vZHVsZUlkKV0pKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIGN0eC5pc051bGwoKToge1xuXHRcdFx0XHRjb25zdCBkZWNsYXJhdG9yUGF0aCA9IHBhdGguZmluZFBhcmVudChwID0+IHAuaXNWYXJpYWJsZURlY2xhcmF0b3IoKSk7XG5cdFx0XHRcdGNvbnN0IHRhcmdldFBhdGggPSBkZWNsYXJhdG9yUGF0aCA/IGRlY2xhcmF0b3JQYXRoLmdldCgnaW5pdCcpIDogcGF0aDtcblx0XHRcdFx0dGFyZ2V0UGF0aC5yZXBsYWNlV2l0aCh0LklkZW50aWZpZXIoJ251bGwnKSk7XG5cdFx0XHRcdHRhcmdldFBhdGguYWRkQ29tbWVudCgnbGVhZGluZycsIHJlcXVlc3QudmFsdWUpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdH1cblx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdHBhdGgucmVwbGFjZVdpdGgodC5DYWxsRXhwcmVzc2lvbihyZXF1aXJlSWRlbnRpZmllciwgW3QuTnVtZXJpY0xpdGVyYWwoY3R4LnBpZCldKSk7XG5cdFx0XHRcdHBhdGguYWRkQ29tbWVudCgnbGVhZGluZycsIHJlcXVlc3QudmFsdWUpO1xuXHRcdFx0XHRicmVhaztcblx0XHR9XG5cdH1cblxuXHRmdW5jdGlvbiByZXBsYWNlUmVxdWVzdChwYXRoKSB7XG5cdFx0Y29uc3QgcmVxdWVzdCA9IGdlbmVyYXRlUmVzb3VyY2VSZXF1ZXN0KHBhdGgubm9kZSwgYnVpbGRRdWVyeSk7XG5cdFx0c3dpdGNoICh0cnVlKSB7XG5cdFx0XHRjYXNlIGlzUmVxdWlyZVJlc29sdmUocGF0aCk6XG5cdFx0XHRcdGlmIChyZXF1ZXN0LmR5bmFtaWMpIHtcblx0XHRcdFx0XHRwYXRoLnJlcGxhY2VXaXRoKFxuXHRcdFx0XHRcdFx0dC5DYWxsRXhwcmVzc2lvbih0Lk1lbWJlckV4cHJlc3Npb24obW9kdWxlSWRlbnRpZmllciwgdC5JZGVudGlmaWVyKCdyZXNvbHZlRHluYW1pYycpKSwgW1xuXHRcdFx0XHRcdFx0XHRyZXF1ZXN0Lm5vZGVcblx0XHRcdFx0XHRcdF0pXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRjb25zdCBjdHggPSByZXNvdXJjZS5jb250ZXh0RmFjdG9yeShyZXF1ZXN0LCByZXNvdXJjZS5nZXRSZXNvbHZlclBhdGhzKCkpO1xuXHRcdFx0XHRcdGlmIChjdHguaXNOdWxsKCkpIHtcblx0XHRcdFx0XHRcdHBhdGgucmVwbGFjZVdpdGgoXG5cdFx0XHRcdFx0XHRcdG1vZHVsZU5vdEZvdW5kVGVtcGxhdGUoe1xuXHRcdFx0XHRcdFx0XHRcdE1PRFVMRTogbW9kdWxlSWRlbnRpZmllcixcblx0XHRcdFx0XHRcdFx0XHRSRVFVRVNUOiByZXF1ZXN0Lm5vZGVcblx0XHRcdFx0XHRcdFx0fSlcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdHBhdGgucmVwbGFjZVdpdGgodC5TdHJpbmdMaXRlcmFsKGN0eC5tb2R1bGVJZCkpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgcmVxdWVzdC5hc3luYzpcblx0XHRcdFx0aWYgKHJlcXVlc3QuZHluYW1pYykge1xuXHRcdFx0XHRcdHBhdGgucmVwbGFjZVdpdGgoXG5cdFx0XHRcdFx0XHR0LkNhbGxFeHByZXNzaW9uKGltcG9ydElkZW50aWZpZXIsIFtcblx0XHRcdFx0XHRcdFx0dC5DYWxsRXhwcmVzc2lvbihcblx0XHRcdFx0XHRcdFx0XHR0Lk1lbWJlckV4cHJlc3Npb24obW9kdWxlSWRlbnRpZmllciwgdC5JZGVudGlmaWVyKCdyZXNvbHZlRHluYW1pYycpKSxcblx0XHRcdFx0XHRcdFx0XHRbcmVxdWVzdC5ub2RlXVxuXHRcdFx0XHRcdFx0XHQpXG5cdFx0XHRcdFx0XHRdKVxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0Y29uc3QgY3R4ID0gcmVzb3VyY2UuY29udGV4dEZhY3RvcnkocmVxdWVzdCwgcmVzb3VyY2UuZ2V0UmVzb2x2ZXJQYXRocygpKTtcblx0XHRcdFx0XHRwYXRoLnJlcGxhY2VXaXRoKHQuQ2FsbEV4cHJlc3Npb24oaW1wb3J0SWRlbnRpZmllciwgW3QuU3RyaW5nTGl0ZXJhbChjdHgubW9kdWxlSWQpXSkpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSByZXF1ZXN0LmhyZWY6IHtcblx0XHRcdFx0aWYgKHJlcXVlc3QuZHluYW1pYykge1xuXHRcdFx0XHRcdHByaW50UmVxdWVzdFdhcm5pbmcocGF0aCk7XG5cdFx0XHRcdFx0cGF0aC5yZXBsYWNlV2l0aChcblx0XHRcdFx0XHRcdHQuQ2FsbEV4cHJlc3Npb24odC5NZW1iZXJFeHByZXNzaW9uKG1vZHVsZUlkZW50aWZpZXIsIHQuSWRlbnRpZmllcigncmVzb2x2ZVVSTCcpKSwgW1xuXHRcdFx0XHRcdFx0XHR0LkNhbGxFeHByZXNzaW9uKFxuXHRcdFx0XHRcdFx0XHRcdHQuTWVtYmVyRXhwcmVzc2lvbihtb2R1bGVJZGVudGlmaWVyLCB0LklkZW50aWZpZXIoJ3Jlc29sdmVEeW5hbWljJykpLFxuXHRcdFx0XHRcdFx0XHRcdFtyZXF1ZXN0Lm5vZGVdXG5cdFx0XHRcdFx0XHRcdClcblx0XHRcdFx0XHRcdF0pXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRjb25zdCBjdHggPSByZXNvdXJjZS5jb250ZXh0RmFjdG9yeShyZXF1ZXN0LCByZXNvdXJjZS5nZXRSZXNvbHZlclBhdGhzKCkpO1xuXHRcdFx0XHRcdHBhdGgucmVwbGFjZVdpdGgodC5TdHJpbmdMaXRlcmFsKGN0eC51cmwpKTtcblx0XHRcdFx0fVxuXHRcdFx0XHRicmVhaztcblx0XHRcdH1cblx0XHRcdGNhc2UgcmVxdWVzdC5keW5hbWljOlxuXHRcdFx0XHRwcmludFJlcXVlc3RXYXJuaW5nKHBhdGgpO1xuXHRcdFx0XHRwYXRoLnJlcGxhY2VXaXRoKFxuXHRcdFx0XHRcdHQuQ2FsbEV4cHJlc3Npb24ocmVxdWlyZUlkZW50aWZpZXIsIFtcblx0XHRcdFx0XHRcdHQuQ2FsbEV4cHJlc3Npb24odC5NZW1iZXJFeHByZXNzaW9uKG1vZHVsZUlkZW50aWZpZXIsIHQuSWRlbnRpZmllcigncmVzb2x2ZUR5bmFtaWMnKSksIFtcblx0XHRcdFx0XHRcdFx0cmVxdWVzdC5ub2RlXG5cdFx0XHRcdFx0XHRdKVxuXHRcdFx0XHRcdF0pXG5cdFx0XHRcdCk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0cmVwbGFjZURlZmF1bHQocGF0aCwgcmVxdWVzdCk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiB7XG5cdFx0dmlzaXRvcjoge1xuXHRcdFx0TWVtYmVyRXhwcmVzc2lvbihwYXRoKSB7XG5cdFx0XHRcdGNvbnN0IHsgb2JqZWN0LCBwcm9wZXJ0eSB9ID0gcGF0aC5ub2RlO1xuXHRcdFx0XHRpZiAob2JqZWN0Lm5hbWUgPT09ICdTeXN0ZW0nICYmIHByb3BlcnR5Lm5hbWUgPT09ICdpbXBvcnQnKSB7XG5cdFx0XHRcdFx0Ly8gRklYTUU6IE1vdmUgdGhpcyB0byBhIENhbGxFeHByZXNzaW9uIHZpc2l0b3I/XG5cdFx0XHRcdFx0cmVwbGFjZVJlcXVlc3QocGF0aC5wYXJlbnRQYXRoKTtcblx0XHRcdFx0fSBlbHNlIGlmIChvYmplY3QubmFtZSA9PT0gJ3JlcXVpcmUnICYmIHByb3BlcnR5Lm5hbWUgPT09ICdjYWNoZScpIHtcblx0XHRcdFx0XHQvLyBGSVhNRTogTW92ZSB0aGlzIHRvIGFuIElkZW50aWZpZXIgdmlzaXRvcj9cblx0XHRcdFx0XHRjb25zdCByZWdpc3RyeUlkZW50aWZpZXIgPSB0Lk1lbWJlckV4cHJlc3Npb24obW9kdWxlSWRlbnRpZmllciwgdC5JZGVudGlmaWVyKCdyZWdpc3RyeScpKTtcblx0XHRcdFx0XHRpZiAodC5pc01lbWJlckV4cHJlc3Npb24ocGF0aC5wYXJlbnQpKSB7XG5cdFx0XHRcdFx0XHRwYXRoLnBhcmVudFBhdGgucmVwbGFjZVdpdGgoXG5cdFx0XHRcdFx0XHRcdHQuQ2FsbEV4cHJlc3Npb24odC5NZW1iZXJFeHByZXNzaW9uKHJlZ2lzdHJ5SWRlbnRpZmllciwgdC5JZGVudGlmaWVyKCdnZXQnKSksIFtcblx0XHRcdFx0XHRcdFx0XHRwYXRoLnBhcmVudC5wcm9wZXJ0eVxuXHRcdFx0XHRcdFx0XHRdKVxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0cGF0aC5yZXBsYWNlV2l0aChyZWdpc3RyeUlkZW50aWZpZXIpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fSxcblx0XHRcdENhbGxFeHByZXNzaW9uKHBhdGgpIHtcblx0XHRcdFx0aWYgKHQuaXNJbXBvcnQocGF0aC5ub2RlLmNhbGxlZSkgfHwgaXNSZXF1aXJlKHBhdGgpIHx8IGlzUmVxdWlyZVJlc29sdmUocGF0aCkpIHtcblx0XHRcdFx0XHRyZXBsYWNlUmVxdWVzdChwYXRoKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblx0fTtcbn07XG4iXX0=