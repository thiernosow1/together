"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var t = _interopRequireWildcard(require("@babel/types"));

var _traverse = _interopRequireDefault(require("@babel/traverse"));

var _requestAttributes = require("../../../lib/request-attributes");

var _defineProperties = _interopRequireDefault(require("../../../lib/helpers/defineProperties"));

var _get = _interopRequireDefault(require("../../../lib/helpers/get"));

var _once = _interopRequireDefault(require("../../../lib/helpers/once"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function isImport(path) {
  if (path.findParent(({
    node
  }) => t.isImport(node.callee))) {
    return true;
  }

  const callee = (0, _get.default)(path.findParent(p => p.isCallExpression()), ['node', 'callee']);
  return (0, _get.default)(callee, ['object', 'name']) === 'System' && (0, _get.default)(callee, ['property', 'name']) === 'import';
}

function parseRequestPath(path) {
  const {
    value
  } = path.node;
  const {
    list,
    attributes
  } = (0, _requestAttributes.parseAttributes)(value);

  if (list) {
    path.replaceWith(t.StringLiteral((0, _requestAttributes.stripAttributes)(value)));
  }

  return _objectSpread({}, attributes, {
    async: isImport(path) && !list || attributes.async
  });
}

function createRootNode(requestNode) {
  return t.File(t.Program([t.isExpression(requestNode) ? t.ExpressionStatement(requestNode) : requestNode]));
}

function getValueNode({
  program
}) {
  return (// ImportDeclaration
    program.body[0].source || // CallExpression
    program.body[0].expression.arguments[0]
  );
}

function getValue(valueNode) {
  return t.isStringLiteral(valueNode) ? valueNode.value : undefined;
}

function replaceVariableNode(variables, path) {
  if (variables.has(path.node)) {
    path.replaceWith(t.StringLiteral('*'));
  }
}

function requestToGlob(requestNode, variables) {
  if (variables.size === 0) {
    return undefined;
  }

  const rootNode = createRootNode(requestNode);
  (0, _traverse.default)(rootNode, {
    StringLiteral: (0, _once.default)(path => {
      parseRequestPath(path);
    }),

    Expression(path) {
      if (!t.isLiteral(path.node)) {
        replaceVariableNode(variables, path);
      }
    },

    exit(path) {
      if (!t.isLiteral(path.node)) {
        const {
          confident,
          value
        } = path.evaluate();

        if (confident) {
          path.replaceWith(t.StringLiteral(value));
          path.skip();
        }
      }
    }

  });
  return getValue(getValueNode(rootNode));
}

var _default = (originalRequestNode, buildQuery) => {
  class VariableStore extends Set {
    add(node) {
      return super.add(buildQuery(node));
    }

    has(node) {
      return super.has(buildQuery(node));
    }

  }

  const requestNode = t.cloneDeep(originalRequestNode);
  const requestNodeCopy = t.cloneDeep(requestNode);
  const rootNode = createRootNode(requestNode);
  const variables = new VariableStore();
  const attributes = {};
  (0, _traverse.default)(rootNode, {
    StringLiteral: (0, _once.default)(path => {
      Object.assign(attributes, parseRequestPath(path));
    }),

    Expression(path) {
      if (!t.isLiteral(path.node) && !t.isBinaryExpression(path.node) && path.node !== requestNode && path.parent !== requestNode) {
        if (t.isMemberExpression(path.node)) {
          if (!t.isLiteral(path.node.object)) {
            variables.add(path.node);
            path.skip();
          }
        } else if (t.isCallExpression(path.node) || t.isIdentifier(path.node)) {
          variables.add(path.node);
          path.skip();
        }
      }
    },

    exit(path) {
      if (!t.isLiteral(path.node)) {
        const {
          confident,
          value
        } = path.evaluate();

        if (confident) {
          path.replaceWith(t.StringLiteral(value));
          path.skip();
        }
      }
    }

  });
  const pattern = requestToGlob(requestNodeCopy, variables);
  const valueNode = getValueNode(rootNode);
  const value = getValue(valueNode);
  const attributesString = (0, _requestAttributes.formatAttributes)(attributes);
  const dynamic = typeof value !== 'string' || undefined;
  const requestObject = (0, _defineProperties.default)(_objectSpread({}, attributes, {
    attributes: attributesString,
    dynamic,
    pattern,
    value
  }), {
    getKey: (string = value) => [attributesString, string].join(''),
    node: {
      value: valueNode
    }
  });
  return requestObject;
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9zZXJ2ZXIvaW5zdGFsbGVyL2dlbmVyYXRvcnMvcmVzb3VyY2UtcmVxdWVzdC5qcyJdLCJuYW1lcyI6WyJpc0ltcG9ydCIsInBhdGgiLCJmaW5kUGFyZW50Iiwibm9kZSIsInQiLCJjYWxsZWUiLCJwIiwiaXNDYWxsRXhwcmVzc2lvbiIsInBhcnNlUmVxdWVzdFBhdGgiLCJ2YWx1ZSIsImxpc3QiLCJhdHRyaWJ1dGVzIiwicmVwbGFjZVdpdGgiLCJTdHJpbmdMaXRlcmFsIiwiYXN5bmMiLCJjcmVhdGVSb290Tm9kZSIsInJlcXVlc3ROb2RlIiwiRmlsZSIsIlByb2dyYW0iLCJpc0V4cHJlc3Npb24iLCJFeHByZXNzaW9uU3RhdGVtZW50IiwiZ2V0VmFsdWVOb2RlIiwicHJvZ3JhbSIsImJvZHkiLCJzb3VyY2UiLCJleHByZXNzaW9uIiwiYXJndW1lbnRzIiwiZ2V0VmFsdWUiLCJ2YWx1ZU5vZGUiLCJpc1N0cmluZ0xpdGVyYWwiLCJ1bmRlZmluZWQiLCJyZXBsYWNlVmFyaWFibGVOb2RlIiwidmFyaWFibGVzIiwiaGFzIiwicmVxdWVzdFRvR2xvYiIsInNpemUiLCJyb290Tm9kZSIsIkV4cHJlc3Npb24iLCJpc0xpdGVyYWwiLCJleGl0IiwiY29uZmlkZW50IiwiZXZhbHVhdGUiLCJza2lwIiwib3JpZ2luYWxSZXF1ZXN0Tm9kZSIsImJ1aWxkUXVlcnkiLCJWYXJpYWJsZVN0b3JlIiwiU2V0IiwiYWRkIiwiY2xvbmVEZWVwIiwicmVxdWVzdE5vZGVDb3B5IiwiT2JqZWN0IiwiYXNzaWduIiwiaXNCaW5hcnlFeHByZXNzaW9uIiwicGFyZW50IiwiaXNNZW1iZXJFeHByZXNzaW9uIiwib2JqZWN0IiwiaXNJZGVudGlmaWVyIiwicGF0dGVybiIsImF0dHJpYnV0ZXNTdHJpbmciLCJkeW5hbWljIiwicmVxdWVzdE9iamVjdCIsImdldEtleSIsInN0cmluZyIsImpvaW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFF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QUUsQ0FBQ0MsTUFBTSxHQUFHckQsS0FBVixLQUFvQixDQUFDaUQsZ0JBQUQsRUFBbUJJLE1BQW5CLEVBQTJCQyxJQUEzQixDQUFnQyxFQUFoQyxDQUQ3QjtBQUVDNUQsSUFBQUEsSUFBSSxFQUFFO0FBQ0xNLE1BQUFBLEtBQUssRUFBRW1CO0FBREY7QUFGUCxHQVJxQixDQUF0QjtBQWdCQSxTQUFPZ0MsYUFBUDtBQUNBLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB0IGZyb20gJ0BiYWJlbC90eXBlcyc7XG5pbXBvcnQgdHJhdmVyc2UgZnJvbSAnQGJhYmVsL3RyYXZlcnNlJztcblxuaW1wb3J0IHtcblx0Zm9ybWF0QXR0cmlidXRlcyxcblx0cGFyc2VBdHRyaWJ1dGVzLFxuXHRzdHJpcEF0dHJpYnV0ZXNcbn0gZnJvbSAnLi4vLi4vLi4vbGliL3JlcXVlc3QtYXR0cmlidXRlcyc7XG5pbXBvcnQgZGVmaW5lUHJvcGVydGllcyBmcm9tICcuLi8uLi8uLi9saWIvaGVscGVycy9kZWZpbmVQcm9wZXJ0aWVzJztcbmltcG9ydCBnZXQgZnJvbSAnLi4vLi4vLi4vbGliL2hlbHBlcnMvZ2V0JztcbmltcG9ydCBvbmNlIGZyb20gJy4uLy4uLy4uL2xpYi9oZWxwZXJzL29uY2UnO1xuXG5mdW5jdGlvbiBpc0ltcG9ydChwYXRoKSB7XG5cdGlmIChwYXRoLmZpbmRQYXJlbnQoKHsgbm9kZSB9KSA9PiB0LmlzSW1wb3J0KG5vZGUuY2FsbGVlKSkpIHtcblx0XHRyZXR1cm4gdHJ1ZTtcblx0fVxuXHRjb25zdCBjYWxsZWUgPSBnZXQocGF0aC5maW5kUGFyZW50KHAgPT4gcC5pc0NhbGxFeHByZXNzaW9uKCkpLCBbJ25vZGUnLCAnY2FsbGVlJ10pO1xuXHRyZXR1cm4gKFxuXHRcdGdldChjYWxsZWUsIFsnb2JqZWN0JywgJ25hbWUnXSkgPT09ICdTeXN0ZW0nICYmIGdldChjYWxsZWUsIFsncHJvcGVydHknLCAnbmFtZSddKSA9PT0gJ2ltcG9ydCdcblx0KTtcbn1cblxuZnVuY3Rpb24gcGFyc2VSZXF1ZXN0UGF0aChwYXRoKSB7XG5cdGNvbnN0IHsgdmFsdWUgfSA9IHBhdGgubm9kZTtcblx0Y29uc3QgeyBsaXN0LCBhdHRyaWJ1dGVzIH0gPSBwYXJzZUF0dHJpYnV0ZXModmFsdWUpO1xuXHRpZiAobGlzdCkge1xuXHRcdHBhdGgucmVwbGFjZVdpdGgodC5TdHJpbmdMaXRlcmFsKHN0cmlwQXR0cmlidXRlcyh2YWx1ZSkpKTtcblx0fVxuXHRyZXR1cm4ge1xuXHRcdC4uLmF0dHJpYnV0ZXMsXG5cdFx0YXN5bmM6IChpc0ltcG9ydChwYXRoKSAmJiAhbGlzdCkgfHwgYXR0cmlidXRlcy5hc3luY1xuXHR9O1xufVxuXG5mdW5jdGlvbiBjcmVhdGVSb290Tm9kZShyZXF1ZXN0Tm9kZSkge1xuXHRyZXR1cm4gdC5GaWxlKFxuXHRcdHQuUHJvZ3JhbShbdC5pc0V4cHJlc3Npb24ocmVxdWVzdE5vZGUpID8gdC5FeHByZXNzaW9uU3RhdGVtZW50KHJlcXVlc3ROb2RlKSA6IHJlcXVlc3ROb2RlXSlcblx0KTtcbn1cblxuZnVuY3Rpb24gZ2V0VmFsdWVOb2RlKHsgcHJvZ3JhbSB9KSB7XG5cdHJldHVybiAoXG5cdFx0Ly8gSW1wb3J0RGVjbGFyYXRpb25cblx0XHRwcm9ncmFtLmJvZHlbMF0uc291cmNlIHx8XG5cdFx0Ly8gQ2FsbEV4cHJlc3Npb25cblx0XHRwcm9ncmFtLmJvZHlbMF0uZXhwcmVzc2lvbi5hcmd1bWVudHNbMF1cblx0KTtcbn1cblxuZnVuY3Rpb24gZ2V0VmFsdWUodmFsdWVOb2RlKSB7XG5cdHJldHVybiB0LmlzU3RyaW5nTGl0ZXJhbCh2YWx1ZU5vZGUpID8gdmFsdWVOb2RlLnZhbHVlIDogdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiByZXBsYWNlVmFyaWFibGVOb2RlKHZhcmlhYmxlcywgcGF0aCkge1xuXHRpZiAodmFyaWFibGVzLmhhcyhwYXRoLm5vZGUpKSB7XG5cdFx0cGF0aC5yZXBsYWNlV2l0aCh0LlN0cmluZ0xpdGVyYWwoJyonKSk7XG5cdH1cbn1cblxuZnVuY3Rpb24gcmVxdWVzdFRvR2xvYihyZXF1ZXN0Tm9kZSwgdmFyaWFibGVzKSB7XG5cdGlmICh2YXJpYWJsZXMuc2l6ZSA9PT0gMCkge1xuXHRcdHJldHVybiB1bmRlZmluZWQ7XG5cdH1cblxuXHRjb25zdCByb290Tm9kZSA9IGNyZWF0ZVJvb3ROb2RlKHJlcXVlc3ROb2RlKTtcblxuXHR0cmF2ZXJzZShyb290Tm9kZSwge1xuXHRcdFN0cmluZ0xpdGVyYWw6IG9uY2UocGF0aCA9PiB7XG5cdFx0XHRwYXJzZVJlcXVlc3RQYXRoKHBhdGgpO1xuXHRcdH0pLFxuXHRcdEV4cHJlc3Npb24ocGF0aCkge1xuXHRcdFx0aWYgKCF0LmlzTGl0ZXJhbChwYXRoLm5vZGUpKSB7XG5cdFx0XHRcdHJlcGxhY2VWYXJpYWJsZU5vZGUodmFyaWFibGVzLCBwYXRoKTtcblx0XHRcdH1cblx0XHR9LFxuXHRcdGV4aXQocGF0aCkge1xuXHRcdFx0aWYgKCF0LmlzTGl0ZXJhbChwYXRoLm5vZGUpKSB7XG5cdFx0XHRcdGNvbnN0IHsgY29uZmlkZW50LCB2YWx1ZSB9ID0gcGF0aC5ldmFsdWF0ZSgpO1xuXHRcdFx0XHRpZiAoY29uZmlkZW50KSB7XG5cdFx0XHRcdFx0cGF0aC5yZXBsYWNlV2l0aCh0LlN0cmluZ0xpdGVyYWwodmFsdWUpKTtcblx0XHRcdFx0XHRwYXRoLnNraXAoKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblx0fSk7XG5cblx0cmV0dXJuIGdldFZhbHVlKGdldFZhbHVlTm9kZShyb290Tm9kZSkpO1xufVxuXG5leHBvcnQgZGVmYXVsdCAob3JpZ2luYWxSZXF1ZXN0Tm9kZSwgYnVpbGRRdWVyeSkgPT4ge1xuXHRjbGFzcyBWYXJpYWJsZVN0b3JlIGV4dGVuZHMgU2V0IHtcblx0XHRhZGQobm9kZSkge1xuXHRcdFx0cmV0dXJuIHN1cGVyLmFkZChidWlsZFF1ZXJ5KG5vZGUpKTtcblx0XHR9XG5cdFx0aGFzKG5vZGUpIHtcblx0XHRcdHJldHVybiBzdXBlci5oYXMoYnVpbGRRdWVyeShub2RlKSk7XG5cdFx0fVxuXHR9XG5cblx0Y29uc3QgcmVxdWVzdE5vZGUgPSB0LmNsb25lRGVlcChvcmlnaW5hbFJlcXVlc3ROb2RlKTtcblx0Y29uc3QgcmVxdWVzdE5vZGVDb3B5ID0gdC5jbG9uZURlZXAocmVxdWVzdE5vZGUpO1xuXHRjb25zdCByb290Tm9kZSA9IGNyZWF0ZVJvb3ROb2RlKHJlcXVlc3ROb2RlKTtcblx0Y29uc3QgdmFyaWFibGVzID0gbmV3IFZhcmlhYmxlU3RvcmUoKTtcblx0Y29uc3QgYXR0cmlidXRlcyA9IHt9O1xuXG5cdHRyYXZlcnNlKHJvb3ROb2RlLCB7XG5cdFx0U3RyaW5nTGl0ZXJhbDogb25jZShwYXRoID0+IHtcblx0XHRcdE9iamVjdC5hc3NpZ24oYXR0cmlidXRlcywgcGFyc2VSZXF1ZXN0UGF0aChwYXRoKSk7XG5cdFx0fSksXG5cdFx0RXhwcmVzc2lvbihwYXRoKSB7XG5cdFx0XHRpZiAoXG5cdFx0XHRcdCF0LmlzTGl0ZXJhbChwYXRoLm5vZGUpICYmXG5cdFx0XHRcdCF0LmlzQmluYXJ5RXhwcmVzc2lvbihwYXRoLm5vZGUpICYmXG5cdFx0XHRcdHBhdGgubm9kZSAhPT0gcmVxdWVzdE5vZGUgJiZcblx0XHRcdFx0cGF0aC5wYXJlbnQgIT09IHJlcXVlc3ROb2RlXG5cdFx0XHQpIHtcblx0XHRcdFx0aWYgKHQuaXNNZW1iZXJFeHByZXNzaW9uKHBhdGgubm9kZSkpIHtcblx0XHRcdFx0XHRpZiAoIXQuaXNMaXRlcmFsKHBhdGgubm9kZS5vYmplY3QpKSB7XG5cdFx0XHRcdFx0XHR2YXJpYWJsZXMuYWRkKHBhdGgubm9kZSk7XG5cdFx0XHRcdFx0XHRwYXRoLnNraXAoKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0gZWxzZSBpZiAodC5pc0NhbGxFeHByZXNzaW9uKHBhdGgubm9kZSkgfHwgdC5pc0lkZW50aWZpZXIocGF0aC5ub2RlKSkge1xuXHRcdFx0XHRcdHZhcmlhYmxlcy5hZGQocGF0aC5ub2RlKTtcblx0XHRcdFx0XHRwYXRoLnNraXAoKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0sXG5cdFx0ZXhpdChwYXRoKSB7XG5cdFx0XHRpZiAoIXQuaXNMaXRlcmFsKHBhdGgubm9kZSkpIHtcblx0XHRcdFx0Y29uc3QgeyBjb25maWRlbnQsIHZhbHVlIH0gPSBwYXRoLmV2YWx1YXRlKCk7XG5cdFx0XHRcdGlmIChjb25maWRlbnQpIHtcblx0XHRcdFx0XHRwYXRoLnJlcGxhY2VXaXRoKHQuU3RyaW5nTGl0ZXJhbCh2YWx1ZSkpO1xuXHRcdFx0XHRcdHBhdGguc2tpcCgpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXHR9KTtcblxuXHRjb25zdCBwYXR0ZXJuID0gcmVxdWVzdFRvR2xvYihyZXF1ZXN0Tm9kZUNvcHksIHZhcmlhYmxlcyk7XG5cdGNvbnN0IHZhbHVlTm9kZSA9IGdldFZhbHVlTm9kZShyb290Tm9kZSk7XG5cdGNvbnN0IHZhbHVlID0gZ2V0VmFsdWUodmFsdWVOb2RlKTtcblx0Y29uc3QgYXR0cmlidXRlc1N0cmluZyA9IGZvcm1hdEF0dHJpYnV0ZXMoYXR0cmlidXRlcyk7XG5cdGNvbnN0IGR5bmFtaWMgPSB0eXBlb2YgdmFsdWUgIT09ICdzdHJpbmcnIHx8IHVuZGVmaW5lZDtcblxuXHRjb25zdCByZXF1ZXN0T2JqZWN0ID0gZGVmaW5lUHJvcGVydGllcyhcblx0XHR7XG5cdFx0XHQuLi5hdHRyaWJ1dGVzLFxuXHRcdFx0YXR0cmlidXRlczogYXR0cmlidXRlc1N0cmluZyxcblx0XHRcdGR5bmFtaWMsXG5cdFx0XHRwYXR0ZXJuLFxuXHRcdFx0dmFsdWVcblx0XHR9LFxuXHRcdHtcblx0XHRcdGdldEtleTogKHN0cmluZyA9IHZhbHVlKSA9PiBbYXR0cmlidXRlc1N0cmluZywgc3RyaW5nXS5qb2luKCcnKSxcblx0XHRcdG5vZGU6IHtcblx0XHRcdFx0dmFsdWU6IHZhbHVlTm9kZVxuXHRcdFx0fVxuXHRcdH1cblx0KTtcblxuXHRyZXR1cm4gcmVxdWVzdE9iamVjdDtcbn07XG4iXX0=