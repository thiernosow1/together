"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var css = _interopRequireWildcard(require("css"));

var _astq = _interopRequireDefault(require("astq"));

var _parser = _interopRequireDefault(require("../parser"));

var _get = _interopRequireDefault(require("../../../../../lib/helpers/get"));

var _requestAttributes = require("../../../../../lib/request-attributes");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const astq = new _astq.default();
astq.adapter({
  getNodeType: node => node.type,
  getParentNode: node => node.parent,
  getChildNodes: (node, type) => {
    let children;

    if (type === '*') {
      children = [].concat((0, _get.default)(node, ['stylesheet', 'rules']), node.rules, node.declarations, node.keyframes).filter(Boolean);
    } else if (node[type]) {
      children = [].concat(node[type]);
    } else {
      throw new Error(`No such axis '${type}' for walking child nodes`);
    }

    return children;
  },
  getNodeAttrNames: node => {
    const names = [];

    for (const [key, value] of Object.entries(node)) {
      if (key !== 'type' && key !== 'position' && (value === null || typeof value !== 'object')) {
        names.push(key);
      }
    }

    return names;
  },
  getNodeAttrValue: (node, key) => node[key]
}, true);

var _default = () => new _parser.default({
  parse(source, options) {
    return css.parse(source, _objectSpread({
      source: this.sourceFilename
    }, options));
  },

  buildQuery() {
    return '';
  },

  runQuery(query, ast = this.ast) {
    return astq.query(ast, query);
  },

  getRequests() {
    return Array.from([...this.runQuery('// import').map(node => {
      const [, value] = /^(?:url\()?["']?([^\s"')]+)["']?\)?$/i.exec(node.import);
      return {
        type: node.type,
        value
      };
    }), ...this.runQuery('// declaration').reduce((acc, node) => {
      const urlRegExp = /url\(["']?([^\s"']+)["']?\)/gi;
      let value; // eslint-disable-next-line no-cond-assign, no-sequences

      while ([, value] = urlRegExp.exec(node.value) || [], value) {
        acc.push({
          type: node.type,
          value
        });
      }

      return acc;
    }, [])].reduce((acc, request) => {
      if (request.value) {
        const {
          attributes
        } = (0, _requestAttributes.parseAttributes)(request.value);
        const value = (0, _requestAttributes.stripAttributes)(request.value.replace(/["']/g, ''));
        const attributesString = (0, _requestAttributes.formatAttributes)(attributes);
        const key = [attributesString, value].join('');

        if (value && !acc.has(key)) {
          acc.set(key, _objectSpread({}, request, attributes, {
            attributes: attributesString,
            value,
            key
          }));
        }
      }

      return acc;
    }, new Map()).values());
  },

  generate(resource, options) {
    const result = css.stringify(this.ast, _objectSpread({
      inputSourcemaps: true,
      sourcemap: Boolean(resource.options.sourceMaps && !this.sourceMapJSON)
    }, options));

    if (result.map) {
      this.sourceMapJSON = _objectSpread({}, result.map, {
        sourceRoot: this.sourceRoot
      });
    }

    return `${result.code || result}${this.getSourceMappingURL(resource)}`;
  },

  sourceMappingURL: content => `/*# sourceMappingURL=${content} */`
});

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9zZXJ2ZXIvaW5zdGFsbGVyL3Jlc291cmNlL2FkYXB0ZXJzL2Nzcy9wYXJzZXIuanMiXSwibmFtZXMiOlsiYXN0cSIsIkFTVFEiLCJhZGFwdGVyIiwiZ2V0Tm9kZVR5cGUiLCJub2RlIiwidHlwZSIsImdldFBhcmVudE5vZGUiLCJwYXJlbnQiLCJnZXRDaGlsZE5vZGVzIiwiY2hpbGRyZW4iLCJjb25jYXQiLCJydWxlcyIsImRlY2xhcmF0aW9ucyIsImtleWZyYW1lcyIsImZpbHRlciIsIkJvb2xlYW4iLCJFcnJvciIsImdldE5vZGVBdHRyTmFtZXMiLCJuYW1lcyIsImtleSIsInZhbHVlIiwiT2JqZWN0IiwiZW50cmllcyIsInB1c2giLCJnZXROb2RlQXR0clZhbHVlIiwiUGFyc2VyIiwicGFyc2UiLCJzb3VyY2UiLCJvcHRpb25zIiwiY3NzIiwic291cmNlRmlsZW5hbWUiLCJidWlsZFF1ZXJ5IiwicnVuUXVlcnkiLCJxdWVyeSIsImFzdCIsImdldFJlcXVlc3RzIiwiQXJyYXkiLCJmcm9tIiwibWFwIiwiZXhlYyIsImltcG9ydCIsInJlZHVjZSIsImFjYyIsInVybFJlZ0V4cCIsInJlcXVlc3QiLCJhdHRyaWJ1dGVzIiwicmVwbGFjZSIsImF0dHJpYnV0ZXNTdHJpbmciLCJqb2luIiwiaGFzIiwic2V0IiwiTWFwIiwidmFsdWVzIiwiZ2VuZXJhdGUiLCJyZXNvdXJjZSIsInJlc3VsdCIsInN0cmluZ2lmeSIsImlucHV0U291cmNlbWFwcyIsInNvdXJjZW1hcCIsInNvdXJjZU1hcHMiLCJzb3VyY2VNYXBKU09OIiwic291cmNlUm9vdCIsImNvZGUiLCJnZXRTb3VyY2VNYXBwaW5nVVJMIiwic291cmNlTWFwcGluZ1VSTCIsImNvbnRlbnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7OztBQU1BLE1BQU1BLElBQUksR0FBRyxJQUFJQyxhQUFKLEVBQWI7QUFF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Q0osRUFpQ0VDLE1BakNGLEVBRE0sQ0FBUDtBQW9DQSxHQWxEUzs7QUFtRFZDLEVBQUFBLFFBQVEsQ0FBQ0MsUUFBRCxFQUFXMUIsT0FBWCxFQUFvQjtBQUMzQixVQUFNMkIsTUFBTSxHQUFHMUIsR0FBRyxDQUFDMkIsU0FBSixDQUFjLEtBQUt0QixHQUFuQjtBQUNkdUIsTUFBQUEsZUFBZSxFQUFFLElBREg7QUFFZEMsTUFBQUEsU0FBUyxFQUFFM0MsT0FBTyxDQUFDdUMsUUFBUSxDQUFDMUIsT0FBVCxDQUFpQitCLFVBQWpCLElBQStCLENBQUMsS0FBS0MsYUFBdEM7QUFGSixPQUdYaEMsT0FIVyxFQUFmOztBQUtBLFFBQUkyQixNQUFNLENBQUNqQixHQUFYLEVBQWdCO0FBQ2YsV0FBS3NCLGFBQUwscUJBQ0lMLE1BQU0sQ0FBQ2pCLEdBRFg7QUFFQ3VCLFFBQUFBLFVBQVUsRUFBRSxLQUFLQTtBQUZsQjtBQUlBOztBQUNELFdBQVEsR0FBRU4sTUFBTSxDQUFDTyxJQUFQLElBQWVQLE1BQU8sR0FBRSxLQUFLUSxtQkFBTCxDQUF5QlQsUUFBekIsQ0FBbUMsRUFBckU7QUFDQSxHQWhFUzs7QUFpRVZVLEVBQUFBLGdCQUFnQixFQUFFQyxPQUFPLElBQUssd0JBQXVCQSxPQUFRO0FBakVuRCxDQUFYLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjc3MgZnJvbSAnY3NzJztcbmltcG9ydCBBU1RRIGZyb20gJ2FzdHEnO1xuXG5pbXBvcnQgUGFyc2VyIGZyb20gJy4uL3BhcnNlcic7XG5pbXBvcnQgZ2V0IGZyb20gJy4uLy4uLy4uLy4uLy4uL2xpYi9oZWxwZXJzL2dldCc7XG5pbXBvcnQge1xuXHRmb3JtYXRBdHRyaWJ1dGVzLFxuXHRwYXJzZUF0dHJpYnV0ZXMsXG5cdHN0cmlwQXR0cmlidXRlc1xufSBmcm9tICcuLi8uLi8uLi8uLi8uLi9saWIvcmVxdWVzdC1hdHRyaWJ1dGVzJztcblxuY29uc3QgYXN0cSA9IG5ldyBBU1RRKCk7XG5cbmFzdHEuYWRhcHRlcihcblx0e1xuXHRcdGdldE5vZGVUeXBlOiBub2RlID0+IG5vZGUudHlwZSxcblx0XHRnZXRQYXJlbnROb2RlOiBub2RlID0+IG5vZGUucGFyZW50LFxuXHRcdGdldENoaWxkTm9kZXM6IChub2RlLCB0eXBlKSA9PiB7XG5cdFx0XHRsZXQgY2hpbGRyZW47XG5cdFx0XHRpZiAodHlwZSA9PT0gJyonKSB7XG5cdFx0XHRcdGNoaWxkcmVuID0gW11cblx0XHRcdFx0XHQuY29uY2F0KGdldChub2RlLCBbJ3N0eWxlc2hlZXQnLCAncnVsZXMnXSksIG5vZGUucnVsZXMsIG5vZGUuZGVjbGFyYXRpb25zLCBub2RlLmtleWZyYW1lcylcblx0XHRcdFx0XHQuZmlsdGVyKEJvb2xlYW4pO1xuXHRcdFx0fSBlbHNlIGlmIChub2RlW3R5cGVdKSB7XG5cdFx0XHRcdGNoaWxkcmVuID0gW10uY29uY2F0KG5vZGVbdHlwZV0pO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKGBObyBzdWNoIGF4aXMgJyR7dHlwZX0nIGZvciB3YWxraW5nIGNoaWxkIG5vZGVzYCk7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gY2hpbGRyZW47XG5cdFx0fSxcblx0XHRnZXROb2RlQXR0ck5hbWVzOiBub2RlID0+IHtcblx0XHRcdGNvbnN0IG5hbWVzID0gW107XG5cdFx0XHRmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhub2RlKSkge1xuXHRcdFx0XHRpZiAoa2V5ICE9PSAndHlwZScgJiYga2V5ICE9PSAncG9zaXRpb24nICYmICh2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgIT09ICdvYmplY3QnKSkge1xuXHRcdFx0XHRcdG5hbWVzLnB1c2goa2V5KTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIG5hbWVzO1xuXHRcdH0sXG5cdFx0Z2V0Tm9kZUF0dHJWYWx1ZTogKG5vZGUsIGtleSkgPT4gbm9kZVtrZXldXG5cdH0sXG5cdHRydWVcbik7XG5cbmV4cG9ydCBkZWZhdWx0ICgpID0+XG5cdG5ldyBQYXJzZXIoe1xuXHRcdHBhcnNlKHNvdXJjZSwgb3B0aW9ucykge1xuXHRcdFx0cmV0dXJuIGNzcy5wYXJzZShzb3VyY2UsIHtcblx0XHRcdFx0c291cmNlOiB0aGlzLnNvdXJjZUZpbGVuYW1lLFxuXHRcdFx0XHQuLi5vcHRpb25zXG5cdFx0XHR9KTtcblx0XHR9LFxuXHRcdGJ1aWxkUXVlcnkoKSB7XG5cdFx0XHRyZXR1cm4gJyc7XG5cdFx0fSxcblx0XHRydW5RdWVyeShxdWVyeSwgYXN0ID0gdGhpcy5hc3QpIHtcblx0XHRcdHJldHVybiBhc3RxLnF1ZXJ5KGFzdCwgcXVlcnkpO1xuXHRcdH0sXG5cdFx0Z2V0UmVxdWVzdHMoKSB7XG5cdFx0XHRyZXR1cm4gQXJyYXkuZnJvbShcblx0XHRcdFx0W1xuXHRcdFx0XHRcdC4uLnRoaXMucnVuUXVlcnkoJy8vIGltcG9ydCcpLm1hcChub2RlID0+IHtcblx0XHRcdFx0XHRcdGNvbnN0IFssIHZhbHVlXSA9IC9eKD86dXJsXFwoKT9bXCInXT8oW15cXHNcIicpXSspW1wiJ10/XFwpPyQvaS5leGVjKG5vZGUuaW1wb3J0KTtcblx0XHRcdFx0XHRcdHJldHVybiB7IHR5cGU6IG5vZGUudHlwZSwgdmFsdWUgfTtcblx0XHRcdFx0XHR9KSxcblx0XHRcdFx0XHQuLi50aGlzLnJ1blF1ZXJ5KCcvLyBkZWNsYXJhdGlvbicpLnJlZHVjZSgoYWNjLCBub2RlKSA9PiB7XG5cdFx0XHRcdFx0XHRjb25zdCB1cmxSZWdFeHAgPSAvdXJsXFwoW1wiJ10/KFteXFxzXCInXSspW1wiJ10/XFwpL2dpO1xuXHRcdFx0XHRcdFx0bGV0IHZhbHVlO1xuXHRcdFx0XHRcdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbmQtYXNzaWduLCBuby1zZXF1ZW5jZXNcblx0XHRcdFx0XHRcdHdoaWxlICgoKFssIHZhbHVlXSA9IHVybFJlZ0V4cC5leGVjKG5vZGUudmFsdWUpIHx8IFtdKSwgdmFsdWUpKSB7XG5cdFx0XHRcdFx0XHRcdGFjYy5wdXNoKHsgdHlwZTogbm9kZS50eXBlLCB2YWx1ZSB9KTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdHJldHVybiBhY2M7XG5cdFx0XHRcdFx0fSwgW10pXG5cdFx0XHRcdF1cblx0XHRcdFx0XHQucmVkdWNlKChhY2MsIHJlcXVlc3QpID0+IHtcblx0XHRcdFx0XHRcdGlmIChyZXF1ZXN0LnZhbHVlKSB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IHsgYXR0cmlidXRlcyB9ID0gcGFyc2VBdHRyaWJ1dGVzKHJlcXVlc3QudmFsdWUpO1xuXHRcdFx0XHRcdFx0XHRjb25zdCB2YWx1ZSA9IHN0cmlwQXR0cmlidXRlcyhyZXF1ZXN0LnZhbHVlLnJlcGxhY2UoL1tcIiddL2csICcnKSk7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IGF0dHJpYnV0ZXNTdHJpbmcgPSBmb3JtYXRBdHRyaWJ1dGVzKGF0dHJpYnV0ZXMpO1xuXHRcdFx0XHRcdFx0XHRjb25zdCBrZXkgPSBbYXR0cmlidXRlc1N0cmluZywgdmFsdWVdLmpvaW4oJycpO1xuXHRcdFx0XHRcdFx0XHRpZiAodmFsdWUgJiYgIWFjYy5oYXMoa2V5KSkge1xuXHRcdFx0XHRcdFx0XHRcdGFjYy5zZXQoa2V5LCB7XG5cdFx0XHRcdFx0XHRcdFx0XHQuLi5yZXF1ZXN0LFxuXHRcdFx0XHRcdFx0XHRcdFx0Li4uYXR0cmlidXRlcyxcblx0XHRcdFx0XHRcdFx0XHRcdGF0dHJpYnV0ZXM6IGF0dHJpYnV0ZXNTdHJpbmcsXG5cdFx0XHRcdFx0XHRcdFx0XHR2YWx1ZSxcblx0XHRcdFx0XHRcdFx0XHRcdGtleVxuXHRcdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRyZXR1cm4gYWNjO1xuXHRcdFx0XHRcdH0sIG5ldyBNYXAoKSlcblx0XHRcdFx0XHQudmFsdWVzKClcblx0XHRcdCk7XG5cdFx0fSxcblx0XHRnZW5lcmF0ZShyZXNvdXJjZSwgb3B0aW9ucykge1xuXHRcdFx0Y29uc3QgcmVzdWx0ID0gY3NzLnN0cmluZ2lmeSh0aGlzLmFzdCwge1xuXHRcdFx0XHRpbnB1dFNvdXJjZW1hcHM6IHRydWUsXG5cdFx0XHRcdHNvdXJjZW1hcDogQm9vbGVhbihyZXNvdXJjZS5vcHRpb25zLnNvdXJjZU1hcHMgJiYgIXRoaXMuc291cmNlTWFwSlNPTiksXG5cdFx0XHRcdC4uLm9wdGlvbnNcblx0XHRcdH0pO1xuXHRcdFx0aWYgKHJlc3VsdC5tYXApIHtcblx0XHRcdFx0dGhpcy5zb3VyY2VNYXBKU09OID0ge1xuXHRcdFx0XHRcdC4uLnJlc3VsdC5tYXAsXG5cdFx0XHRcdFx0c291cmNlUm9vdDogdGhpcy5zb3VyY2VSb290XG5cdFx0XHRcdH07XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gYCR7cmVzdWx0LmNvZGUgfHwgcmVzdWx0fSR7dGhpcy5nZXRTb3VyY2VNYXBwaW5nVVJMKHJlc291cmNlKX1gO1xuXHRcdH0sXG5cdFx0c291cmNlTWFwcGluZ1VSTDogY29udGVudCA9PiBgLyojIHNvdXJjZU1hcHBpbmdVUkw9JHtjb250ZW50fSAqL2Bcblx0fSk7XG4iXX0=