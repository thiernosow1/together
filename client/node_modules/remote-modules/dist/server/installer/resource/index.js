"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.isNormal = isNormal;
exports.isNull = isNull;
exports.isExternal = isExternal;
exports.isResource = isResource;
exports.default = ResourceFactory;

var _path = _interopRequireDefault(require("path"));

var _bigInteger = _interopRequireDefault(require("big-integer"));

var _fs = require("../../../lib/helpers/fs");

var _helpers = require("../../../lib/helpers");

var _defineProperties = _interopRequireDefault(require("../../../lib/helpers/defineProperties"));

var _get = _interopRequireDefault(require("../../../lib/helpers/get"));

var _memoize = _interopRequireDefault(require("../../../lib/helpers/memoize"));

var _once = _interopRequireDefault(require("../../../lib/helpers/once"));

var _pick = _interopRequireDefault(require("../../../lib/helpers/pick"));

var _configStore = _interopRequireDefault(require("../../../lib/config-store"));

var _manifest = _interopRequireDefault(require("../../../lib/manifest"));

var _normal = _interopRequireDefault(require("./types/normal"));

var _null = _interopRequireDefault(require("./types/null"));

var _external = _interopRequireDefault(require("./types/external"));

var _context = _interopRequireWildcard(require("../context"));

var _union = _interopRequireDefault(require("../union"));

var _manifest2 = _interopRequireDefault(require("../generators/manifest"));

var _adapters = require("./adapters");

var _package = require("../../../../package.json");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function isNormal(resource) {
  return Boolean(resource) && resource.constructor === _normal.default;
}

function isNull(resource) {
  return Boolean(resource) && resource.constructor === _null.default;
}

function isExternal(resource) {
  return Boolean(resource) && resource.constructor === _external.default;
}

function isResource(value) {
  return isNormal(value) || isNull(value) || isExternal(value);
}

function ResourceFactory(options) {
  const contextFactory = new _context.default(options);
  const unionFactory = new _union.default(options);

  const C = _configStore.default.from(options);

  const outputPath = _path.default.join(C.outputDir, '.__resources__.json');

  const {
    logger
  } = C;
  const readPackage = (0, _memoize.default)(async resource => {
    const {
      resolved
    } = contextFactory('package.json', resource.getResolverPaths());
    const pkg = await (0, _fs.readJSONAsync)(resolved);
    return (0, _pick.default)(pkg, [...C.mainFields, 'version']);
  }, resource => resource.packageId);
  const createResource = (0, _memoize.default)(ctx => {
    const adapter = (0, _adapters.getAdapter)(C, ctx);
    const resourceOpts = {
      ctx,
      adapter,
      logger,
      contextFactory,
      unionFactory,
      // eslint-disable-next-line no-use-before-define
      resourceFactory: factory,
      options: (0, _helpers.omit)(C, ['logger'])
    };
    let resource;

    switch (true) {
      case ctx.isExternal():
        resource = new _external.default(resourceOpts);
        break;

      case ctx.isNull():
        resource = new _null.default(resourceOpts);
        break;

      default:
        resource = new _normal.default(resourceOpts);
        break;
    }

    return resource;
  }, ctx => `${ctx.origin}:${ctx.resolved}`);
  const applyRequestContext = (0, _memoize.default)(({
    ctx,
    parent,
    resource
  }) => {
    // Set async and run resource middleware once per context
    resource.setAsync(ctx.async || parent && parent.async);
    C.runMiddleware('resource', [resource, ctx]);
  }, ({
    ctx
  }) => ctx);

  async function generateManifest(resource) {
    const deepDependencySet = resource.getDeepDependencySet((dependency, request) => !request.async && dependency.isNormal());
    const meta = resource.getMeta();
    const packages = {
      [resource.packageId]: await readPackage(resource)
    };
    const deepDependencyArray = await Promise.all([...deepDependencySet].sort((a, b) => (0, _bigInteger.default)(b.index).compare((0, _bigInteger.default)(a.index))).map(async dependency => {
      if (!packages[dependency.packageId]) {
        packages[dependency.packageId] = await readPackage(dependency);
      }

      return dependency.getMeta();
    })); // Make sure packages are sorted alphabetically

    Object.keys(packages).sort((a, b) => a.localeCompare(b)).forEach(key => {
      const value = packages[key];
      delete packages[key];
      packages[key] = value;
    });
    const manifest = new _manifest.default(deepDependencyArray, {
      meta,
      packages
    });
    const manifestPath = (0, _context.getManifestPath)(resource.getOutputPath());
    await (0, _fs.mkdirpAsync)(resource.getOutputDir());
    return (0, _fs.writeFileAsync)(manifestPath, (0, _manifest2.default)(manifest));
  }

  async function getResourceJSON() {
    let json;

    try {
      json = await (0, _fs.readJSONAsync)(outputPath); // FIXME: Check semver range or use a dedicated cachefile version

      if (json.version !== _package.version) {
        json = null;
      }
    } catch (err) {
      if (err.code !== 'ENOENT') {
        throw err;
      }
    }

    return json || {
      map: {},
      cache: []
    };
  }

  function getResourceIndex(ctx, parent) {
    const requestIndex = parent ? parent.adapter.parser.requests.findIndex(({
      value
    }) => value === ctx.originalRequest) : 0;
    return requestIndex < 0 ? undefined : `${(0, _get.default)(parent, ['index']) || 1}0${requestIndex}`;
  }

  function factory(request = C.entry, parent) {
    let resource;
    let ctx;

    if (isResource(request)) {
      resource = request;
      ctx = contextFactory(resource.origin, parent && parent.getResolverPaths());
    } else {
      ctx = contextFactory(request, parent && parent.getResolverPaths());
      resource = createResource(ctx);
    }

    if (!resource.index) {
      resource.index = getResourceIndex(ctx, parent);
    }

    applyRequestContext({
      ctx,
      parent,
      resource
    });
    return resource;
  }

  return (0, _defineProperties.default)(factory, {
    name: 'ResourceFactory',
    outputPath,
    getResourceIndex,
    getResourceJSON,
    generateManifest,
    readPackage,
    isResource,
    isNormal,
    isNull,
    isExternal,
    contextFactory,
    unionFactory,
    failed: {
      value: false,
      writable: true
    },
    load: (0, _once.default)(async () => {
      const {
        cache
      } = await getResourceJSON();
      return cache.length ? factory.import(cache) : factory();
    }),

    import(exportJSON) {
      const resourceDataByModuleId = new Map();
      const hydratedResources = new Set();
      const missingRequests = new Set();
      const requestProcessors = [];
      exportJSON.forEach(data => {
        const {
          moduleId,
          slug,
          requests
        } = data;
        const origin = contextFactory.safeResolve(slug);
        const baseDir = origin && _path.default.isAbsolute(origin) ? _path.default.dirname(origin) : undefined; // The first element in exportJSON is the entrypoint

        if (data === exportJSON[0]) {
          const ctx = contextFactory(C.entry); // Make sure the cached entrypoint is the same as the resolved entrypoint

          if (moduleId === ctx.moduleId) {
            const resource = createResource(ctx).hydrate(data);
            hydratedResources.add(resource);
          } else {
            exportJSON.forEach(obj => {
              // eslint-disable-next-line no-param-reassign
              obj.index = undefined;
            });
          }
        }

        resourceDataByModuleId.set(moduleId, data);
        requestProcessors.push(() => {
          // Iterate over each resource's requests array
          requests.forEach(requestObject => {
            // Recreate and hydrate each dependency resource using the original request context
            const ctx = contextFactory(requestObject, [baseDir]);
            const resourceJSON = resourceDataByModuleId.get(ctx.moduleId);

            if (resourceJSON) {
              const resource = createResource(ctx).hydrate(resourceJSON);
              hydratedResources.add(resource);
            } else {
              missingRequests.add(requestObject);
            }
          });
        });
      }); // Process the requests for each resource

      requestProcessors.forEach(fn => fn()); // Rebuild the dependency graph

      hydratedResources.forEach(resource => {
        if (resourceDataByModuleId.has(resource.moduleId)) {
          const {
            requests
          } = resourceDataByModuleId.get(resource.moduleId);
          requests.forEach(requestObject => {
            const dependency = factory(requestObject, resource);
            resource.addDependency(requestObject, dependency);

            if (missingRequests.has(requestObject) && dependency.isNull()) {
              resource.removeFromUnion();
              resource.markDirty();
            }
          });
        }
      }); // return the entrypoint

      return factory();
    },

    export() {
      const entrypoint = factory();
      return [entrypoint, ...entrypoint.getDeepDependencySet()].sort((a, b) => (0, _bigInteger.default)(a.index).compare((0, _bigInteger.default)(b.index)));
    },

    uncache(query) {
      if (query) {
        for (const [key, resource] of createResource.cache) {
          if ((0, _helpers.matches)(resource, query)) {
            readPackage.cache.delete(readPackage.resolver(resource));
            createResource.cache.delete(key);
          }
        }
      } else {
        unionFactory.cache.clear();
        contextFactory.uncache();
        readPackage.cache.clear();
        createResource.cache.clear();
        factory.load.clear();
      }
    },

    async save() {
      const resources = factory.export();
      const moduleMap = resources.reduce((acc, resource) => {
        const outputSlug = resource.getOutputSlug();

        if (resource.slug !== outputSlug) {
          acc[resource.slug] = outputSlug;
        }

        return acc;
      }, {});
      const assetMap = resources.reduce((acc, resource) => {
        const outputSlug = resource.getOutputSlug();
        const assetId = resource.getAssetId();

        if (assetId && outputSlug !== assetId) {
          acc[outputSlug] = assetId;
        }

        return acc;
      }, {});
      await (0, _fs.mkdirpAsync)(C.outputDir);
      await (0, _fs.writeJSONAsync)(outputPath, {
        version: _package.version,
        modules: moduleMap,
        assets: assetMap,
        cache: resources
      });
    },

    async reset() {
      factory.uncache();
      await (0, _fs.rimrafAsync)(C.outputDir);
    }

  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9zZXJ2ZXIvaW5zdGFsbGVyL3Jlc291cmNlL2luZGV4LmpzIl0sIm5hbWVzIjpbImlzTm9ybWFsIiwicmVzb3VyY2UiLCJCb29sZWFuIiwiY29uc3RydWN0b3IiLCJOb3JtYWxSZXNvdXJjZSIsImlzTnVsbCIsIk51bGxSZXNvdXJjZSIsImlzRXh0ZXJuYWwiLCJFeHRlcm5hbFJlc291cmNlIiwiaXNSZXNvdXJjZSIsInZhbHVlIiwiUmVzb3VyY2VGYWN0b3J5Iiwib3B0aW9ucyIsImNvbnRleHRGYWN0b3J5IiwiQ29udGV4dEZhY3RvcnkiLCJ1bmlvbkZhY3RvcnkiLCJVbmlvbkZhY3RvcnkiLCJDIiwiQ29uZmlnU3RvcmUiLCJmcm9tIiwib3V0cHV0UGF0aCIsIlBhdGgiLCJqb2luIiwib3V0cHV0RGlyIiwibG9nZ2VyIiwicmVhZFBhY2thZ2UiLCJyZXNvbHZlZCIsImdldFJlc29sdmVyUGF0aHMiLCJwa2ciLCJtYWluRmllbGRzIiwicGFja2FnZUlkIiwiY3JlYXRlUmVzb3VyY2UiLCJjdHgiLCJhZGFwdGVyIiwicmVzb3VyY2VPcHRzIiwicmVzb3VyY2VGYWN0b3J5IiwiZmFjdG9yeSIsIm9yaWdpbiIsImFwcGx5UmVxdWVzdENvbnRleHQiLCJwYXJlbnQiLCJzZXRBc3luYyIsImFzeW5jIiwicnVuTWlkZGxld2FyZSIsImdlbmVyYXRlTWFuaWZlc3QiLCJkZWVwRGVwZW5kZW5jeVNldCIsImdldERlZXBEZXBlbmRlbmN5U2V0IiwiZGVwZW5kZW5jeSIsInJlcXVlc3QiLCJtZXRhIiwiZ2V0TWV0YSIsInBhY2thZ2VzIiwiZGVlcERlcGVuZGVuY3lBcnJheSIsIlByb21pc2UiLCJhbGwiLCJzb3J0IiwiYSIsImIiLCJpbmRleCIsImNvbXBhcmUiLCJtYXAiLCJPYmplY3QiLCJrZXlzIiwibG9jYWxlQ29tcGFyZSIsImZvckVhY2giLCJrZXkiLCJtYW5pZmVzdCIsIk1hbmlmZXN0IiwibWFuaWZlc3RQYXRoIiwiZ2V0T3V0cHV0UGF0aCIsImdldE91dHB1dERpciIsImdldFJlc291cmNlSlNPTiIsImpzb24iLCJ2ZXJzaW9uIiwicGFja2FnZVZlcnNpb24iLCJlcnIiLCJjb2RlIiwiY2FjaGUiLCJnZXRSZXNvdXJjZUluZGV4IiwicmVxdWVzdEluZGV4IiwicGFyc2VyIiwicmVxdWVzdHMiLCJmaW5kSW5kZXgiLCJvcmlnaW5hbFJlcXVlc3QiLCJ1bmRlZmluZWQiLCJlbnRyeSIsIm5hbWUiLCJmYWlsZWQiLCJ3cml0YWJsZSIsImxvYWQiLCJsZW5ndGgiLCJpbXBvcnQiLCJleHBvcnRKU09OIiwicmVzb3VyY2VEYXRhQnlNb2R1bGVJZCIsIk1hcCIsImh5ZHJhdGVkUmVzb3VyY2VzIiwiU2V0IiwibWlzc2luZ1JlcXVlc3RzIiwicmVxdWVzdFByb2Nlc3NvcnMiLCJkYXRhIiwibW9kdWxlSWQiLCJzbHVnIiwic2FmZVJlc29sdmUiLCJiYXNlRGlyIiwiaXNBYnNvbHV0ZSIsImRpcm5hbWUiLCJoeWRyYXRlIiwiYWRkIiwib2JqIiwic2V0IiwicHVzaCIsInJlcXVlc3RPYmplY3QiLCJyZXNvdXJjZUpTT04iLCJnZXQiLCJmbiIsImhhcyIsImFkZERlcGVuZGVuY3kiLCJyZW1vdmVGcm9tVW5pb24iLCJtYXJrRGlydHkiLCJleHBvcnQiLCJlbnRyeXBvaW50IiwidW5jYWNoZSIsInF1ZXJ5IiwiZGVsZXRlIiwicmVzb2x2ZXIiLCJjbGVhciIsInNhdmUiLCJyZXNvdXJjZXMiLCJtb2R1bGVNYXAiLCJyZWR1Y2UiLCJhY2MiLCJvdXRwdXRTbHVnIiwiZ2V0T3V0cHV0U2x1ZyIsImFzc2V0TWFwIiwiYXNzZXRJZCIsImdldEFzc2V0SWQiLCJtb2R1bGVzIiwiYXNzZXRzIiwicmVzZXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBRUE7O0FBRUE7O0FBT0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FB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O0FBU0EsWUFBTSxxQkFBWWhILENBQUMsQ0FBQ00sU0FBZCxDQUFOO0FBQ0EsWUFBTSx3QkFBZUgsVUFBZixFQUEyQjtBQUNoQ29ELFFBQUFBLE9BQU8sRUFBRUMsZ0JBRHVCO0FBRWhDOEQsUUFBQUEsT0FBTyxFQUFFUixTQUZ1QjtBQUdoQ1MsUUFBQUEsTUFBTSxFQUFFSixRQUh3QjtBQUloQ3hELFFBQUFBLEtBQUssRUFBRWtEO0FBSnlCLE9BQTNCLENBQU47QUFNQSxLQXZJK0I7O0FBd0loQyxVQUFNVyxLQUFOLEdBQWM7QUFDYnJHLE1BQUFBLE9BQU8sQ0FBQ29GLE9BQVI7QUFDQSxZQUFNLHFCQUFZdkcsQ0FBQyxDQUFDTSxTQUFkLENBQU47QUFDQTs7QUEzSStCLEdBQTFCLENBQVA7QUE2SUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IGJpZ0ludCBmcm9tICdiaWctaW50ZWdlcic7XG5cbmltcG9ydCB7XG5cdG1rZGlycEFzeW5jLFxuXHRyaW1yYWZBc3luYyxcblx0cmVhZEpTT05Bc3luYyxcblx0d3JpdGVKU09OQXN5bmMsXG5cdHdyaXRlRmlsZUFzeW5jXG59IGZyb20gJy4uLy4uLy4uL2xpYi9oZWxwZXJzL2ZzJztcbmltcG9ydCB7IG9taXQsIG1hdGNoZXMgfSBmcm9tICcuLi8uLi8uLi9saWIvaGVscGVycyc7XG5pbXBvcnQgZGVmaW5lUHJvcGVydGllcyBmcm9tICcuLi8uLi8uLi9saWIvaGVscGVycy9kZWZpbmVQcm9wZXJ0aWVzJztcbmltcG9ydCBnZXQgZnJvbSAnLi4vLi4vLi4vbGliL2hlbHBlcnMvZ2V0JztcbmltcG9ydCBtZW1vaXplIGZyb20gJy4uLy4uLy4uL2xpYi9oZWxwZXJzL21lbW9pemUnO1xuaW1wb3J0IG9uY2UgZnJvbSAnLi4vLi4vLi4vbGliL2hlbHBlcnMvb25jZSc7XG5pbXBvcnQgcGljayBmcm9tICcuLi8uLi8uLi9saWIvaGVscGVycy9waWNrJztcbmltcG9ydCBDb25maWdTdG9yZSBmcm9tICcuLi8uLi8uLi9saWIvY29uZmlnLXN0b3JlJztcbmltcG9ydCBNYW5pZmVzdCBmcm9tICcuLi8uLi8uLi9saWIvbWFuaWZlc3QnO1xuaW1wb3J0IE5vcm1hbFJlc291cmNlIGZyb20gJy4vdHlwZXMvbm9ybWFsJztcbmltcG9ydCBOdWxsUmVzb3VyY2UgZnJvbSAnLi90eXBlcy9udWxsJztcbmltcG9ydCBFeHRlcm5hbFJlc291cmNlIGZyb20gJy4vdHlwZXMvZXh0ZXJuYWwnO1xuaW1wb3J0IENvbnRleHRGYWN0b3J5LCB7IGdldE1hbmlmZXN0UGF0aCB9IGZyb20gJy4uL2NvbnRleHQnO1xuaW1wb3J0IFVuaW9uRmFjdG9yeSBmcm9tICcuLi91bmlvbic7XG5pbXBvcnQgbWFuaWZlc3RHZW5lcmF0b3IgZnJvbSAnLi4vZ2VuZXJhdG9ycy9tYW5pZmVzdCc7XG5pbXBvcnQgeyBnZXRBZGFwdGVyIH0gZnJvbSAnLi9hZGFwdGVycyc7XG5cbmltcG9ydCB7IHZlcnNpb24gYXMgcGFja2FnZVZlcnNpb24gfSBmcm9tICcuLi8uLi8uLi8uLi9wYWNrYWdlLmpzb24nO1xuXG5leHBvcnQgZnVuY3Rpb24gaXNOb3JtYWwocmVzb3VyY2UpIHtcblx0cmV0dXJuIEJvb2xlYW4ocmVzb3VyY2UpICYmIHJlc291cmNlLmNvbnN0cnVjdG9yID09PSBOb3JtYWxSZXNvdXJjZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzTnVsbChyZXNvdXJjZSkge1xuXHRyZXR1cm4gQm9vbGVhbihyZXNvdXJjZSkgJiYgcmVzb3VyY2UuY29uc3RydWN0b3IgPT09IE51bGxSZXNvdXJjZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRXh0ZXJuYWwocmVzb3VyY2UpIHtcblx0cmV0dXJuIEJvb2xlYW4ocmVzb3VyY2UpICYmIHJlc291cmNlLmNvbnN0cnVjdG9yID09PSBFeHRlcm5hbFJlc291cmNlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNSZXNvdXJjZSh2YWx1ZSkge1xuXHRyZXR1cm4gaXNOb3JtYWwodmFsdWUpIHx8IGlzTnVsbCh2YWx1ZSkgfHwgaXNFeHRlcm5hbCh2YWx1ZSk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIFJlc291cmNlRmFjdG9yeShvcHRpb25zKSB7XG5cdGNvbnN0IGNvbnRleHRGYWN0b3J5ID0gbmV3IENvbnRleHRGYWN0b3J5KG9wdGlvbnMpO1xuXHRjb25zdCB1bmlvbkZhY3RvcnkgPSBuZXcgVW5pb25GYWN0b3J5KG9wdGlvbnMpO1xuXHRjb25zdCBDID0gQ29uZmlnU3RvcmUuZnJvbShvcHRpb25zKTtcblx0Y29uc3Qgb3V0cHV0UGF0aCA9IFBhdGguam9pbihDLm91dHB1dERpciwgJy5fX3Jlc291cmNlc19fLmpzb24nKTtcblx0Y29uc3QgeyBsb2dnZXIgfSA9IEM7XG5cblx0Y29uc3QgcmVhZFBhY2thZ2UgPSBtZW1vaXplKGFzeW5jIHJlc291cmNlID0+IHtcblx0XHRjb25zdCB7IHJlc29sdmVkIH0gPSBjb250ZXh0RmFjdG9yeSgncGFja2FnZS5qc29uJywgcmVzb3VyY2UuZ2V0UmVzb2x2ZXJQYXRocygpKTtcblx0XHRjb25zdCBwa2cgPSBhd2FpdCByZWFkSlNPTkFzeW5jKHJlc29sdmVkKTtcblx0XHRyZXR1cm4gcGljayhwa2csIFsuLi5DLm1haW5GaWVsZHMsICd2ZXJzaW9uJ10pO1xuXHR9LCByZXNvdXJjZSA9PiByZXNvdXJjZS5wYWNrYWdlSWQpO1xuXG5cdGNvbnN0IGNyZWF0ZVJlc291cmNlID0gbWVtb2l6ZShjdHggPT4ge1xuXHRcdGNvbnN0IGFkYXB0ZXIgPSBnZXRBZGFwdGVyKEMsIGN0eCk7XG5cdFx0Y29uc3QgcmVzb3VyY2VPcHRzID0ge1xuXHRcdFx0Y3R4LFxuXHRcdFx0YWRhcHRlcixcblx0XHRcdGxvZ2dlcixcblx0XHRcdGNvbnRleHRGYWN0b3J5LFxuXHRcdFx0dW5pb25GYWN0b3J5LFxuXHRcdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVzZS1iZWZvcmUtZGVmaW5lXG5cdFx0XHRyZXNvdXJjZUZhY3Rvcnk6IGZhY3RvcnksXG5cdFx0XHRvcHRpb25zOiBvbWl0KEMsIFsnbG9nZ2VyJ10pXG5cdFx0fTtcblx0XHRsZXQgcmVzb3VyY2U7XG5cdFx0c3dpdGNoICh0cnVlKSB7XG5cdFx0XHRjYXNlIGN0eC5pc0V4dGVybmFsKCk6XG5cdFx0XHRcdHJlc291cmNlID0gbmV3IEV4dGVybmFsUmVzb3VyY2UocmVzb3VyY2VPcHRzKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIGN0eC5pc051bGwoKTpcblx0XHRcdFx0cmVzb3VyY2UgPSBuZXcgTnVsbFJlc291cmNlKHJlc291cmNlT3B0cyk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0cmVzb3VyY2UgPSBuZXcgTm9ybWFsUmVzb3VyY2UocmVzb3VyY2VPcHRzKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0fVxuXHRcdHJldHVybiByZXNvdXJjZTtcblx0fSwgY3R4ID0+IGAke2N0eC5vcmlnaW59OiR7Y3R4LnJlc29sdmVkfWApO1xuXG5cdGNvbnN0IGFwcGx5UmVxdWVzdENvbnRleHQgPSBtZW1vaXplKCh7IGN0eCwgcGFyZW50LCByZXNvdXJjZSB9KSA9PiB7XG5cdFx0Ly8gU2V0IGFzeW5jIGFuZCBydW4gcmVzb3VyY2UgbWlkZGxld2FyZSBvbmNlIHBlciBjb250ZXh0XG5cdFx0cmVzb3VyY2Uuc2V0QXN5bmMoY3R4LmFzeW5jIHx8IChwYXJlbnQgJiYgcGFyZW50LmFzeW5jKSk7XG5cdFx0Qy5ydW5NaWRkbGV3YXJlKCdyZXNvdXJjZScsIFtyZXNvdXJjZSwgY3R4XSk7XG5cdH0sICh7IGN0eCB9KSA9PiBjdHgpO1xuXG5cdGFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlTWFuaWZlc3QocmVzb3VyY2UpIHtcblx0XHRjb25zdCBkZWVwRGVwZW5kZW5jeVNldCA9IHJlc291cmNlLmdldERlZXBEZXBlbmRlbmN5U2V0KFxuXHRcdFx0KGRlcGVuZGVuY3ksIHJlcXVlc3QpID0+ICFyZXF1ZXN0LmFzeW5jICYmIGRlcGVuZGVuY3kuaXNOb3JtYWwoKVxuXHRcdCk7XG5cdFx0Y29uc3QgbWV0YSA9IHJlc291cmNlLmdldE1ldGEoKTtcblx0XHRjb25zdCBwYWNrYWdlcyA9IHtcblx0XHRcdFtyZXNvdXJjZS5wYWNrYWdlSWRdOiBhd2FpdCByZWFkUGFja2FnZShyZXNvdXJjZSlcblx0XHR9O1xuXHRcdGNvbnN0IGRlZXBEZXBlbmRlbmN5QXJyYXkgPSBhd2FpdCBQcm9taXNlLmFsbChcblx0XHRcdFsuLi5kZWVwRGVwZW5kZW5jeVNldF1cblx0XHRcdFx0LnNvcnQoKGEsIGIpID0+IGJpZ0ludChiLmluZGV4KS5jb21wYXJlKGJpZ0ludChhLmluZGV4KSkpXG5cdFx0XHRcdC5tYXAoYXN5bmMgZGVwZW5kZW5jeSA9PiB7XG5cdFx0XHRcdFx0aWYgKCFwYWNrYWdlc1tkZXBlbmRlbmN5LnBhY2thZ2VJZF0pIHtcblx0XHRcdFx0XHRcdHBhY2thZ2VzW2RlcGVuZGVuY3kucGFja2FnZUlkXSA9IGF3YWl0IHJlYWRQYWNrYWdlKGRlcGVuZGVuY3kpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRyZXR1cm4gZGVwZW5kZW5jeS5nZXRNZXRhKCk7XG5cdFx0XHRcdH0pXG5cdFx0KTtcblxuXHRcdC8vIE1ha2Ugc3VyZSBwYWNrYWdlcyBhcmUgc29ydGVkIGFscGhhYmV0aWNhbGx5XG5cdFx0T2JqZWN0LmtleXMocGFja2FnZXMpXG5cdFx0XHQuc29ydCgoYSwgYikgPT4gYS5sb2NhbGVDb21wYXJlKGIpKVxuXHRcdFx0LmZvckVhY2goa2V5ID0+IHtcblx0XHRcdFx0Y29uc3QgdmFsdWUgPSBwYWNrYWdlc1trZXldO1xuXHRcdFx0XHRkZWxldGUgcGFja2FnZXNba2V5XTtcblx0XHRcdFx0cGFja2FnZXNba2V5XSA9IHZhbHVlO1xuXHRcdFx0fSk7XG5cblx0XHRjb25zdCBtYW5pZmVzdCA9IG5ldyBNYW5pZmVzdChkZWVwRGVwZW5kZW5jeUFycmF5LCB7IG1ldGEsIHBhY2thZ2VzIH0pO1xuXHRcdGNvbnN0IG1hbmlmZXN0UGF0aCA9IGdldE1hbmlmZXN0UGF0aChyZXNvdXJjZS5nZXRPdXRwdXRQYXRoKCkpO1xuXHRcdGF3YWl0IG1rZGlycEFzeW5jKHJlc291cmNlLmdldE91dHB1dERpcigpKTtcblx0XHRyZXR1cm4gd3JpdGVGaWxlQXN5bmMobWFuaWZlc3RQYXRoLCBtYW5pZmVzdEdlbmVyYXRvcihtYW5pZmVzdCkpO1xuXHR9XG5cblx0YXN5bmMgZnVuY3Rpb24gZ2V0UmVzb3VyY2VKU09OKCkge1xuXHRcdGxldCBqc29uO1xuXHRcdHRyeSB7XG5cdFx0XHRqc29uID0gYXdhaXQgcmVhZEpTT05Bc3luYyhvdXRwdXRQYXRoKTtcblx0XHRcdC8vIEZJWE1FOiBDaGVjayBzZW12ZXIgcmFuZ2Ugb3IgdXNlIGEgZGVkaWNhdGVkIGNhY2hlZmlsZSB2ZXJzaW9uXG5cdFx0XHRpZiAoanNvbi52ZXJzaW9uICE9PSBwYWNrYWdlVmVyc2lvbikge1xuXHRcdFx0XHRqc29uID0gbnVsbDtcblx0XHRcdH1cblx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdGlmIChlcnIuY29kZSAhPT0gJ0VOT0VOVCcpIHtcblx0XHRcdFx0dGhyb3cgZXJyO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRyZXR1cm4ganNvbiB8fCB7IG1hcDoge30sIGNhY2hlOiBbXSB9O1xuXHR9XG5cblx0ZnVuY3Rpb24gZ2V0UmVzb3VyY2VJbmRleChjdHgsIHBhcmVudCkge1xuXHRcdGNvbnN0IHJlcXVlc3RJbmRleCA9IHBhcmVudFxuXHRcdFx0PyBwYXJlbnQuYWRhcHRlci5wYXJzZXIucmVxdWVzdHMuZmluZEluZGV4KCh7IHZhbHVlIH0pID0+IHZhbHVlID09PSBjdHgub3JpZ2luYWxSZXF1ZXN0KVxuXHRcdFx0OiAwO1xuXHRcdHJldHVybiByZXF1ZXN0SW5kZXggPCAwID8gdW5kZWZpbmVkIDogYCR7Z2V0KHBhcmVudCwgWydpbmRleCddKSB8fCAxfTAke3JlcXVlc3RJbmRleH1gO1xuXHR9XG5cblx0ZnVuY3Rpb24gZmFjdG9yeShyZXF1ZXN0ID0gQy5lbnRyeSwgcGFyZW50KSB7XG5cdFx0bGV0IHJlc291cmNlO1xuXHRcdGxldCBjdHg7XG5cblx0XHRpZiAoaXNSZXNvdXJjZShyZXF1ZXN0KSkge1xuXHRcdFx0cmVzb3VyY2UgPSByZXF1ZXN0O1xuXHRcdFx0Y3R4ID0gY29udGV4dEZhY3RvcnkocmVzb3VyY2Uub3JpZ2luLCBwYXJlbnQgJiYgcGFyZW50LmdldFJlc29sdmVyUGF0aHMoKSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGN0eCA9IGNvbnRleHRGYWN0b3J5KHJlcXVlc3QsIHBhcmVudCAmJiBwYXJlbnQuZ2V0UmVzb2x2ZXJQYXRocygpKTtcblx0XHRcdHJlc291cmNlID0gY3JlYXRlUmVzb3VyY2UoY3R4KTtcblx0XHR9XG5cblx0XHRpZiAoIXJlc291cmNlLmluZGV4KSB7XG5cdFx0XHRyZXNvdXJjZS5pbmRleCA9IGdldFJlc291cmNlSW5kZXgoY3R4LCBwYXJlbnQpO1xuXHRcdH1cblxuXHRcdGFwcGx5UmVxdWVzdENvbnRleHQoeyBjdHgsIHBhcmVudCwgcmVzb3VyY2UgfSk7XG5cblx0XHRyZXR1cm4gcmVzb3VyY2U7XG5cdH1cblxuXHRyZXR1cm4gZGVmaW5lUHJvcGVydGllcyhmYWN0b3J5LCB7XG5cdFx0bmFtZTogJ1Jlc291cmNlRmFjdG9yeScsXG5cdFx0b3V0cHV0UGF0aCxcblx0XHRnZXRSZXNvdXJjZUluZGV4LFxuXHRcdGdldFJlc291cmNlSlNPTixcblx0XHRnZW5lcmF0ZU1hbmlmZXN0LFxuXHRcdHJlYWRQYWNrYWdlLFxuXHRcdGlzUmVzb3VyY2UsXG5cdFx0aXNOb3JtYWwsXG5cdFx0aXNOdWxsLFxuXHRcdGlzRXh0ZXJuYWwsXG5cdFx0Y29udGV4dEZhY3RvcnksXG5cdFx0dW5pb25GYWN0b3J5LFxuXHRcdGZhaWxlZDoge1xuXHRcdFx0dmFsdWU6IGZhbHNlLFxuXHRcdFx0d3JpdGFibGU6IHRydWVcblx0XHR9LFxuXHRcdGxvYWQ6IG9uY2UoYXN5bmMgKCkgPT4ge1xuXHRcdFx0Y29uc3QgeyBjYWNoZSB9ID0gYXdhaXQgZ2V0UmVzb3VyY2VKU09OKCk7XG5cdFx0XHRyZXR1cm4gY2FjaGUubGVuZ3RoID8gZmFjdG9yeS5pbXBvcnQoY2FjaGUpIDogZmFjdG9yeSgpO1xuXHRcdH0pLFxuXHRcdGltcG9ydChleHBvcnRKU09OKSB7XG5cdFx0XHRjb25zdCByZXNvdXJjZURhdGFCeU1vZHVsZUlkID0gbmV3IE1hcCgpO1xuXHRcdFx0Y29uc3QgaHlkcmF0ZWRSZXNvdXJjZXMgPSBuZXcgU2V0KCk7XG5cdFx0XHRjb25zdCBtaXNzaW5nUmVxdWVzdHMgPSBuZXcgU2V0KCk7XG5cdFx0XHRjb25zdCByZXF1ZXN0UHJvY2Vzc29ycyA9IFtdO1xuXG5cdFx0XHRleHBvcnRKU09OLmZvckVhY2goZGF0YSA9PiB7XG5cdFx0XHRcdGNvbnN0IHsgbW9kdWxlSWQsIHNsdWcsIHJlcXVlc3RzIH0gPSBkYXRhO1xuXHRcdFx0XHRjb25zdCBvcmlnaW4gPSBjb250ZXh0RmFjdG9yeS5zYWZlUmVzb2x2ZShzbHVnKTtcblx0XHRcdFx0Y29uc3QgYmFzZURpciA9IG9yaWdpbiAmJiBQYXRoLmlzQWJzb2x1dGUob3JpZ2luKSA/IFBhdGguZGlybmFtZShvcmlnaW4pIDogdW5kZWZpbmVkO1xuXG5cdFx0XHRcdC8vIFRoZSBmaXJzdCBlbGVtZW50IGluIGV4cG9ydEpTT04gaXMgdGhlIGVudHJ5cG9pbnRcblx0XHRcdFx0aWYgKGRhdGEgPT09IGV4cG9ydEpTT05bMF0pIHtcblx0XHRcdFx0XHRjb25zdCBjdHggPSBjb250ZXh0RmFjdG9yeShDLmVudHJ5KTtcblx0XHRcdFx0XHQvLyBNYWtlIHN1cmUgdGhlIGNhY2hlZCBlbnRyeXBvaW50IGlzIHRoZSBzYW1lIGFzIHRoZSByZXNvbHZlZCBlbnRyeXBvaW50XG5cdFx0XHRcdFx0aWYgKG1vZHVsZUlkID09PSBjdHgubW9kdWxlSWQpIHtcblx0XHRcdFx0XHRcdGNvbnN0IHJlc291cmNlID0gY3JlYXRlUmVzb3VyY2UoY3R4KS5oeWRyYXRlKGRhdGEpO1xuXHRcdFx0XHRcdFx0aHlkcmF0ZWRSZXNvdXJjZXMuYWRkKHJlc291cmNlKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0ZXhwb3J0SlNPTi5mb3JFYWNoKG9iaiA9PiB7XG5cdFx0XHRcdFx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wYXJhbS1yZWFzc2lnblxuXHRcdFx0XHRcdFx0XHRvYmouaW5kZXggPSB1bmRlZmluZWQ7XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXNvdXJjZURhdGFCeU1vZHVsZUlkLnNldChtb2R1bGVJZCwgZGF0YSk7XG5cblx0XHRcdFx0cmVxdWVzdFByb2Nlc3NvcnMucHVzaCgoKSA9PiB7XG5cdFx0XHRcdFx0Ly8gSXRlcmF0ZSBvdmVyIGVhY2ggcmVzb3VyY2UncyByZXF1ZXN0cyBhcnJheVxuXHRcdFx0XHRcdHJlcXVlc3RzLmZvckVhY2gocmVxdWVzdE9iamVjdCA9PiB7XG5cdFx0XHRcdFx0XHQvLyBSZWNyZWF0ZSBhbmQgaHlkcmF0ZSBlYWNoIGRlcGVuZGVuY3kgcmVzb3VyY2UgdXNpbmcgdGhlIG9yaWdpbmFsIHJlcXVlc3QgY29udGV4dFxuXHRcdFx0XHRcdFx0Y29uc3QgY3R4ID0gY29udGV4dEZhY3RvcnkocmVxdWVzdE9iamVjdCwgW2Jhc2VEaXJdKTtcblx0XHRcdFx0XHRcdGNvbnN0IHJlc291cmNlSlNPTiA9IHJlc291cmNlRGF0YUJ5TW9kdWxlSWQuZ2V0KGN0eC5tb2R1bGVJZCk7XG5cdFx0XHRcdFx0XHRpZiAocmVzb3VyY2VKU09OKSB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IHJlc291cmNlID0gY3JlYXRlUmVzb3VyY2UoY3R4KS5oeWRyYXRlKHJlc291cmNlSlNPTik7XG5cdFx0XHRcdFx0XHRcdGh5ZHJhdGVkUmVzb3VyY2VzLmFkZChyZXNvdXJjZSk7XG5cdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRtaXNzaW5nUmVxdWVzdHMuYWRkKHJlcXVlc3RPYmplY3QpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9KTtcblx0XHRcdH0pO1xuXG5cdFx0XHQvLyBQcm9jZXNzIHRoZSByZXF1ZXN0cyBmb3IgZWFjaCByZXNvdXJjZVxuXHRcdFx0cmVxdWVzdFByb2Nlc3NvcnMuZm9yRWFjaChmbiA9PiBmbigpKTtcblxuXHRcdFx0Ly8gUmVidWlsZCB0aGUgZGVwZW5kZW5jeSBncmFwaFxuXHRcdFx0aHlkcmF0ZWRSZXNvdXJjZXMuZm9yRWFjaChyZXNvdXJjZSA9PiB7XG5cdFx0XHRcdGlmIChyZXNvdXJjZURhdGFCeU1vZHVsZUlkLmhhcyhyZXNvdXJjZS5tb2R1bGVJZCkpIHtcblx0XHRcdFx0XHRjb25zdCB7IHJlcXVlc3RzIH0gPSByZXNvdXJjZURhdGFCeU1vZHVsZUlkLmdldChyZXNvdXJjZS5tb2R1bGVJZCk7XG5cdFx0XHRcdFx0cmVxdWVzdHMuZm9yRWFjaChyZXF1ZXN0T2JqZWN0ID0+IHtcblx0XHRcdFx0XHRcdGNvbnN0IGRlcGVuZGVuY3kgPSBmYWN0b3J5KHJlcXVlc3RPYmplY3QsIHJlc291cmNlKTtcblx0XHRcdFx0XHRcdHJlc291cmNlLmFkZERlcGVuZGVuY3kocmVxdWVzdE9iamVjdCwgZGVwZW5kZW5jeSk7XG5cdFx0XHRcdFx0XHRpZiAobWlzc2luZ1JlcXVlc3RzLmhhcyhyZXF1ZXN0T2JqZWN0KSAmJiBkZXBlbmRlbmN5LmlzTnVsbCgpKSB7XG5cdFx0XHRcdFx0XHRcdHJlc291cmNlLnJlbW92ZUZyb21VbmlvbigpO1xuXHRcdFx0XHRcdFx0XHRyZXNvdXJjZS5tYXJrRGlydHkoKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cblx0XHRcdC8vIHJldHVybiB0aGUgZW50cnlwb2ludFxuXHRcdFx0cmV0dXJuIGZhY3RvcnkoKTtcblx0XHR9LFxuXHRcdGV4cG9ydCgpIHtcblx0XHRcdGNvbnN0IGVudHJ5cG9pbnQgPSBmYWN0b3J5KCk7XG5cdFx0XHRyZXR1cm4gW2VudHJ5cG9pbnQsIC4uLmVudHJ5cG9pbnQuZ2V0RGVlcERlcGVuZGVuY3lTZXQoKV0uc29ydCgoYSwgYikgPT5cblx0XHRcdFx0YmlnSW50KGEuaW5kZXgpLmNvbXBhcmUoYmlnSW50KGIuaW5kZXgpKVxuXHRcdFx0KTtcblx0XHR9LFxuXHRcdHVuY2FjaGUocXVlcnkpIHtcblx0XHRcdGlmIChxdWVyeSkge1xuXHRcdFx0XHRmb3IgKGNvbnN0IFtrZXksIHJlc291cmNlXSBvZiBjcmVhdGVSZXNvdXJjZS5jYWNoZSkge1xuXHRcdFx0XHRcdGlmIChtYXRjaGVzKHJlc291cmNlLCBxdWVyeSkpIHtcblx0XHRcdFx0XHRcdHJlYWRQYWNrYWdlLmNhY2hlLmRlbGV0ZShyZWFkUGFja2FnZS5yZXNvbHZlcihyZXNvdXJjZSkpO1xuXHRcdFx0XHRcdFx0Y3JlYXRlUmVzb3VyY2UuY2FjaGUuZGVsZXRlKGtleSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR1bmlvbkZhY3RvcnkuY2FjaGUuY2xlYXIoKTtcblx0XHRcdFx0Y29udGV4dEZhY3RvcnkudW5jYWNoZSgpO1xuXHRcdFx0XHRyZWFkUGFja2FnZS5jYWNoZS5jbGVhcigpO1xuXHRcdFx0XHRjcmVhdGVSZXNvdXJjZS5jYWNoZS5jbGVhcigpO1xuXHRcdFx0XHRmYWN0b3J5LmxvYWQuY2xlYXIoKTtcblx0XHRcdH1cblx0XHR9LFxuXHRcdGFzeW5jIHNhdmUoKSB7XG5cdFx0XHRjb25zdCByZXNvdXJjZXMgPSBmYWN0b3J5LmV4cG9ydCgpO1xuXG5cdFx0XHRjb25zdCBtb2R1bGVNYXAgPSByZXNvdXJjZXMucmVkdWNlKChhY2MsIHJlc291cmNlKSA9PiB7XG5cdFx0XHRcdGNvbnN0IG91dHB1dFNsdWcgPSByZXNvdXJjZS5nZXRPdXRwdXRTbHVnKCk7XG5cdFx0XHRcdGlmIChyZXNvdXJjZS5zbHVnICE9PSBvdXRwdXRTbHVnKSB7XG5cdFx0XHRcdFx0YWNjW3Jlc291cmNlLnNsdWddID0gb3V0cHV0U2x1Zztcblx0XHRcdFx0fVxuXHRcdFx0XHRyZXR1cm4gYWNjO1xuXHRcdFx0fSwge30pO1xuXG5cdFx0XHRjb25zdCBhc3NldE1hcCA9IHJlc291cmNlcy5yZWR1Y2UoKGFjYywgcmVzb3VyY2UpID0+IHtcblx0XHRcdFx0Y29uc3Qgb3V0cHV0U2x1ZyA9IHJlc291cmNlLmdldE91dHB1dFNsdWcoKTtcblx0XHRcdFx0Y29uc3QgYXNzZXRJZCA9IHJlc291cmNlLmdldEFzc2V0SWQoKTtcblx0XHRcdFx0aWYgKGFzc2V0SWQgJiYgb3V0cHV0U2x1ZyAhPT0gYXNzZXRJZCkge1xuXHRcdFx0XHRcdGFjY1tvdXRwdXRTbHVnXSA9IGFzc2V0SWQ7XG5cdFx0XHRcdH1cblx0XHRcdFx0cmV0dXJuIGFjYztcblx0XHRcdH0sIHt9KTtcblxuXHRcdFx0YXdhaXQgbWtkaXJwQXN5bmMoQy5vdXRwdXREaXIpO1xuXHRcdFx0YXdhaXQgd3JpdGVKU09OQXN5bmMob3V0cHV0UGF0aCwge1xuXHRcdFx0XHR2ZXJzaW9uOiBwYWNrYWdlVmVyc2lvbixcblx0XHRcdFx0bW9kdWxlczogbW9kdWxlTWFwLFxuXHRcdFx0XHRhc3NldHM6IGFzc2V0TWFwLFxuXHRcdFx0XHRjYWNoZTogcmVzb3VyY2VzXG5cdFx0XHR9KTtcblx0XHR9LFxuXHRcdGFzeW5jIHJlc2V0KCkge1xuXHRcdFx0ZmFjdG9yeS51bmNhY2hlKCk7XG5cdFx0XHRhd2FpdCByaW1yYWZBc3luYyhDLm91dHB1dERpcik7XG5cdFx0fVxuXHR9KTtcbn1cbiJdfQ==