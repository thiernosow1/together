"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _util = require("util");

var _defineProperties = _interopRequireDefault(require("../../../../lib/helpers/defineProperties"));

var _helpers = require("../../../../lib/helpers");

var _urlBuilder = require("../../../../lib/url-builder");

var _resolver = require("../../../../lib/resolver");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class SourceContext extends Map {
  constructor(requestObject, baseDir, factory, C) {
    const {
      value: originalRequest
    } = requestObject;
    super([['dirty', false], ['error', undefined], ['external', undefined], ['force', undefined], ['request', undefined], ['resolved', undefined]]);
    (0, _defineProperties.default)(this, {
      baseDir,
      C,
      factory,
      originalRequest
    });
    this.request = requestObject.value;
    this.requestObject = requestObject;
  }

  get async() {
    return Boolean(this.requestObject.async);
  }

  get dirty() {
    return this.get('dirty');
  }

  get error() {
    return this.get('error');
  }

  get extension() {
    return this.resolved && _path.default.extname(this.origin);
  }

  get force() {
    return this.get('force');
  }

  get moduleId() {
    if (this.force !== undefined) {
      return this.force;
    }

    const {
      factory,
      origin,
      resolved,
      slug
    } = this;
    return resolved ? factory.getModuleId(slug) : origin;
  }

  get origin() {
    return this.resolved || this.originalRequest;
  }

  get packageId() {
    const {
      factory,
      moduleId,
      resolved
    } = this;
    return resolved && factory.getPackageId(moduleId);
  }

  get pid() {
    return this.factory.getPid(this.moduleId);
  }

  get request() {
    return this.get('request');
  }

  get resolved() {
    return this.get('resolved') || null;
  }

  get slug() {
    const {
      factory,
      origin,
      resolved
    } = this;
    return resolved ? factory.getSlug(origin) : origin;
  }

  get url() {
    const {
      C,
      moduleId,
      requestObject
    } = this;

    switch (true) {
      case this.isExternal():
        return moduleId;

      case requestObject.static:
        return _path.default.join(C.getRoot().server.publicPath, '@static', moduleId);

      default:
        return (0, _urlBuilder.assembleResourceURL)(C.server.publicPath, moduleId);
    }
  }

  set external(value) {
    if (this.get('external') !== value) {
      this.set('external', value);
    }
  }

  set force(value) {
    if (this.get('force') !== value) {
      this.set('force', value);
      this.request = value;
    }
  }

  set request(value) {
    if (this.get('request') !== value) {
      this.set('request', value);
      this.resolved = value;
    }
  }

  set resolved(value) {
    if (this.get('force') === undefined && this.get('resolved') !== value) {
      try {
        this.set('resolved', this.factory.resolve(value, this.baseDir));
        this.set('error', null);
      } catch (err) {
        this.set('resolved', undefined);
        this.set('error', err);
      }
    }
  }

  digest() {
    const dirty = this.get('dirty');
    this.set('dirty', false);
    return dirty;
  }

  set(key, value) {
    super.set('dirty', true);
    super.set(key, value);
  }

  isExternal() {
    return this.get('external') !== undefined ? this.get('external') : (0, _resolver.isCore)(this.resolved) || (0, _helpers.isAbsoluteURL)(this.resolved);
  }

  isNull() {
    return this.resolved === null;
  }

  isNormal() {
    return !this.isExternal() && !this.isNull();
  }

  inspect() {
    const descriptors = _objectSpread({}, Object.getOwnPropertyDescriptors(SourceContext.prototype), Object.getOwnPropertyDescriptors(this));

    const result = {};

    for (const [key, {
      value
    }] of Object.entries(descriptors)) {
      switch (true) {
        case key === 'C':
          // noop
          break;

        case key === 'error':
          result.error = this.error && this.error.message;
          break;

        case typeof value !== 'function':
          try {
            result[key] = this[key];
          } catch (err) {
            result[key] = err;
          }

          break;

        default:
          // noop
          break;
      }
    }

    return (0, _util.inspect)(result, {
      colors: true
    });
  }

}

exports.default = SourceContext;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9zZXJ2ZXIvaW5zdGFsbGVyL2NvbnRleHQvdHlwZXMvc291cmNlLmpzIl0sIm5hbWVzIjpbIlNvdXJjZUNvbnRleHQiLCJNYXAiLCJjb25zdHJ1Y3RvciIsInJlcXVlc3RPYmplY3QiLCJiYXNlRGlyIiwiZmFjdG9yeSIsIkMiLCJ2YWx1ZSIsIm9yaWdpbmFsUmVxdWVzdCIsInVuZGVmaW5lZCIsInJlcXVlc3QiLCJhc3luYyIsIkJvb2xlYW4iLCJkaXJ0eSIsImdldCIsImVycm9yIiwiZXh0ZW5zaW9uIiwicmVzb2x2ZWQiLCJQYXRoIiwiZXh0bmFtZSIsIm9yaWdpbiIsImZvcmNlIiwibW9kdWxlSWQiLCJzbHVnIiwiZ2V0TW9kdWxlSWQiLCJwYWNrYWdlSWQiLCJnZXRQYWNrYWdlSWQiLCJwaWQiLCJnZXRQaWQiLCJnZXRTbHVnIiwidXJsIiwiaXNFeHRlcm5hbCIsInN0YXRpYyIsImpvaW4iLCJnZXRSb290Iiwic2VydmVyIiwicHVibGljUGF0aCIsImV4dGVybmFsIiwic2V0IiwicmVzb2x2ZSIsImVyciIsImRpZ2VzdCIsImtleSIsImlzTnVsbCIsImlzTm9ybWFsIiwiaW5zcGVjdCIsImRlc2NyaXB0b3JzIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyIsInByb3RvdHlwZSIsInJlc3VsdCIsImVudHJpZXMiLCJtZXNzYWdlIiwiY29sb3JzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBRWUsTUFBTUEsYUFBTixTQUE0QkMsR0FBNUIsQ0FBZ0M7QUFDOUNDLEVBQUFBLFdBQVcsQ0FBQ0MsYUFBRCxFQUFnQkMsT0FBaEIsRUFBeUJDLE9BQXpCLEVBQWtDQyxDQUFsQyxFQUFxQztBQUMvQyxVQUFNO0FBQUVDLE1BQUFBLEtBQUssRUFBRUM7QUFBVCxRQUE2QkwsYUFBbkM7QUFFQSxVQUFNLENBQ0wsQ0FBQyxPQUFELEVBQVUs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QUFOLENBQVgsSUFBK0J3QyxNQUFNLENBQUNJLE9BQVAsQ0FBZUwsV0FBZixDQUEvQixFQUE0RDtBQUMzRCxjQUFRLElBQVI7QUFDQyxhQUFLSixHQUFHLEtBQUssR0FBYjtBQUNDO0FBQ0E7O0FBQ0QsYUFBS0EsR0FBRyxLQUFLLE9BQWI7QUFDQ1EsVUFBQUEsTUFBTSxDQUFDbkMsS0FBUCxHQUFlLEtBQUtBLEtBQUwsSUFBYyxLQUFLQSxLQUFMLENBQVdxQyxPQUF4QztBQUNBOztBQUNELGFBQUssT0FBTzdDLEtBQVAsS0FBaUIsVUFBdEI7QUFDQyxjQUFJO0FBQ0gyQyxZQUFBQSxNQUFNLENBQUNSLEdBQUQsQ0FBTixHQUFjLEtBQUtBLEdBQUwsQ0FBZDtBQUNBLFdBRkQsQ0FFRSxPQUFPRixHQUFQLEVBQVk7QUFDYlUsWUFBQUEsTUFBTSxDQUFDUixHQUFELENBQU4sR0FBY0YsR0FBZDtBQUNBOztBQUNEOztBQUNEO0FBQ0M7QUFDQTtBQWhCRjtBQWtCQTs7QUFDRCxXQUFPLG1CQUFRVSxNQUFSLEVBQWdCO0FBQUVHLE1BQUFBLE1BQU0sRUFBRTtBQUFWLEtBQWhCLENBQVA7QUFDQTs7QUF6SzZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBpbnNwZWN0IH0gZnJvbSAndXRpbCc7XG5cbmltcG9ydCBkZWZpbmVQcm9wZXJ0aWVzIGZyb20gJy4uLy4uLy4uLy4uL2xpYi9oZWxwZXJzL2RlZmluZVByb3BlcnRpZXMnO1xuaW1wb3J0IHsgaXNBYnNvbHV0ZVVSTCB9IGZyb20gJy4uLy4uLy4uLy4uL2xpYi9oZWxwZXJzJztcbmltcG9ydCB7IGFzc2VtYmxlUmVzb3VyY2VVUkwgfSBmcm9tICcuLi8uLi8uLi8uLi9saWIvdXJsLWJ1aWxkZXInO1xuaW1wb3J0IHsgaXNDb3JlIH0gZnJvbSAnLi4vLi4vLi4vLi4vbGliL3Jlc29sdmVyJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU291cmNlQ29udGV4dCBleHRlbmRzIE1hcCB7XG5cdGNvbnN0cnVjdG9yKHJlcXVlc3RPYmplY3QsIGJhc2VEaXIsIGZhY3RvcnksIEMpIHtcblx0XHRjb25zdCB7IHZhbHVlOiBvcmlnaW5hbFJlcXVlc3QgfSA9IHJlcXVlc3RPYmplY3Q7XG5cblx0XHRzdXBlcihbXG5cdFx0XHRbJ2RpcnR5JywgZmFsc2VdLFxuXHRcdFx0WydlcnJvcicsIHVuZGVmaW5lZF0sXG5cdFx0XHRbJ2V4dGVybmFsJywgdW5kZWZpbmVkXSxcblx0XHRcdFsnZm9yY2UnLCB1bmRlZmluZWRdLFxuXHRcdFx0WydyZXF1ZXN0JywgdW5kZWZpbmVkXSxcblx0XHRcdFsncmVzb2x2ZWQnLCB1bmRlZmluZWRdXG5cdFx0XSk7XG5cblx0XHRkZWZpbmVQcm9wZXJ0aWVzKHRoaXMsIHsgYmFzZURpciwgQywgZmFjdG9yeSwgb3JpZ2luYWxSZXF1ZXN0IH0pO1xuXG5cdFx0dGhpcy5yZXF1ZXN0ID0gcmVxdWVzdE9iamVjdC52YWx1ZTtcblx0XHR0aGlzLnJlcXVlc3RPYmplY3QgPSByZXF1ZXN0T2JqZWN0O1xuXHR9XG5cblx0Z2V0IGFzeW5jKCkge1xuXHRcdHJldHVybiBCb29sZWFuKHRoaXMucmVxdWVzdE9iamVjdC5hc3luYyk7XG5cdH1cblxuXHRnZXQgZGlydHkoKSB7XG5cdFx0cmV0dXJuIHRoaXMuZ2V0KCdkaXJ0eScpO1xuXHR9XG5cblx0Z2V0IGVycm9yKCkge1xuXHRcdHJldHVybiB0aGlzLmdldCgnZXJyb3InKTtcblx0fVxuXG5cdGdldCBleHRlbnNpb24oKSB7XG5cdFx0cmV0dXJuIHRoaXMucmVzb2x2ZWQgJiYgUGF0aC5leHRuYW1lKHRoaXMub3JpZ2luKTtcblx0fVxuXG5cdGdldCBmb3JjZSgpIHtcblx0XHRyZXR1cm4gdGhpcy5nZXQoJ2ZvcmNlJyk7XG5cdH1cblxuXHRnZXQgbW9kdWxlSWQoKSB7XG5cdFx0aWYgKHRoaXMuZm9yY2UgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0cmV0dXJuIHRoaXMuZm9yY2U7XG5cdFx0fVxuXHRcdGNvbnN0IHsgZmFjdG9yeSwgb3JpZ2luLCByZXNvbHZlZCwgc2x1ZyB9ID0gdGhpcztcblx0XHRyZXR1cm4gcmVzb2x2ZWQgPyBmYWN0b3J5LmdldE1vZHVsZUlkKHNsdWcpIDogb3JpZ2luO1xuXHR9XG5cblx0Z2V0IG9yaWdpbigpIHtcblx0XHRyZXR1cm4gdGhpcy5yZXNvbHZlZCB8fCB0aGlzLm9yaWdpbmFsUmVxdWVzdDtcblx0fVxuXG5cdGdldCBwYWNrYWdlSWQoKSB7XG5cdFx0Y29uc3QgeyBmYWN0b3J5LCBtb2R1bGVJZCwgcmVzb2x2ZWQgfSA9IHRoaXM7XG5cdFx0cmV0dXJuIHJlc29sdmVkICYmIGZhY3RvcnkuZ2V0UGFja2FnZUlkKG1vZHVsZUlkKTtcblx0fVxuXG5cdGdldCBwaWQoKSB7XG5cdFx0cmV0dXJuIHRoaXMuZmFjdG9yeS5nZXRQaWQodGhpcy5tb2R1bGVJZCk7XG5cdH1cblxuXHRnZXQgcmVxdWVzdCgpIHtcblx0XHRyZXR1cm4gdGhpcy5nZXQoJ3JlcXVlc3QnKTtcblx0fVxuXG5cdGdldCByZXNvbHZlZCgpIHtcblx0XHRyZXR1cm4gdGhpcy5nZXQoJ3Jlc29sdmVkJykgfHwgbnVsbDtcblx0fVxuXG5cdGdldCBzbHVnKCkge1xuXHRcdGNvbnN0IHsgZmFjdG9yeSwgb3JpZ2luLCByZXNvbHZlZCB9ID0gdGhpcztcblx0XHRyZXR1cm4gcmVzb2x2ZWQgPyBmYWN0b3J5LmdldFNsdWcob3JpZ2luKSA6IG9yaWdpbjtcblx0fVxuXG5cdGdldCB1cmwoKSB7XG5cdFx0Y29uc3QgeyBDLCBtb2R1bGVJZCwgcmVxdWVzdE9iamVjdCB9ID0gdGhpcztcblx0XHRzd2l0Y2ggKHRydWUpIHtcblx0XHRcdGNhc2UgdGhpcy5pc0V4dGVybmFsKCk6XG5cdFx0XHRcdHJldHVybiBtb2R1bGVJZDtcblx0XHRcdGNhc2UgcmVxdWVzdE9iamVjdC5zdGF0aWM6XG5cdFx0XHRcdHJldHVybiBQYXRoLmpvaW4oQy5nZXRSb290KCkuc2VydmVyLnB1YmxpY1BhdGgsICdAc3RhdGljJywgbW9kdWxlSWQpO1xuXHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0cmV0dXJuIGFzc2VtYmxlUmVzb3VyY2VVUkwoQy5zZXJ2ZXIucHVibGljUGF0aCwgbW9kdWxlSWQpO1xuXHRcdH1cblx0fVxuXG5cdHNldCBleHRlcm5hbCh2YWx1ZSkge1xuXHRcdGlmICh0aGlzLmdldCgnZXh0ZXJuYWwnKSAhPT0gdmFsdWUpIHtcblx0XHRcdHRoaXMuc2V0KCdleHRlcm5hbCcsIHZhbHVlKTtcblx0XHR9XG5cdH1cblxuXHRzZXQgZm9yY2UodmFsdWUpIHtcblx0XHRpZiAodGhpcy5nZXQoJ2ZvcmNlJykgIT09IHZhbHVlKSB7XG5cdFx0XHR0aGlzLnNldCgnZm9yY2UnLCB2YWx1ZSk7XG5cdFx0XHR0aGlzLnJlcXVlc3QgPSB2YWx1ZTtcblx0XHR9XG5cdH1cblxuXHRzZXQgcmVxdWVzdCh2YWx1ZSkge1xuXHRcdGlmICh0aGlzLmdldCgncmVxdWVzdCcpICE9PSB2YWx1ZSkge1xuXHRcdFx0dGhpcy5zZXQoJ3JlcXVlc3QnLCB2YWx1ZSk7XG5cdFx0XHR0aGlzLnJlc29sdmVkID0gdmFsdWU7XG5cdFx0fVxuXHR9XG5cblx0c2V0IHJlc29sdmVkKHZhbHVlKSB7XG5cdFx0aWYgKHRoaXMuZ2V0KCdmb3JjZScpID09PSB1bmRlZmluZWQgJiYgdGhpcy5nZXQoJ3Jlc29sdmVkJykgIT09IHZhbHVlKSB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHR0aGlzLnNldCgncmVzb2x2ZWQnLCB0aGlzLmZhY3RvcnkucmVzb2x2ZSh2YWx1ZSwgdGhpcy5iYXNlRGlyKSk7XG5cdFx0XHRcdHRoaXMuc2V0KCdlcnJvcicsIG51bGwpO1xuXHRcdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRcdHRoaXMuc2V0KCdyZXNvbHZlZCcsIHVuZGVmaW5lZCk7XG5cdFx0XHRcdHRoaXMuc2V0KCdlcnJvcicsIGVycik7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0ZGlnZXN0KCkge1xuXHRcdGNvbnN0IGRpcnR5ID0gdGhpcy5nZXQoJ2RpcnR5Jyk7XG5cdFx0dGhpcy5zZXQoJ2RpcnR5JywgZmFsc2UpO1xuXHRcdHJldHVybiBkaXJ0eTtcblx0fVxuXG5cdHNldChrZXksIHZhbHVlKSB7XG5cdFx0c3VwZXIuc2V0KCdkaXJ0eScsIHRydWUpO1xuXHRcdHN1cGVyLnNldChrZXksIHZhbHVlKTtcblx0fVxuXG5cdGlzRXh0ZXJuYWwoKSB7XG5cdFx0cmV0dXJuIHRoaXMuZ2V0KCdleHRlcm5hbCcpICE9PSB1bmRlZmluZWRcblx0XHRcdD8gdGhpcy5nZXQoJ2V4dGVybmFsJylcblx0XHRcdDogaXNDb3JlKHRoaXMucmVzb2x2ZWQpIHx8IGlzQWJzb2x1dGVVUkwodGhpcy5yZXNvbHZlZCk7XG5cdH1cblxuXHRpc051bGwoKSB7XG5cdFx0cmV0dXJuIHRoaXMucmVzb2x2ZWQgPT09IG51bGw7XG5cdH1cblxuXHRpc05vcm1hbCgpIHtcblx0XHRyZXR1cm4gIXRoaXMuaXNFeHRlcm5hbCgpICYmICF0aGlzLmlzTnVsbCgpO1xuXHR9XG5cblx0aW5zcGVjdCgpIHtcblx0XHRjb25zdCBkZXNjcmlwdG9ycyA9IHtcblx0XHRcdC4uLk9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKFNvdXJjZUNvbnRleHQucHJvdG90eXBlKSxcblx0XHRcdC4uLk9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHRoaXMpXG5cdFx0fTtcblx0XHRjb25zdCByZXN1bHQgPSB7fTtcblx0XHRmb3IgKGNvbnN0IFtrZXksIHsgdmFsdWUgfV0gb2YgT2JqZWN0LmVudHJpZXMoZGVzY3JpcHRvcnMpKSB7XG5cdFx0XHRzd2l0Y2ggKHRydWUpIHtcblx0XHRcdFx0Y2FzZSBrZXkgPT09ICdDJzpcblx0XHRcdFx0XHQvLyBub29wXG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdGNhc2Uga2V5ID09PSAnZXJyb3InOlxuXHRcdFx0XHRcdHJlc3VsdC5lcnJvciA9IHRoaXMuZXJyb3IgJiYgdGhpcy5lcnJvci5tZXNzYWdlO1xuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRjYXNlIHR5cGVvZiB2YWx1ZSAhPT0gJ2Z1bmN0aW9uJzpcblx0XHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdFx0cmVzdWx0W2tleV0gPSB0aGlzW2tleV07XG5cdFx0XHRcdFx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0XHRcdFx0XHRyZXN1bHRba2V5XSA9IGVycjtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdFx0Ly8gbm9vcFxuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRyZXR1cm4gaW5zcGVjdChyZXN1bHQsIHsgY29sb3JzOiB0cnVlIH0pO1xuXHR9XG59XG4iXX0=