"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _crypto = require("crypto");

var _objectHash = _interopRequireDefault(require("object-hash"));

var _bigInteger = _interopRequireDefault(require("big-integer"));

var _defineProperties = _interopRequireDefault(require("../../../lib/helpers/defineProperties"));

var _once = _interopRequireDefault(require("../../../lib/helpers/once"));

var _context = require("../context");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function md5(value) {
  return (0, _crypto.createHash)('md5').update(value).digest('hex');
}

class Union extends Set {
  constructor(id, {
    writer,
    options
  }) {
    super();

    _defineProperty(this, "bytes", (0, _once.default)(() => [...this].reduce((acc, resource) => acc + resource.size, 0)));

    this.id = id;
    (0, _defineProperties.default)(this, {
      bytes: {
        writable: true
      },
      options: _objectSpread({
        minSize: 5e4,
        maxSize: 10e4
      }, options),
      pending: new Set(),
      slugs: new Map(),
      writer
    });
  }

  reset(resource) {
    this.slugs.delete(resource);
    this.pending.delete(resource);
    this.delete(resource);
    this.add(resource);
  }

  add(resource) {
    if (resource.loaded) {
      this.bytes.clear();
    }

    return resource.loaded ? super.add(resource) : this.pending.add(resource);
  }

  clear() {
    this.bytes.clear();
    this.pending.clear();
    return super.clear();
  }

  delete(resource) {
    this.bytes.clear();
    this.pending.delete(resource);
    return super.delete(resource);
  }

  calculateAssetIds() {
    if (!this.loaded()) {
      throw new Error(`Cannot calculate asset ids for union '${this.id}' before it is loaded`);
    }

    const {
      minSize,
      maxSize
    } = this.options;
    const {
      extension
    } = this.writer;
    const resourcesByAsset = new Map();
    const acc = new Set();
    let allocatedBytes = 0;
    let assetBytes = 0;

    const cutAsset = assetId => {
      resourcesByAsset.set(assetId, [...acc]);
      acc.forEach(resource => {
        this.slugs.set(resource, assetId);
      });
      acc.clear();
      assetBytes = 0;
    };

    for (const resource of [...this].sort((a, b) => (0, _bigInteger.default)(b.index).compare((0, _bigInteger.default)(a.index)))) {
      acc.add(resource);

      if (this.id === resource.slug) {
        cutAsset(resource.getOutputSlug());
      } else {
        allocatedBytes += resource.size;
        assetBytes += resource.size;
        const remainingBytes = this.bytes() - allocatedBytes;

        if (remainingBytes === 0 || assetBytes >= maxSize && remainingBytes >= minSize) {
          const assetId = `${(0, _objectHash.default)([...acc].sort((a, b) => a.pid - b.pid).map(r => ({
            0: r.moduleId,
            1: md5(r.output)
          })), {
            algorithm: 'md5'
          })}${extension}`;
          cutAsset(assetId);
        }
      }
    }

    return resourcesByAsset;
  }

  getAssetId(resource) {
    if (!resource) {
      throw new Error('resource is required');
    }

    if (!this.slugs.has(resource)) {
      this.calculateAssetIds();
    }

    return this.slugs.get(resource);
  }

  getOutputPath(resource) {
    return (0, _context.slugToAbsolutePath)(this.options.outputDir, this.getAssetId(resource));
  }

  loaded() {
    let result = true;

    for (const resource of this.pending) {
      if (resource.loaded) {
        this.add(resource);
        this.pending.delete(resource);
      } else if (!resource.isOrphaned()) {
        result = false;
        break;
      }
    }

    return result;
  }

  async write() {
    if (this.loaded()) {
      const resourcesByAsset = this.calculateAssetIds();
      await Promise.all([...resourcesByAsset.entries()].map(async ([assetId, resources]) => {
        const outputPath = (0, _context.slugToAbsolutePath)(this.options.outputDir, assetId); // FIXME: Source maps are incompatible with unions
        // see https://github.com/bernardmcmanus/remote-modules/issues/26

        if (resources.length > 1) {
          const output = resources.map(r => r.output.replace(/\n?.+# sourceMappingURL=.+$/m, '')).join('\n');
          await this.writer.apply(outputPath, output);
        } else {
          const [resource] = resources;
          const {
            sourceMaps
          } = resource.options;
          const {
            sourceMapJSON
          } = resource.adapter.parser;

          if (sourceMapJSON && (sourceMaps === true || sourceMaps === 'hidden')) {
            const sourceMapPath = (0, _context.slugToAbsolutePath)(this.options.outputDir, `${resource.slug}.map`);
            await this.writer.apply(sourceMapPath, `${JSON.stringify(sourceMapJSON, null, 2)}\n`);
          }

          await this.writer.apply(outputPath, resource.output);
        }
      }));
    }
  }

}

exports.default = Union;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9zZXJ2ZXIvaW5zdGFsbGVyL3VuaW9uL3VuaW9uLmpzIl0sIm5hbWVzIjpbIm1kNSIsInZhbHVlIiwidXBkYXRlIiwiZGlnZXN0IiwiVW5pb24iLCJTZXQiLCJjb25zdHJ1Y3RvciIsImlkIiwid3JpdGVyIiwib3B0aW9ucyIsInJlZHVjZSIsImFjYyIsInJlc291cmNlIiwic2l6ZSIsImJ5dGVzIiwid3JpdGFibGUiLCJtaW5TaXplIiwibWF4U2l6ZSIsInBlbmRpbmciLCJzbHVncyIsIk1hcCIsInJlc2V0IiwiZGVsZXRlIiwiYWRkIiwibG9hZGVkIiwiY2xlYXIiLCJjYWxjdWxhdGVBc3NldElkcyIsIkVycm9yIiwiZXh0ZW5zaW9uIiwicmVzb3VyY2VzQnlBc3NldCIsImFsbG9jYXRlZEJ5dGVzIiwiYXNzZXRCeXRlcyIsImN1dEFzc2V0IiwiYXNzZXRJZCIsInNldCIsImZvckVhY2giLCJzb3J0IiwiYSIsImIiLCJpbmRleCIsImNvbXBhcmUiLCJzbHVnIiwiZ2V0T3V0cHV0U2x1ZyIsInJlbWFpbmluZ0J5dGVzIiwicGlkIiwibWFwIiwiciIsIm1vZHVsZUlkIiwib3V0cHV0IiwiYWxnb3JpdGhtIiwiZ2V0QXNzZXRJZCIsImhhcyIsImdldCIsImdldE91dHB1dFBhdGgiLCJvdXRwdXREaXIiLCJyZXN1bHQiLCJpc09ycGhhbmVkIiwid3JpdGUiLCJQcm9taXNlIiwiYWxsIiwiZW50cmllcyIsInJlc291cmNlcyIsIm91dHB1dFBhdGgiLCJsZW5ndGgiLCJyZXBsYWNlIiwiam9pbiIsImFwcGx5Iiwic291cmNlTWFwcyIsInNvdXJjZU1hcEpTT04iLCJhZGFwdGVyIiwicGFyc2VyIiwic291cmNlTWFwUGF0aCIsIkpTT04iLCJzdHJpbmdpZnkiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUFFQSxTQUFTQSxHQUFULENBQWFDLEtBQWIsRUFBb0I7QUFD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QVosQ0FBa0JLLGFBQWxCLEVBQWtDLEdBQUVDLElBQUksQ0FBQ0MsU0FBTCxDQUFlTCxhQUFmLEVBQThCLElBQTlCLEVBQW9DLENBQXBDLENBQXVDLElBQTNFLENBQU47QUFDQTs7QUFDRCxnQkFBTSxLQUFLNUQsTUFBTCxDQUFZMEQsS0FBWixDQUFrQkosVUFBbEIsRUFBOEJsRCxRQUFRLENBQUNvQyxNQUF2QyxDQUFOO0FBQ0E7QUFDRCxPQXRCRCxDQURLLENBQU47QUF5QkE7QUFDRDs7QUFwSnFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY3JlYXRlSGFzaCB9IGZyb20gJ2NyeXB0byc7XG5cbmltcG9ydCBoYXNoIGZyb20gJ29iamVjdC1oYXNoJztcbmltcG9ydCBiaWdJbnQgZnJvbSAnYmlnLWludGVnZXInO1xuXG5pbXBvcnQgZGVmaW5lUHJvcGVydGllcyBmcm9tICcuLi8uLi8uLi9saWIvaGVscGVycy9kZWZpbmVQcm9wZXJ0aWVzJztcbmltcG9ydCBvbmNlIGZyb20gJy4uLy4uLy4uL2xpYi9oZWxwZXJzL29uY2UnO1xuaW1wb3J0IHsgc2x1Z1RvQWJzb2x1dGVQYXRoIH0gZnJvbSAnLi4vY29udGV4dCc7XG5cbmZ1bmN0aW9uIG1kNSh2YWx1ZSkge1xuXHRyZXR1cm4gY3JlYXRlSGFzaCgnbWQ1Jylcblx0XHQudXBkYXRlKHZhbHVlKVxuXHRcdC5kaWdlc3QoJ2hleCcpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBVbmlvbiBleHRlbmRzIFNldCB7XG5cdGNvbnN0cnVjdG9yKGlkLCB7IHdyaXRlciwgb3B0aW9ucyB9KSB7XG5cdFx0c3VwZXIoKTtcblxuXHRcdHRoaXMuaWQgPSBpZDtcblxuXHRcdGRlZmluZVByb3BlcnRpZXModGhpcywge1xuXHRcdFx0Ynl0ZXM6IHtcblx0XHRcdFx0d3JpdGFibGU6IHRydWVcblx0XHRcdH0sXG5cdFx0XHRvcHRpb25zOiB7XG5cdFx0XHRcdG1pblNpemU6IDVlNCxcblx0XHRcdFx0bWF4U2l6ZTogMTBlNCxcblx0XHRcdFx0Li4ub3B0aW9uc1xuXHRcdFx0fSxcblx0XHRcdHBlbmRpbmc6IG5ldyBTZXQoKSxcblx0XHRcdHNsdWdzOiBuZXcgTWFwKCksXG5cdFx0XHR3cml0ZXJcblx0XHR9KTtcblx0fVxuXG5cdGJ5dGVzID0gb25jZSgoKSA9PiBbLi4udGhpc10ucmVkdWNlKChhY2MsIHJlc291cmNlKSA9PiBhY2MgKyByZXNvdXJjZS5zaXplLCAwKSk7XG5cblx0cmVzZXQocmVzb3VyY2UpIHtcblx0XHR0aGlzLnNsdWdzLmRlbGV0ZShyZXNvdXJjZSk7XG5cdFx0dGhpcy5wZW5kaW5nLmRlbGV0ZShyZXNvdXJjZSk7XG5cdFx0dGhpcy5kZWxldGUocmVzb3VyY2UpO1xuXHRcdHRoaXMuYWRkKHJlc291cmNlKTtcblx0fVxuXG5cdGFkZChyZXNvdXJjZSkge1xuXHRcdGlmIChyZXNvdXJjZS5sb2FkZWQpIHtcblx0XHRcdHRoaXMuYnl0ZXMuY2xlYXIoKTtcblx0XHR9XG5cdFx0cmV0dXJuIHJlc291cmNlLmxvYWRlZCA/IHN1cGVyLmFkZChyZXNvdXJjZSkgOiB0aGlzLnBlbmRpbmcuYWRkKHJlc291cmNlKTtcblx0fVxuXG5cdGNsZWFyKCkge1xuXHRcdHRoaXMuYnl0ZXMuY2xlYXIoKTtcblx0XHR0aGlzLnBlbmRpbmcuY2xlYXIoKTtcblx0XHRyZXR1cm4gc3VwZXIuY2xlYXIoKTtcblx0fVxuXG5cdGRlbGV0ZShyZXNvdXJjZSkge1xuXHRcdHRoaXMuYnl0ZXMuY2xlYXIoKTtcblx0XHR0aGlzLnBlbmRpbmcuZGVsZXRlKHJlc291cmNlKTtcblx0XHRyZXR1cm4gc3VwZXIuZGVsZXRlKHJlc291cmNlKTtcblx0fVxuXG5cdGNhbGN1bGF0ZUFzc2V0SWRzKCkge1xuXHRcdGlmICghdGhpcy5sb2FkZWQoKSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgY2FsY3VsYXRlIGFzc2V0IGlkcyBmb3IgdW5pb24gJyR7dGhpcy5pZH0nIGJlZm9yZSBpdCBpcyBsb2FkZWRgKTtcblx0XHR9XG5cblx0XHRjb25zdCB7IG1pblNpemUsIG1heFNpemUgfSA9IHRoaXMub3B0aW9ucztcblx0XHRjb25zdCB7IGV4dGVuc2lvbiB9ID0gdGhpcy53cml0ZXI7XG5cdFx0Y29uc3QgcmVzb3VyY2VzQnlBc3NldCA9IG5ldyBNYXAoKTtcblx0XHRjb25zdCBhY2MgPSBuZXcgU2V0KCk7XG5cdFx0bGV0IGFsbG9jYXRlZEJ5dGVzID0gMDtcblx0XHRsZXQgYXNzZXRCeXRlcyA9IDA7XG5cblx0XHRjb25zdCBjdXRBc3NldCA9IGFzc2V0SWQgPT4ge1xuXHRcdFx0cmVzb3VyY2VzQnlBc3NldC5zZXQoYXNzZXRJZCwgWy4uLmFjY10pO1xuXHRcdFx0YWNjLmZvckVhY2gocmVzb3VyY2UgPT4ge1xuXHRcdFx0XHR0aGlzLnNsdWdzLnNldChyZXNvdXJjZSwgYXNzZXRJZCk7XG5cdFx0XHR9KTtcblx0XHRcdGFjYy5jbGVhcigpO1xuXHRcdFx0YXNzZXRCeXRlcyA9IDA7XG5cdFx0fTtcblxuXHRcdGZvciAoY29uc3QgcmVzb3VyY2Ugb2YgWy4uLnRoaXNdLnNvcnQoKGEsIGIpID0+IGJpZ0ludChiLmluZGV4KS5jb21wYXJlKGJpZ0ludChhLmluZGV4KSkpKSB7XG5cdFx0XHRhY2MuYWRkKHJlc291cmNlKTtcblx0XHRcdGlmICh0aGlzLmlkID09PSByZXNvdXJjZS5zbHVnKSB7XG5cdFx0XHRcdGN1dEFzc2V0KHJlc291cmNlLmdldE91dHB1dFNsdWcoKSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRhbGxvY2F0ZWRCeXRlcyArPSByZXNvdXJjZS5zaXplO1xuXHRcdFx0XHRhc3NldEJ5dGVzICs9IHJlc291cmNlLnNpemU7XG5cdFx0XHRcdGNvbnN0IHJlbWFpbmluZ0J5dGVzID0gdGhpcy5ieXRlcygpIC0gYWxsb2NhdGVkQnl0ZXM7XG5cdFx0XHRcdGlmIChyZW1haW5pbmdCeXRlcyA9PT0gMCB8fCAoYXNzZXRCeXRlcyA+PSBtYXhTaXplICYmIHJlbWFpbmluZ0J5dGVzID49IG1pblNpemUpKSB7XG5cdFx0XHRcdFx0Y29uc3QgYXNzZXRJZCA9IGAke2hhc2goXG5cdFx0XHRcdFx0XHRbLi4uYWNjXS5zb3J0KChhLCBiKSA9PiBhLnBpZCAtIGIucGlkKS5tYXAociA9PiAoeyAwOiByLm1vZHVsZUlkLCAxOiBtZDUoci5vdXRwdXQpIH0pKSxcblx0XHRcdFx0XHRcdHsgYWxnb3JpdGhtOiAnbWQ1JyB9XG5cdFx0XHRcdFx0KX0ke2V4dGVuc2lvbn1gO1xuXHRcdFx0XHRcdGN1dEFzc2V0KGFzc2V0SWQpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHJlc291cmNlc0J5QXNzZXQ7XG5cdH1cblxuXHRnZXRBc3NldElkKHJlc291cmNlKSB7XG5cdFx0aWYgKCFyZXNvdXJjZSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdyZXNvdXJjZSBpcyByZXF1aXJlZCcpO1xuXHRcdH1cblx0XHRpZiAoIXRoaXMuc2x1Z3MuaGFzKHJlc291cmNlKSkge1xuXHRcdFx0dGhpcy5jYWxjdWxhdGVBc3NldElkcygpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcy5zbHVncy5nZXQocmVzb3VyY2UpO1xuXHR9XG5cblx0Z2V0T3V0cHV0UGF0aChyZXNvdXJjZSkge1xuXHRcdHJldHVybiBzbHVnVG9BYnNvbHV0ZVBhdGgodGhpcy5vcHRpb25zLm91dHB1dERpciwgdGhpcy5nZXRBc3NldElkKHJlc291cmNlKSk7XG5cdH1cblxuXHRsb2FkZWQoKSB7XG5cdFx0bGV0IHJlc3VsdCA9IHRydWU7XG5cdFx0Zm9yIChjb25zdCByZXNvdXJjZSBvZiB0aGlzLnBlbmRpbmcpIHtcblx0XHRcdGlmIChyZXNvdXJjZS5sb2FkZWQpIHtcblx0XHRcdFx0dGhpcy5hZGQocmVzb3VyY2UpO1xuXHRcdFx0XHR0aGlzLnBlbmRpbmcuZGVsZXRlKHJlc291cmNlKTtcblx0XHRcdH0gZWxzZSBpZiAoIXJlc291cmNlLmlzT3JwaGFuZWQoKSkge1xuXHRcdFx0XHRyZXN1bHQgPSBmYWxzZTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdHJldHVybiByZXN1bHQ7XG5cdH1cblxuXHRhc3luYyB3cml0ZSgpIHtcblx0XHRpZiAodGhpcy5sb2FkZWQoKSkge1xuXHRcdFx0Y29uc3QgcmVzb3VyY2VzQnlBc3NldCA9IHRoaXMuY2FsY3VsYXRlQXNzZXRJZHMoKTtcblx0XHRcdGF3YWl0IFByb21pc2UuYWxsKFxuXHRcdFx0XHRbLi4ucmVzb3VyY2VzQnlBc3NldC5lbnRyaWVzKCldLm1hcChhc3luYyAoW2Fzc2V0SWQsIHJlc291cmNlc10pID0+IHtcblx0XHRcdFx0XHRjb25zdCBvdXRwdXRQYXRoID0gc2x1Z1RvQWJzb2x1dGVQYXRoKHRoaXMub3B0aW9ucy5vdXRwdXREaXIsIGFzc2V0SWQpO1xuXHRcdFx0XHRcdC8vIEZJWE1FOiBTb3VyY2UgbWFwcyBhcmUgaW5jb21wYXRpYmxlIHdpdGggdW5pb25zXG5cdFx0XHRcdFx0Ly8gc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9iZXJuYXJkbWNtYW51cy9yZW1vdGUtbW9kdWxlcy9pc3N1ZXMvMjZcblx0XHRcdFx0XHRpZiAocmVzb3VyY2VzLmxlbmd0aCA+IDEpIHtcblx0XHRcdFx0XHRcdGNvbnN0IG91dHB1dCA9IHJlc291cmNlc1xuXHRcdFx0XHRcdFx0XHQubWFwKHIgPT4gci5vdXRwdXQucmVwbGFjZSgvXFxuPy4rIyBzb3VyY2VNYXBwaW5nVVJMPS4rJC9tLCAnJykpXG5cdFx0XHRcdFx0XHRcdC5qb2luKCdcXG4nKTtcblx0XHRcdFx0XHRcdGF3YWl0IHRoaXMud3JpdGVyLmFwcGx5KG91dHB1dFBhdGgsIG91dHB1dCk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGNvbnN0IFtyZXNvdXJjZV0gPSByZXNvdXJjZXM7XG5cdFx0XHRcdFx0XHRjb25zdCB7IHNvdXJjZU1hcHMgfSA9IHJlc291cmNlLm9wdGlvbnM7XG5cdFx0XHRcdFx0XHRjb25zdCB7IHNvdXJjZU1hcEpTT04gfSA9IHJlc291cmNlLmFkYXB0ZXIucGFyc2VyO1xuXHRcdFx0XHRcdFx0aWYgKHNvdXJjZU1hcEpTT04gJiYgKHNvdXJjZU1hcHMgPT09IHRydWUgfHwgc291cmNlTWFwcyA9PT0gJ2hpZGRlbicpKSB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IHNvdXJjZU1hcFBhdGggPSBzbHVnVG9BYnNvbHV0ZVBhdGgoXG5cdFx0XHRcdFx0XHRcdFx0dGhpcy5vcHRpb25zLm91dHB1dERpcixcblx0XHRcdFx0XHRcdFx0XHRgJHtyZXNvdXJjZS5zbHVnfS5tYXBgXG5cdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRcdGF3YWl0IHRoaXMud3JpdGVyLmFwcGx5KHNvdXJjZU1hcFBhdGgsIGAke0pTT04uc3RyaW5naWZ5KHNvdXJjZU1hcEpTT04sIG51bGwsIDIpfVxcbmApO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0YXdhaXQgdGhpcy53cml0ZXIuYXBwbHkob3V0cHV0UGF0aCwgcmVzb3VyY2Uub3V0cHV0KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pXG5cdFx0XHQpO1xuXHRcdH1cblx0fVxufVxuIl19