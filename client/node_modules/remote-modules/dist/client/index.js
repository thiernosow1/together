"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _url = _interopRequireDefault(require("url"));

var _vm = require("vm");

var _helpers = require("../lib/helpers");

var _defineProperties = _interopRequireDefault(require("../lib/helpers/defineProperties"));

var _escapeRegExp = _interopRequireDefault(require("../lib/helpers/escapeRegExp"));

var _loader = _interopRequireDefault(require("./loader"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class Client {
  static hasScope(namespace) {
    return /(?:^|.+\/)@.+$/.test(namespace);
  } // Matches ^(<(namespace/)?@scope>)?


  static getNamespace(string = '') {
    return (0, _helpers.stripBounding)(string.match(/^(?:<((?:.*\/)?@[^>]+)>)?.*$/)[1] || '', '/');
  } // Removes ^(<(namespace/)?@scope>)?


  static transformArgs(ns, [string, ...args]) {
    return [string && string.replace(new RegExp(`^<${(0, _escapeRegExp.default)(ns)}>`), ''), ...args];
  }

  constructor(_ref) {
    let {
      context
    } = _ref,
        other = _objectWithoutProperties(_ref, ["context"]);

    _defineProperty(this, "loaders", new Map());

    (0, _defineProperties.default)(this, {
      lastActiveLoader: {
        value: undefined,
        writable: true
      }
    });
    Object.assign(this, {
      options: _objectSpread({
        context: context && ((0, _vm.isContext)(context) ? context : (0, _vm.createContext)(context))
      }, other)
    });
  }

  async reset(fn, nextNamespace) {
    const {
      loaders,
      lastActiveLoader
    } = this;
    let result;

    if (lastActiveLoader && lastActiveLoader !== loaders.get(nextNamespace)) {
      this.lastActiveLoader = null;
      result = await lastActiveLoader.reset(fn);
    } else if (fn) {
      result = await fn();
    }

    return result;
  }

  async renderStatic(request, type) {
    const ns = this.getNamespace(request);
    const [moduleId = ''] = Client.transformArgs(ns, [request]);
    const loader = this.use(ns);

    const pathname = _path.default.join(loader.baseURL.pathname, 'render', moduleId);

    const search = type ? `type=${type}` : '';

    const url = _url.default.format(_objectSpread({}, loader.baseURL, {
      pathname,
      search
    }));

    const res = await loader.fetch(url);

    if (!res.ok) {
      throw Object.assign(new Error(), (await res.json()));
    }

    return res.text();
  }

  getNamespace(string) {
    const ns = Client.getNamespace(string);
    const needsScope = !(Client.hasScope(ns) || Client.hasScope(this.options.uri));
    return needsScope ? (0, _helpers.stripBounding)(`${ns}/${Client.defaultScope}`, '/') : ns;
  }

  use(ns) {
    const {
      loaders,
      options
    } = this;
    let loader;

    if (loaders.has(ns)) {
      loader = loaders.get(ns);
    } else {
      const {
        uri
      } = options,
            other = _objectWithoutProperties(options, ["uri"]);

      loader = new _loader.default(_objectSpread({
        uri: `${uri.replace(/\/$/, '')}/${ns}`
      }, other));
      loaders.set(ns, loader);
    }

    this.lastActiveLoader = loader;
    return loader;
  }

  import(...args) {
    const ns = this.getNamespace(args[0]);
    const xargs = Client.transformArgs(ns, args);
    return this.reset(() => {
      const loader = this.use(ns);
      return loader.import(...xargs);
    }, ns);
  }

}

exports.default = Client;

_defineProperty(Client, "defaultScope", '@default');
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGllbnQvaW5kZXguanMiXSwibmFtZXMiOlsiQ2xpZW50IiwiaGFzU2NvcGUiLCJuYW1lc3BhY2UiLCJ0ZXN0IiwiZ2V0TmFtZXNwYWNlIiwic3RyaW5nIiwibWF0Y2giLCJ0cmFuc2Zvcm1BcmdzIiwibnMiLCJhcmdzIiwicmVwbGFjZSIsIlJlZ0V4cCIsImNvbnN0cnVjdG9yIiwiY29udGV4dCIsIm90aGVyIiwiTWFwIiwibGFzdEFjdGl2ZUxvYWRlciIsInZhbHVlIiwidW5kZWZpbmVkIiwid3JpdGFibGUiLCJPYmplY3QiLCJhc3NpZ24iLCJvcHRpb25zIiwicmVzZXQiLCJmbiIsIm5leHROYW1lc3BhY2UiLCJsb2FkZXJzIiwicmVzdWx0IiwiZ2V0IiwicmVuZGVyU3RhdGljIiwicmVxdWVzdCIsInR5cGUiLCJtb2R1bGVJZCIsImxvYWRlciIsInVzZSIsInBhdGhuYW1lIiwiUGF0aCIsImpvaW4iLCJiYXNlVVJMIiwic2VhcmNoIiwidXJsIiwiVXJsIiwiZm9ybWF0IiwicmVzIiwiZmV0Y2giLCJvayIsIkVycm9yIiwianNvbiIsInRleHQiLCJuZWVkc1Njb3BlIiwidXJpIiwiZGVmYXVsdFNjb3BlIiwiaGFzIiwiUmVtb3RlTG9hZGVyIiwic2V0IiwiaW1wb3J0IiwieGFyZ3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7O0FBRWUsTUFBTUEsTUFBTixDQUFhO0FBRzNCLFNBQU9DLFFBQVAsQ0FBZ0JDLFNBQWhCLEVBQTJCO0FBQzFCLFdBQU8saUJBQWlCQyxJQUFqQixDQUFzQkQsU0FBdEIsQ0FBUDtBQUNBLEdBTDBCLENBTzNCOzs7QUFDQSxTQUFPRSxZQUFQLENBQW9CQyxNQUFNLEdBQUcsRUFBN0IsRUFBaUM7QUFDaEMsV0FBTyw0QkFBY0EsTUFBTSxDQUFDQyxLQUFQLENBQWEsOEJBQWIsRUFBNkMsQ0FBN0MsS0FBbUQsRUFBakUsRUFB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SixFQUFVO0FBQ2YsVUFBTUQsRUFBRSxHQUFHLEtBQUtKLFlBQUwsQ0FBa0JLLElBQUksQ0FBQyxDQUFELENBQXRCLENBQVg7QUFDQSxVQUFNK0MsS0FBSyxHQUFHeEQsTUFBTSxDQUFDTyxhQUFQLENBQXFCQyxFQUFyQixFQUF5QkMsSUFBekIsQ0FBZDtBQUNBLFdBQU8sS0FBS2MsS0FBTCxDQUFXLE1BQU07QUFDdkIsWUFBTVUsTUFBTSxHQUFHLEtBQUtDLEdBQUwsQ0FBUzFCLEVBQVQsQ0FBZjtBQUNBLGFBQU95QixNQUFNLENBQUNzQixNQUFQLENBQWMsR0FBR0MsS0FBakIsQ0FBUDtBQUNBLEtBSE0sRUFHSmhELEVBSEksQ0FBUDtBQUlBOztBQTFGMEI7Ozs7Z0JBQVBSLE0sa0JBQ0UsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IFVybCBmcm9tICd1cmwnO1xuaW1wb3J0IHsgY3JlYXRlQ29udGV4dCwgaXNDb250ZXh0IH0gZnJvbSAndm0nO1xuXG5pbXBvcnQgeyBzdHJpcEJvdW5kaW5nIH0gZnJvbSAnLi4vbGliL2hlbHBlcnMnO1xuaW1wb3J0IGRlZmluZVByb3BlcnRpZXMgZnJvbSAnLi4vbGliL2hlbHBlcnMvZGVmaW5lUHJvcGVydGllcyc7XG5pbXBvcnQgZXNjYXBlUmVnRXhwIGZyb20gJy4uL2xpYi9oZWxwZXJzL2VzY2FwZVJlZ0V4cCc7XG5pbXBvcnQgUmVtb3RlTG9hZGVyIGZyb20gJy4vbG9hZGVyJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ2xpZW50IHtcblx0c3RhdGljIGRlZmF1bHRTY29wZSA9ICdAZGVmYXVsdCc7XG5cblx0c3RhdGljIGhhc1Njb3BlKG5hbWVzcGFjZSkge1xuXHRcdHJldHVybiAvKD86XnwuK1xcLylALiskLy50ZXN0KG5hbWVzcGFjZSk7XG5cdH1cblxuXHQvLyBNYXRjaGVzIF4oPChuYW1lc3BhY2UvKT9Ac2NvcGU+KT9cblx0c3RhdGljIGdldE5hbWVzcGFjZShzdHJpbmcgPSAnJykge1xuXHRcdHJldHVybiBzdHJpcEJvdW5kaW5nKHN0cmluZy5tYXRjaCgvXig/OjwoKD86LipcXC8pP0BbXj5dKyk+KT8uKiQvKVsxXSB8fCAnJywgJy8nKTtcblx0fVxuXG5cdC8vIFJlbW92ZXMgXig8KG5hbWVzcGFjZS8pP0BzY29wZT4pP1xuXHRzdGF0aWMgdHJhbnNmb3JtQXJncyhucywgW3N0cmluZywgLi4uYXJnc10pIHtcblx0XHRyZXR1cm4gW3N0cmluZyAmJiBzdHJpbmcucmVwbGFjZShuZXcgUmVnRXhwKGBePCR7ZXNjYXBlUmVnRXhwKG5zKX0+YCksICcnKSwgLi4uYXJnc107XG5cdH1cblxuXHRjb25zdHJ1Y3Rvcih7IGNvbnRleHQsIC4uLm90aGVyIH0pIHtcblx0XHRkZWZpbmVQcm9wZXJ0aWVzKHRoaXMsIHtcblx0XHRcdGxhc3RBY3RpdmVMb2FkZXI6IHtcblx0XHRcdFx0dmFsdWU6IHVuZGVmaW5lZCxcblx0XHRcdFx0d3JpdGFibGU6IHRydWVcblx0XHRcdH1cblx0XHR9KTtcblx0XHRPYmplY3QuYXNzaWduKHRoaXMsIHtcblx0XHRcdG9wdGlvbnM6IHtcblx0XHRcdFx0Y29udGV4dDogY29udGV4dCAmJiAoaXNDb250ZXh0KGNvbnRleHQpID8gY29udGV4dCA6IGNyZWF0ZUNvbnRleHQoY29udGV4dCkpLFxuXHRcdFx0XHQuLi5vdGhlclxuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0bG9hZGVycyA9IG5ldyBNYXAoKTtcblxuXHRhc3luYyByZXNldChmbiwgbmV4dE5hbWVzcGFjZSkge1xuXHRcdGNvbnN0IHsgbG9hZGVycywgbGFzdEFjdGl2ZUxvYWRlciB9ID0gdGhpcztcblx0XHRsZXQgcmVzdWx0O1xuXHRcdGlmIChsYXN0QWN0aXZlTG9hZGVyICYmIGxhc3RBY3RpdmVMb2FkZXIgIT09IGxvYWRlcnMuZ2V0KG5leHROYW1lc3BhY2UpKSB7XG5cdFx0XHR0aGlzLmxhc3RBY3RpdmVMb2FkZXIgPSBudWxsO1xuXHRcdFx0cmVzdWx0ID0gYXdhaXQgbGFzdEFjdGl2ZUxvYWRlci5yZXNldChmbik7XG5cdFx0fSBlbHNlIGlmIChmbikge1xuXHRcdFx0cmVzdWx0ID0gYXdhaXQgZm4oKTtcblx0XHR9XG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fVxuXG5cdGFzeW5jIHJlbmRlclN0YXRpYyhyZXF1ZXN0LCB0eXBlKSB7XG5cdFx0Y29uc3QgbnMgPSB0aGlzLmdldE5hbWVzcGFjZShyZXF1ZXN0KTtcblx0XHRjb25zdCBbbW9kdWxlSWQgPSAnJ10gPSBDbGllbnQudHJhbnNmb3JtQXJncyhucywgW3JlcXVlc3RdKTtcblx0XHRjb25zdCBsb2FkZXIgPSB0aGlzLnVzZShucyk7XG5cdFx0Y29uc3QgcGF0aG5hbWUgPSBQYXRoLmpvaW4obG9hZGVyLmJhc2VVUkwucGF0aG5hbWUsICdyZW5kZXInLCBtb2R1bGVJZCk7XG5cdFx0Y29uc3Qgc2VhcmNoID0gdHlwZSA/IGB0eXBlPSR7dHlwZX1gIDogJyc7XG5cdFx0Y29uc3QgdXJsID0gVXJsLmZvcm1hdCh7IC4uLmxvYWRlci5iYXNlVVJMLCBwYXRobmFtZSwgc2VhcmNoIH0pO1xuXHRcdGNvbnN0IHJlcyA9IGF3YWl0IGxvYWRlci5mZXRjaCh1cmwpO1xuXHRcdGlmICghcmVzLm9rKSB7XG5cdFx0XHR0aHJvdyBPYmplY3QuYXNzaWduKG5ldyBFcnJvcigpLCBhd2FpdCByZXMuanNvbigpKTtcblx0XHR9XG5cdFx0cmV0dXJuIHJlcy50ZXh0KCk7XG5cdH1cblxuXHRnZXROYW1lc3BhY2Uoc3RyaW5nKSB7XG5cdFx0Y29uc3QgbnMgPSBDbGllbnQuZ2V0TmFtZXNwYWNlKHN0cmluZyk7XG5cdFx0Y29uc3QgbmVlZHNTY29wZSA9ICEoQ2xpZW50Lmhhc1Njb3BlKG5zKSB8fCBDbGllbnQuaGFzU2NvcGUodGhpcy5vcHRpb25zLnVyaSkpO1xuXHRcdHJldHVybiBuZWVkc1Njb3BlID8gc3RyaXBCb3VuZGluZyhgJHtuc30vJHtDbGllbnQuZGVmYXVsdFNjb3BlfWAsICcvJykgOiBucztcblx0fVxuXG5cdHVzZShucykge1xuXHRcdGNvbnN0IHsgbG9hZGVycywgb3B0aW9ucyB9ID0gdGhpcztcblx0XHRsZXQgbG9hZGVyO1xuXHRcdGlmIChsb2FkZXJzLmhhcyhucykpIHtcblx0XHRcdGxvYWRlciA9IGxvYWRlcnMuZ2V0KG5zKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc3QgeyB1cmksIC4uLm90aGVyIH0gPSBvcHRpb25zO1xuXHRcdFx0bG9hZGVyID0gbmV3IFJlbW90ZUxvYWRlcih7XG5cdFx0XHRcdHVyaTogYCR7dXJpLnJlcGxhY2UoL1xcLyQvLCAnJyl9LyR7bnN9YCxcblx0XHRcdFx0Li4ub3RoZXJcblx0XHRcdH0pO1xuXHRcdFx0bG9hZGVycy5zZXQobnMsIGxvYWRlcik7XG5cdFx0fVxuXHRcdHRoaXMubGFzdEFjdGl2ZUxvYWRlciA9IGxvYWRlcjtcblx0XHRyZXR1cm4gbG9hZGVyO1xuXHR9XG5cblx0aW1wb3J0KC4uLmFyZ3MpIHtcblx0XHRjb25zdCBucyA9IHRoaXMuZ2V0TmFtZXNwYWNlKGFyZ3NbMF0pO1xuXHRcdGNvbnN0IHhhcmdzID0gQ2xpZW50LnRyYW5zZm9ybUFyZ3MobnMsIGFyZ3MpO1xuXHRcdHJldHVybiB0aGlzLnJlc2V0KCgpID0+IHtcblx0XHRcdGNvbnN0IGxvYWRlciA9IHRoaXMudXNlKG5zKTtcblx0XHRcdHJldHVybiBsb2FkZXIuaW1wb3J0KC4uLnhhcmdzKTtcblx0XHR9LCBucyk7XG5cdH1cbn1cbiJdfQ==