"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _vm = require("vm");

var _manifest = _interopRequireDefault(require("../lib/manifest"));

var _defineProperties = _interopRequireDefault(require("../lib/helpers/defineProperties"));

var _once = _interopRequireDefault(require("../lib/helpers/once"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class AsyncModule {
  static formatError(err) {
    const stack = err.stack.split('\n').filter(line => !/AsyncModule|RemoteLoader/.test(line)).join('\n');
    return Object.assign(err, {
      stack
    });
  }

  constructor(loader, _ref) {
    let {
      id,
      pid,
      content,
      parent = null
    } = _ref,
        other = _objectWithoutProperties(_ref, ["id", "pid", "content", "parent"]);

    _defineProperty(this, "load", (0, _once.default)(async () => {
      if (this.manifest) {
        if (this.isMain) {
          await this.loader.ensure(this);
        }
      } else {
        const {
          context,
          script,
          filename,
          dirname
        } = this;
        const namespace = context !== global ? script.runInContext(context) : script.runInThisContext();
        const wrapper = namespace[`pid:${this.pid}`];
        await wrapper(this.exports, this.require, this, filename, dirname);
      }

      this.loaded = true;
      return this;
    }));

    _defineProperty(this, "require", request => this.loader.require(request, this));

    if (!_path.default.extname(id)) {
      throw new Error(`Expected AsyncModule '${id}' to have extension`);
    }

    if (typeof pid !== 'number') {
      throw new Error(`Expected AsyncModule '${id}' to have numeric pid`);
    }

    const _filename = _path.default.join('/', id);

    const _dirname = _path.default.dirname(_filename);

    const _script = new _vm.Script(content, {
      // this has no effect on runtime, only stack traces
      filename: loader.getResourceURLFromID(id)
    });

    const main = parent && parent.main || parent || this;
    (0, _defineProperties.default)(this, {
      loader,
      manifest: {
        value: null,
        writable: true
      },
      isMain: {
        get: () => main === this
      },
      context: {
        get: () => loader.context
      },
      registry: {
        get: () => loader.registry
      },
      require: {
        writable: true
      }
    });
    Object.assign(this, {
      id,
      pid,
      script: _script,
      filename: _filename,
      dirname: _dirname,
      parent,
      main,
      external: false,
      loaded: false,
      definition: null,
      exports: {}
    }, other);
  }

  _throwNotFound(request) {
    // eslint-disable-next-line no-underscore-dangle
    return this.loader._throwNotFound(request);
  }

  import(request) {
    return this.loader.import(request, this);
  }

  resolveDynamic(request) {
    return this.loader.resolveDynamic(request, this);
  }

  resolveURL(request) {
    return this.loader.resolveURL(request, this);
  }

  async define(meta, definition) {
    this.definition = definition;

    if (this.isMain) {
      const json = await this.loader.getManifest(this.id);
      this.manifest = _manifest.default.load(json);
      await this.loader.ensure(this);
    } else {
      this.manifest = _manifest.default.derive(this.main.manifest, meta);
    }
  }

  exec() {
    if (!this.loaded) {
      throw new Error(`Attempted to initialize module ${this.id} before it was loaded`);
    }

    const {
      definition
    } = this;

    if (definition) {
      try {
        delete this.definition;
        definition();
      } catch (err) {
        const error = AsyncModule.formatError(err);

        this.definition = () => {
          throw error;
        };

        this.definition();
      }
    }

    return this.exports;
  }

  reset() {
    this.loaded = false;
    this.load.clear();
  }

  trace() {
    const route = new Set();
    let parent = this;

    while (parent && !route.has(parent.id)) {
      route.add(parent.id);
      ({
        parent
      } = parent);
    }

    const indent = ' '.repeat(4);
    return Array.from(route).reduce((acc, id) => `${acc}\n${indent}<AsyncModule (${id})>`, '');
  }

}

exports.default = AsyncModule;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGllbnQvYXN5bmMtbW9kdWxlLmpzIl0sIm5hbWVzIjpbIkFzeW5jTW9kdWxlIiwiZm9ybWF0RXJyb3IiLCJlcnIiLCJzdGFjayIsInNwbGl0IiwiZmlsdGVyIiwibGluZSIsInRlc3QiLCJqb2luIiwiT2JqZWN0IiwiYXNzaWduIiwiY29uc3RydWN0b3IiLCJsb2FkZXIiLCJpZCIsInBpZCIsImNvbnRlbnQiLCJwYXJlbnQiLCJvdGhlciIsIm1hbmlmZXN0IiwiaXNNYWluIiwiZW5zdXJlIiwiY29udGV4dCIsInNjcmlwdCIsImZpbGVuYW1lIiwiZGlybmFtZSIsIm5hbWVzcGFjZSIsImdsb2JhbCIsInJ1bkluQ29udGV4dCIsInJ1bkluVGhpc0NvbnRleHQiLCJ3cmFwcGVyIiwiZXhwb3J0cyIsInJlcXVpcmUiLCJsb2FkZWQiLCJyZXF1ZXN0IiwiUGF0aCIsImV4dG5hbWUiLCJFcnJvciIsIlNjcmlwdCIsImdldFJlc291cmNlVVJMRnJvbUlEIiwibWFpbiIsInZhbHVlIiwid3JpdGFibGUiLCJnZXQiLCJyZWdpc3RyeSIsImV4dGVybmFsIiwiZGVmaW5pdGlvbiIsIl90aHJvd05vdEZvdW5kIiwiaW1wb3J0IiwicmVzb2x2ZUR5bmFtaWMiLCJyZXNvbHZlVVJMIiwiZGVmaW5lIiwibWV0YSIsImpzb24iLCJnZXRNYW5pZmVzdCIsIk1hbmlmZXN0IiwibG9hZCIsImRlcml2ZSIsImV4ZWMiLCJlcnJvciIsInJlc2V0IiwiY2xlYXIiLCJ0cmFjZSIsInJvdXRlIiwiU2V0IiwiaGFzIiwiYWRkIiwiaW5kZW50IiwicmVwZWF0IiwiQXJyYXkiLCJmcm9tIiwicmVkdWNlIiwiYWNjIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7QUFFZSxNQUFNQSxXQUFOLENBQWtCO0FBQ2hDLFNBQU9DLFdBQVAsQ0FBbUJDLEdBQW5CLEVBQXdCO0FBQ3ZCLFVBQU1DLEtBQUssR0FBR0QsR0FB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QUFFREMsRUFBQUEsS0FBSyxHQUFHO0FBQ1AsVUFBTUMsS0FBSyxHQUFHLElBQUlDLEdBQUosRUFBZDtBQUNBLFFBQUkvQyxNQUFNLEdBQUcsSUFBYjs7QUFDQSxXQUFPQSxNQUFNLElBQUksQ0FBQzhDLEtBQUssQ0FBQ0UsR0FBTixDQUFVaEQsTUFBTSxDQUFDSCxFQUFqQixDQUFsQixFQUF3QztBQUN2Q2lELE1BQUFBLEtBQUssQ0FBQ0csR0FBTixDQUFVakQsTUFBTSxDQUFDSCxFQUFqQjtBQUNBLE9BQUM7QUFBRUcsUUFBQUE7QUFBRixVQUFhQSxNQUFkO0FBQ0E7O0FBQ0QsVUFBTWtELE1BQU0sR0FBRyxJQUFJQyxNQUFKLENBQVcsQ0FBWCxDQUFmO0FBQ0EsV0FBT0MsS0FBSyxDQUFDQyxJQUFOLENBQVdQLEtBQVgsRUFBa0JRLE1BQWxCLENBQXlCLENBQUNDLEdBQUQsRUFBTTFELEVBQU4sS0FBYyxHQUFFMEQsR0FBSSxLQUFJTCxNQUFPLGlCQUFnQnJELEVBQUcsSUFBM0UsRUFBZ0YsRUFBaEYsQ0FBUDtBQUNBOztBQS9JK0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IFNjcmlwdCB9IGZyb20gJ3ZtJztcblxuaW1wb3J0IE1hbmlmZXN0IGZyb20gJy4uL2xpYi9tYW5pZmVzdCc7XG5pbXBvcnQgZGVmaW5lUHJvcGVydGllcyBmcm9tICcuLi9saWIvaGVscGVycy9kZWZpbmVQcm9wZXJ0aWVzJztcbmltcG9ydCBvbmNlIGZyb20gJy4uL2xpYi9oZWxwZXJzL29uY2UnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBc3luY01vZHVsZSB7XG5cdHN0YXRpYyBmb3JtYXRFcnJvcihlcnIpIHtcblx0XHRjb25zdCBzdGFjayA9IGVyci5zdGFja1xuXHRcdFx0LnNwbGl0KCdcXG4nKVxuXHRcdFx0LmZpbHRlcihsaW5lID0+ICEvQXN5bmNNb2R1bGV8UmVtb3RlTG9hZGVyLy50ZXN0KGxpbmUpKVxuXHRcdFx0LmpvaW4oJ1xcbicpO1xuXHRcdHJldHVybiBPYmplY3QuYXNzaWduKGVyciwgeyBzdGFjayB9KTtcblx0fVxuXG5cdGNvbnN0cnVjdG9yKGxvYWRlciwgeyBpZCwgcGlkLCBjb250ZW50LCBwYXJlbnQgPSBudWxsLCAuLi5vdGhlciB9KSB7XG5cdFx0aWYgKCFQYXRoLmV4dG5hbWUoaWQpKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIEFzeW5jTW9kdWxlICcke2lkfScgdG8gaGF2ZSBleHRlbnNpb25gKTtcblx0XHR9XG5cdFx0aWYgKHR5cGVvZiBwaWQgIT09ICdudW1iZXInKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIEFzeW5jTW9kdWxlICcke2lkfScgdG8gaGF2ZSBudW1lcmljIHBpZGApO1xuXHRcdH1cblx0XHRjb25zdCBmaWxlbmFtZSA9IFBhdGguam9pbignLycsIGlkKTtcblx0XHRjb25zdCBkaXJuYW1lID0gUGF0aC5kaXJuYW1lKGZpbGVuYW1lKTtcblx0XHRjb25zdCBzY3JpcHQgPSBuZXcgU2NyaXB0KGNvbnRlbnQsIHtcblx0XHRcdC8vIHRoaXMgaGFzIG5vIGVmZmVjdCBvbiBydW50aW1lLCBvbmx5IHN0YWNrIHRyYWNlc1xuXHRcdFx0ZmlsZW5hbWU6IGxvYWRlci5nZXRSZXNvdXJjZVVSTEZyb21JRChpZClcblx0XHR9KTtcblx0XHRjb25zdCBtYWluID0gKHBhcmVudCAmJiBwYXJlbnQubWFpbikgfHwgcGFyZW50IHx8IHRoaXM7XG5cblx0XHRkZWZpbmVQcm9wZXJ0aWVzKHRoaXMsIHtcblx0XHRcdGxvYWRlcixcblx0XHRcdG1hbmlmZXN0OiB7XG5cdFx0XHRcdHZhbHVlOiBudWxsLFxuXHRcdFx0XHR3cml0YWJsZTogdHJ1ZVxuXHRcdFx0fSxcblx0XHRcdGlzTWFpbjoge1xuXHRcdFx0XHRnZXQ6ICgpID0+IG1haW4gPT09IHRoaXNcblx0XHRcdH0sXG5cdFx0XHRjb250ZXh0OiB7XG5cdFx0XHRcdGdldDogKCkgPT4gbG9hZGVyLmNvbnRleHRcblx0XHRcdH0sXG5cdFx0XHRyZWdpc3RyeToge1xuXHRcdFx0XHRnZXQ6ICgpID0+IGxvYWRlci5yZWdpc3RyeVxuXHRcdFx0fSxcblx0XHRcdHJlcXVpcmU6IHtcblx0XHRcdFx0d3JpdGFibGU6IHRydWVcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdE9iamVjdC5hc3NpZ24oXG5cdFx0XHR0aGlzLFxuXHRcdFx0e1xuXHRcdFx0XHRpZCxcblx0XHRcdFx0cGlkLFxuXHRcdFx0XHRzY3JpcHQsXG5cdFx0XHRcdGZpbGVuYW1lLFxuXHRcdFx0XHRkaXJuYW1lLFxuXHRcdFx0XHRwYXJlbnQsXG5cdFx0XHRcdG1haW4sXG5cdFx0XHRcdGV4dGVybmFsOiBmYWxzZSxcblx0XHRcdFx0bG9hZGVkOiBmYWxzZSxcblx0XHRcdFx0ZGVmaW5pdGlvbjogbnVsbCxcblx0XHRcdFx0ZXhwb3J0czoge31cblx0XHRcdH0sXG5cdFx0XHRvdGhlclxuXHRcdCk7XG5cdH1cblxuXHRsb2FkID0gb25jZShhc3luYyAoKSA9PiB7XG5cdFx0aWYgKHRoaXMubWFuaWZlc3QpIHtcblx0XHRcdGlmICh0aGlzLmlzTWFpbikge1xuXHRcdFx0XHRhd2FpdCB0aGlzLmxvYWRlci5lbnN1cmUodGhpcyk7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbnN0IHsgY29udGV4dCwgc2NyaXB0LCBmaWxlbmFtZSwgZGlybmFtZSB9ID0gdGhpcztcblx0XHRcdGNvbnN0IG5hbWVzcGFjZSA9XG5cdFx0XHRcdGNvbnRleHQgIT09IGdsb2JhbCA/IHNjcmlwdC5ydW5JbkNvbnRleHQoY29udGV4dCkgOiBzY3JpcHQucnVuSW5UaGlzQ29udGV4dCgpO1xuXHRcdFx0Y29uc3Qgd3JhcHBlciA9IG5hbWVzcGFjZVtgcGlkOiR7dGhpcy5waWR9YF07XG5cdFx0XHRhd2FpdCB3cmFwcGVyKHRoaXMuZXhwb3J0cywgdGhpcy5yZXF1aXJlLCB0aGlzLCBmaWxlbmFtZSwgZGlybmFtZSk7XG5cdFx0fVxuXHRcdHRoaXMubG9hZGVkID0gdHJ1ZTtcblx0XHRyZXR1cm4gdGhpcztcblx0fSk7XG5cblx0cmVxdWlyZSA9IHJlcXVlc3QgPT4gdGhpcy5sb2FkZXIucmVxdWlyZShyZXF1ZXN0LCB0aGlzKTtcblxuXHRfdGhyb3dOb3RGb3VuZChyZXF1ZXN0KSB7XG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG5cdFx0cmV0dXJuIHRoaXMubG9hZGVyLl90aHJvd05vdEZvdW5kKHJlcXVlc3QpO1xuXHR9XG5cblx0aW1wb3J0KHJlcXVlc3QpIHtcblx0XHRyZXR1cm4gdGhpcy5sb2FkZXIuaW1wb3J0KHJlcXVlc3QsIHRoaXMpO1xuXHR9XG5cblx0cmVzb2x2ZUR5bmFtaWMocmVxdWVzdCkge1xuXHRcdHJldHVybiB0aGlzLmxvYWRlci5yZXNvbHZlRHluYW1pYyhyZXF1ZXN0LCB0aGlzKTtcblx0fVxuXG5cdHJlc29sdmVVUkwocmVxdWVzdCkge1xuXHRcdHJldHVybiB0aGlzLmxvYWRlci5yZXNvbHZlVVJMKHJlcXVlc3QsIHRoaXMpO1xuXHR9XG5cblx0YXN5bmMgZGVmaW5lKG1ldGEsIGRlZmluaXRpb24pIHtcblx0XHR0aGlzLmRlZmluaXRpb24gPSBkZWZpbml0aW9uO1xuXHRcdGlmICh0aGlzLmlzTWFpbikge1xuXHRcdFx0Y29uc3QganNvbiA9IGF3YWl0IHRoaXMubG9hZGVyLmdldE1hbmlmZXN0KHRoaXMuaWQpO1xuXHRcdFx0dGhpcy5tYW5pZmVzdCA9IE1hbmlmZXN0LmxvYWQoanNvbik7XG5cdFx0XHRhd2FpdCB0aGlzLmxvYWRlci5lbnN1cmUodGhpcyk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMubWFuaWZlc3QgPSBNYW5pZmVzdC5kZXJpdmUodGhpcy5tYWluLm1hbmlmZXN0LCBtZXRhKTtcblx0XHR9XG5cdH1cblxuXHRleGVjKCkge1xuXHRcdGlmICghdGhpcy5sb2FkZWQpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgQXR0ZW1wdGVkIHRvIGluaXRpYWxpemUgbW9kdWxlICR7dGhpcy5pZH0gYmVmb3JlIGl0IHdhcyBsb2FkZWRgKTtcblx0XHR9XG5cdFx0Y29uc3QgeyBkZWZpbml0aW9uIH0gPSB0aGlzO1xuXHRcdGlmIChkZWZpbml0aW9uKSB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRkZWxldGUgdGhpcy5kZWZpbml0aW9uO1xuXHRcdFx0XHRkZWZpbml0aW9uKCk7XG5cdFx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdFx0Y29uc3QgZXJyb3IgPSBBc3luY01vZHVsZS5mb3JtYXRFcnJvcihlcnIpO1xuXHRcdFx0XHR0aGlzLmRlZmluaXRpb24gPSAoKSA9PiB7XG5cdFx0XHRcdFx0dGhyb3cgZXJyb3I7XG5cdFx0XHRcdH07XG5cdFx0XHRcdHRoaXMuZGVmaW5pdGlvbigpO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRyZXR1cm4gdGhpcy5leHBvcnRzO1xuXHR9XG5cblx0cmVzZXQoKSB7XG5cdFx0dGhpcy5sb2FkZWQgPSBmYWxzZTtcblx0XHR0aGlzLmxvYWQuY2xlYXIoKTtcblx0fVxuXG5cdHRyYWNlKCkge1xuXHRcdGNvbnN0IHJvdXRlID0gbmV3IFNldCgpO1xuXHRcdGxldCBwYXJlbnQgPSB0aGlzO1xuXHRcdHdoaWxlIChwYXJlbnQgJiYgIXJvdXRlLmhhcyhwYXJlbnQuaWQpKSB7XG5cdFx0XHRyb3V0ZS5hZGQocGFyZW50LmlkKTtcblx0XHRcdCh7IHBhcmVudCB9ID0gcGFyZW50KTtcblx0XHR9XG5cdFx0Y29uc3QgaW5kZW50ID0gJyAnLnJlcGVhdCg0KTtcblx0XHRyZXR1cm4gQXJyYXkuZnJvbShyb3V0ZSkucmVkdWNlKChhY2MsIGlkKSA9PiBgJHthY2N9XFxuJHtpbmRlbnR9PEFzeW5jTW9kdWxlICgke2lkfSk+YCwgJycpO1xuXHR9XG59XG4iXX0=