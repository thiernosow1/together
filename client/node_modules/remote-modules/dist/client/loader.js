"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _url = _interopRequireDefault(require("url"));

var _vm = require("vm");

var _asyncModule = _interopRequireDefault(require("./async-module"));

var _moduleTransport = _interopRequireDefault(require("./module-transport"));

var _request2 = _interopRequireDefault(require("./request"));

var _registry = _interopRequireDefault(require("./registry"));

var _pid = _interopRequireDefault(require("../lib/helpers/pid"));

var _defineProperties = _interopRequireDefault(require("../lib/helpers/defineProperties"));

var _get = _interopRequireDefault(require("../lib/helpers/get"));

var _once = _interopRequireDefault(require("../lib/helpers/once"));

var _helpers = require("../lib/helpers");

var _urlBuilder = require("../lib/url-builder");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const ENV = (0, _get.default)(process, ['env', 'BUILD_ENV']) || (0, _get.default)(process, ['env', 'NODE_ENV']);

function getDefaultExternalRequire(loader) {
  return process.browser ? // eslint-disable-next-line no-underscore-dangle
  request => loader._throwNotFound(request) : require;
}

class RemoteLoader {
  static isExternal(request, parent) {
    return Boolean(parent) && typeof request === 'string' && !parent.manifest.exists(request);
  }

  constructor({
    uri,
    context = (0, _vm.createContext)(global),
    externalRequire = getDefaultExternalRequire(this),
    forceLoad = ENV === 'development',
    // eslint-disable-next-line no-nested-ternary
    ttl = process.browser ? Infinity : forceLoad ? 0 : 3e5
    /* 5m */
    ,
    registry = new _registry.default(ttl)
  }) {
    _defineProperty(this, "_throwNotFound", request => {
      const err = new Error(`Cannot find module '${request}'`);
      throw Object.assign(err, {
        code: 'MODULE_NOT_FOUND'
      });
    });

    if (!uri) {
      throw new Error('uri is required');
    }

    const {
      host,
      protocol,
      pathname
    } = _url.default.parse(uri);

    const _request = new _request2.default({
      protocol
    });

    const transport = new _moduleTransport.default(this);
    const baseURL = (0, _defineProperties.default)({
      host,
      protocol,
      pathname: pathname.replace(/\/$/, '')
    }, {
      toString: {
        enumerable: false,
        value: (0, _once.default)(() => _url.default.format(this.baseURL))
      }
    }, {
      enumerable: true,
      writable: false
    });
    Object.assign(this, {
      baseURL
    });
    (0, _defineProperties.default)(this, {
      context,
      externalRequire,
      registry,
      transport,
      request: _request
    });
  }

  getResourceURLFromID(id, query) {
    return (0, _urlBuilder.assembleResourceURL)(this.baseURL, id, query);
  }

  resolveURL(request, parent, query) {
    const moduleId = this.resolve(request, parent);
    return this.getResourceURLFromID(moduleId, query);
  }

  async fetchManifestJSON(id, query) {
    const pathname = _path.default.join(this.baseURL.pathname, 'manifest', id);

    const url = _url.default.format(_objectSpread({}, this.baseURL, {
      pathname,
      query
    }));

    const res = await this.fetch(url);

    if (!res.ok) {
      throw Object.assign(new Error(), (await res.json()));
    } // Link the requested id to the resolved pid


    this.registry.ln(id, Number(res.headers['x-pointer-id']));
    return res.json();
  }

  getManifest(id) {
    return this.transport.getManifestJSON(id);
  }

  async fetch(url, _ref = {}) {
    let {
      method = 'GET'
    } = _ref,
        other = _objectWithoutProperties(_ref, ["method"]);

    const res = await this.request(url, _objectSpread({
      method
    }, other));
    const moduleId = res.headers['x-module-id'];
    const pid = Number(res.headers['x-pointer-id']);

    if (res.ok && moduleId) {
      this.registry.ln(moduleId, pid);
    }

    return res;
  }

  getFromContext(pid) {
    return this.context[`pid:${pid}`];
  }

  async reset(fn) {
    const predicate = this.transport.getResetPredicate();
    let result;

    if (predicate) {
      // Browser only
      this.registry.forEach(module => {
        if (!module.external) {
          module.reset();
        }
      });
      result = fn && (await fn());
      predicate();
    } else if (fn) {
      result = await fn();
    }

    return result;
  }

  register(_ref2) {
    let {
      id,
      pid
    } = _ref2,
        other = _objectWithoutProperties(_ref2, ["id", "pid"]);

    const {
      registry
    } = this;
    let module = registry.get(pid);

    if (!module) {
      module = new _asyncModule.default(this, _objectSpread({
        id,
        pid
      }, other));
      registry.set(pid, module);
      registry.ln(id, pid);
      /**
       * Link main modules to the default request if it doesn't already exist
       */

      if (module.isMain && !registry.hasLink('')) {
        registry.ln('', pid);
      }
    }

    return module;
  } // eslint-disable-next-line class-methods-use-this


  resolve(request = '', parent) {
    let resolved;

    if (typeof request === 'string') {
      resolved = request.replace(/^\/?:?/, '');
    }

    if (parent) {
      resolved = parent.manifest.getModuleId(request) || request;
    }

    return resolved;
  }

  resolvePid(request, parent) {
    const {
      registry
    } = this;
    let resolved;

    if (RemoteLoader.isExternal(request, parent)) {
      if (registry.hasLink(request)) {
        resolved = registry.lookup(request);
      } else {
        resolved = (0, _pid.default)(request);
        registry.ln(request, resolved);
      }
    } else {
      resolved = this.resolve(request, parent);

      if (typeof resolved !== 'number') {
        if (parent) {
          resolved = parent.manifest.getPid(resolved);
        } else {
          resolved = registry.lookup(resolved);
        }
      }
    }

    return typeof resolved === 'number' ? resolved : undefined;
  } // eslint-disable-next-line class-methods-use-this


  resolveDynamic(request, parent) {
    return (0, _helpers.isRelativePath)(request) ? `./${_path.default.normalize(`${parent ? _path.default.dirname(parent.id) : ''}/${request}`)}` : request;
  }

  async ensure(entryModule) {
    const {
      manifest
    } = entryModule;
    const moduleIds = Array.from(manifest.list().reduce((acc, moduleId) => {
      const assetId = manifest.getAssetId(moduleId);

      if (!acc.has(assetId) && !RemoteLoader.isExternal(moduleId, entryModule)) {
        acc.set(assetId, moduleId);
      }

      return acc;
    }, new Map([[manifest.meta('assetId'), manifest.meta('moduleId')]])).values());
    await Promise.all(moduleIds.map(id => this.load(id, entryModule)));
    return Promise.all(manifest.list().reduce((acc, id) => {
      if (manifest.getType(id) === 'js') {
        acc.push(this.load(id, entryModule));
      }

      return acc;
    }, []));
  }

  async import(request, parent) {
    /**
     * Sweep the registry cache on entrypoint requests
     */
    if (!parent && !this.transport.pending.size) {
      this.registry.sweep();
    }

    const module = await this.load(request);

    if (!module.loaded) {
      await module.load();
    }

    return module.exec();
  }

  async resolveAsync(request, parent) {
    const url = this.resolveURL(request, parent);
    const res = await this.fetch(url, {
      method: 'HEAD'
    });

    if (!res.ok) {
      this._throwNotFound(request);
    }

    return {
      moduleId: res.headers['x-module-id'],
      pid: Number(res.headers['x-pointer-id'])
    };
  }

  require(pid, parent) {
    // eslint-disable-next-line no-sync
    const module = this.loadSync(pid, parent);

    if (!module && (!parent || parent.manifest.getType(pid) === 'js')) {
      this._throwNotFound(this.resolve(pid, parent));
    }

    return module && module.exec();
  }

  loadSync(request, parent) {
    const {
      externalRequire,
      registry
    } = this;
    const moduleId = this.resolve(request, parent);
    const pid = this.resolvePid(request, parent);
    let module;

    if (registry.has(pid)) {
      module = registry.get(pid);
    } else if (RemoteLoader.isExternal(moduleId, parent)) {
      module = {
        id: moduleId,
        external: true,
        exec: () => {
          module.exports = externalRequire(moduleId);
          return module.exports;
        }
      };
      registry.set(pid, module);
    }

    return module;
  }

  async load(request = '', parent) {
    /**
     * IMPORTANT: There is no guarantee that the request will be
     * resolved to the canonical moduleId if parent is undefined
     */
    // eslint-disable-next-line no-sync
    let module = this.loadSync(request, parent);

    if (!module) {
      module = await this.transport.initialize(request, parent);

      if (!parent) {
        this.registry.ln(request, module.pid);
      }

      await module.load();
    }

    return module;
  }

}

exports.default = RemoteLoader;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGllbnQvbG9hZGVyLmpzIl0sIm5hbWVzIjpbIkVOViIsInByb2Nlc3MiLCJnZXREZWZhdWx0RXh0ZXJuYWxSZXF1aXJlIiwibG9hZGVyIiwiYnJvd3NlciIsInJlcXVlc3QiLCJfdGhyb3dOb3RGb3VuZCIsInJlcXVpcmUiLCJSZW1vdGVMb2FkZXIiLCJpc0V4dGVybmFsIiwicGFyZW50IiwiQm9vbGVhbiIsIm1hbmlmZXN0IiwiZXhpc3RzIiwiY29uc3RydWN0b3IiLCJ1cmkiLCJjb250ZXh0IiwiZ2xvYmFsIiwiZXh0ZXJuYWxSZXF1aXJlIiwiZm9yY2VMb2FkIiwidHRsIiwiSW5maW5pdHkiLCJyZWdpc3RyeSIsIlJlZ2lzdHJ5IiwiZXJyIiwiRXJyb3IiLCJPYmplY3QiLCJhc3NpZ24iLCJjb2RlIiwiaG9zdCIsInByb3RvY29sIiwicGF0aG5hbWUiLCJVcmwiLCJwYXJzZSIsIlJlcXVlc3QiLCJ0cmFuc3BvcnQiLCJNb2R1bGVUcmFuc3BvcnQiLCJiYXNlVVJMIiwicmVwbGFjZSIsInRvU3RyaW5nIiwiZW51bWVyYWJsZSIsInZhbHVlIiwiZm9ybWF0Iiwid3JpdGFibGUiLCJnZXRSZXNvdXJjZVVSTEZyb21JRCIsImlkIiwicXVlcnkiLCJyZXNvbHZlVVJMIiwibW9kdWxlSWQiLCJyZXNvbHZlIiwiZmV0Y2hNYW5pZmVzdEpTT04iLCJQYXRoIiwiam9pbiIsInVybCIsInJlcyIsImZldGNoIiwib2siLCJqc29uIiwibG4iLCJOdW1iZXIiLCJoZWFkZXJzIiwiZ2V0TWFuaWZlc3QiLCJnZXRNYW5pZmVzdEpTT04iLCJtZXRob2QiLCJvdGhlciIsInBpZCIsImdldEZyb21Db250ZXh0IiwicmVzZXQiLCJmbiIsInByZWRpY2F0ZSIsImdldFJlc2V0UHJlZGljYXRlIiwicmVzdWx0IiwiZm9yRWFjaCIsIm1vZHVsZSIsImV4dGVybmFsIiwicmVnaXN0ZXIiLCJnZXQiLCJBc3luY01vZHVsZSIsInNldCIsImlzTWFpbiIsImhhc0xpbmsiLCJyZXNvbHZlZCIsImdldE1vZHVsZUlkIiwicmVzb2x2ZVBpZCIsImxvb2t1cCIsImdldFBpZCIsInVuZGVmaW5lZCIsInJlc29sdmVEeW5hbWljIiwibm9ybWFsaXplIiwiZGlybmFtZSIsImVuc3VyZSIsImVudHJ5TW9kdWxlIiwibW9kdWxlSWRzIiwiQXJyYXkiLCJmcm9tIiwibGlzdCIsInJlZHVjZSIsImFjYyIsImFzc2V0SWQiLCJnZXRBc3NldElkIiwiaGFzIiwiTWFwIiwibWV0YSIsInZhbHVlcyIsIlByb21pc2UiLCJhbGwiLCJtYXAiLCJsb2FkIiwiZ2V0VHlwZSIsInB1c2giLCJpbXBvcnQiLCJwZW5kaW5nIiwic2l6ZSIsInN3ZWVwIiwibG9hZGVkIiwiZXhlYyIsInJlc29sdmVBc3luYyIsImxvYWRTeW5jIiwiZXhwb3J0cyIsImluaXRpYWxpemUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7O0FBRUEsTUFBTUEsR0FBRyxHQUFHLGtCQUFJQyxPQUFKLEVBQWEsQ0FBQyxLQUFELEVBQVEsV0FBUixDQUFiLEtBQXNDLGtCQUFJQSxPQUFKLEVBQWEsQ0FBQyxLQUFELEVBQVEsVUFBUixDQUFiLENBQWxEOztBQUVBLFNBQVNDLHlCQUFULENBQW1DQyxNQUFuQyxFQUEyQztBQUMxQyxTQUFPRixPQUFPLENBQUNHLE9BQVIsR0FDSjtBQUNBQyxFQUFBQSxPQUFPLElBQUlGLE1BQU0sQ0FBQ0csY0FBUCxDQUFzQkQsT0FBdEIsQ0FGUCxHQUdKRSxPQUhIO0FBSUE7O0FBRWMsTUFBTUMsWUFBTixDQUFtQjtBQUNqQyxTQUFPQyxVQUFQLENBQWtCSixPQUFsQixFQUEyQkssTUFBM0IsRUFBbUM7QUFDbEMsV0FBT0MsT0FBTyxDQUFDRCxNQUFELENBQVAsSUFBbUIsT0FBT0wsT0FBUCxLQUFtQixRQUF0QyxJQUFrRCxDQUFDSyxNQUFNLENB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Q3dELEdBQVQsQ0FBYWIsR0FBYixFQUFrQlEsTUFBbEI7QUFDQTs7QUFDRCxXQUFPQSxNQUFQO0FBQ0E7O0FBRUQsUUFBTWtDLElBQU4sQ0FBV3RHLE9BQU8sR0FBRyxFQUFyQixFQUF5QkssTUFBekIsRUFBaUM7QUFDaEM7Ozs7QUFJQTtBQUNBLFFBQUkrRCxNQUFNLEdBQUcsS0FBSzRDLFFBQUwsQ0FBY2hILE9BQWQsRUFBdUJLLE1BQXZCLENBQWI7O0FBQ0EsUUFBSSxDQUFDK0QsTUFBTCxFQUFhO0FBQ1pBLE1BQUFBLE1BQU0sR0FBRyxNQUFNLEtBQUt0QyxTQUFMLENBQWVvRixVQUFmLENBQTBCbEgsT0FBMUIsRUFBbUNLLE1BQW5DLENBQWY7O0FBQ0EsVUFBSSxDQUFDQSxNQUFMLEVBQWE7QUFDWixhQUFLWSxRQUFMLENBQWNvQyxFQUFkLENBQWlCckQsT0FBakIsRUFBMEJvRSxNQUFNLENBQUNSLEdBQWpDO0FBQ0E7O0FBQ0QsWUFBTVEsTUFBTSxDQUFDa0MsSUFBUCxFQUFOO0FBQ0E7O0FBQ0QsV0FBT2xDLE1BQVA7QUFDQTs7QUEzUWdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgVXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgeyBjcmVhdGVDb250ZXh0IH0gZnJvbSAndm0nO1xuXG5pbXBvcnQgQXN5bmNNb2R1bGUgZnJvbSAnLi9hc3luYy1tb2R1bGUnO1xuaW1wb3J0IE1vZHVsZVRyYW5zcG9ydCBmcm9tICcuL21vZHVsZS10cmFuc3BvcnQnO1xuaW1wb3J0IFJlcXVlc3QgZnJvbSAnLi9yZXF1ZXN0JztcbmltcG9ydCBSZWdpc3RyeSBmcm9tICcuL3JlZ2lzdHJ5JztcbmltcG9ydCBjYWxjdWxhdGVQSUQgZnJvbSAnLi4vbGliL2hlbHBlcnMvcGlkJztcbmltcG9ydCBkZWZpbmVQcm9wZXJ0aWVzIGZyb20gJy4uL2xpYi9oZWxwZXJzL2RlZmluZVByb3BlcnRpZXMnO1xuaW1wb3J0IGdldCBmcm9tICcuLi9saWIvaGVscGVycy9nZXQnO1xuaW1wb3J0IG9uY2UgZnJvbSAnLi4vbGliL2hlbHBlcnMvb25jZSc7XG5pbXBvcnQgeyBpc1JlbGF0aXZlUGF0aCB9IGZyb20gJy4uL2xpYi9oZWxwZXJzJztcbmltcG9ydCB7IGFzc2VtYmxlUmVzb3VyY2VVUkwgfSBmcm9tICcuLi9saWIvdXJsLWJ1aWxkZXInO1xuXG5jb25zdCBFTlYgPSBnZXQocHJvY2VzcywgWydlbnYnLCAnQlVJTERfRU5WJ10pIHx8IGdldChwcm9jZXNzLCBbJ2VudicsICdOT0RFX0VOViddKTtcblxuZnVuY3Rpb24gZ2V0RGVmYXVsdEV4dGVybmFsUmVxdWlyZShsb2FkZXIpIHtcblx0cmV0dXJuIHByb2Nlc3MuYnJvd3NlclxuXHRcdD8gLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG5cdFx0ICByZXF1ZXN0ID0+IGxvYWRlci5fdGhyb3dOb3RGb3VuZChyZXF1ZXN0KVxuXHRcdDogcmVxdWlyZTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVtb3RlTG9hZGVyIHtcblx0c3RhdGljIGlzRXh0ZXJuYWwocmVxdWVzdCwgcGFyZW50KSB7XG5cdFx0cmV0dXJuIEJvb2xlYW4ocGFyZW50KSAmJiB0eXBlb2YgcmVxdWVzdCA9PT0gJ3N0cmluZycgJiYgIXBhcmVudC5tYW5pZmVzdC5leGlzdHMocmVxdWVzdCk7XG5cdH1cblxuXHRjb25zdHJ1Y3Rvcih7XG5cdFx0dXJpLFxuXHRcdGNvbnRleHQgPSBjcmVhdGVDb250ZXh0KGdsb2JhbCksXG5cdFx0ZXh0ZXJuYWxSZXF1aXJlID0gZ2V0RGVmYXVsdEV4dGVybmFsUmVxdWlyZSh0aGlzKSxcblx0XHRmb3JjZUxvYWQgPSBFTlYgPT09ICdkZXZlbG9wbWVudCcsXG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLW5lc3RlZC10ZXJuYXJ5XG5cdFx0dHRsID0gcHJvY2Vzcy5icm93c2VyID8gSW5maW5pdHkgOiBmb3JjZUxvYWQgPyAwIDogM2U1IC8qIDVtICovLFxuXHRcdHJlZ2lzdHJ5ID0gbmV3IFJlZ2lzdHJ5KHR0bClcblx0fSkge1xuXHRcdGlmICghdXJpKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ3VyaSBpcyByZXF1aXJlZCcpO1xuXHRcdH1cblxuXHRcdGNvbnN0IHsgaG9zdCwgcHJvdG9jb2wsIHBhdGhuYW1lIH0gPSBVcmwucGFyc2UodXJpKTtcblx0XHRjb25zdCByZXF1ZXN0ID0gbmV3IFJlcXVlc3QoeyBwcm90b2NvbCB9KTtcblx0XHRjb25zdCB0cmFuc3BvcnQgPSBuZXcgTW9kdWxlVHJhbnNwb3J0KHRoaXMpO1xuXHRcdGNvbnN0IGJhc2VVUkwgPSBkZWZpbmVQcm9wZXJ0aWVzKFxuXHRcdFx0eyBob3N0LCBwcm90b2NvbCwgcGF0aG5hbWU6IHBhdGhuYW1lLnJlcGxhY2UoL1xcLyQvLCAnJykgfSxcblx0XHRcdHtcblx0XHRcdFx0dG9TdHJpbmc6IHtcblx0XHRcdFx0XHRlbnVtZXJhYmxlOiBmYWxzZSxcblx0XHRcdFx0XHR2YWx1ZTogb25jZSgoKSA9PiBVcmwuZm9ybWF0KHRoaXMuYmFzZVVSTCkpXG5cdFx0XHRcdH1cblx0XHRcdH0sXG5cdFx0XHR7XG5cdFx0XHRcdGVudW1lcmFibGU6IHRydWUsXG5cdFx0XHRcdHdyaXRhYmxlOiBmYWxzZVxuXHRcdFx0fVxuXHRcdCk7XG5cblx0XHRPYmplY3QuYXNzaWduKHRoaXMsIHsgYmFzZVVSTCB9KTtcblxuXHRcdGRlZmluZVByb3BlcnRpZXModGhpcywge1xuXHRcdFx0Y29udGV4dCxcblx0XHRcdGV4dGVybmFsUmVxdWlyZSxcblx0XHRcdHJlZ2lzdHJ5LFxuXHRcdFx0dHJhbnNwb3J0LFxuXHRcdFx0cmVxdWVzdFxuXHRcdH0pO1xuXHR9XG5cblx0X3Rocm93Tm90Rm91bmQgPSByZXF1ZXN0ID0+IHtcblx0XHRjb25zdCBlcnIgPSBuZXcgRXJyb3IoYENhbm5vdCBmaW5kIG1vZHVsZSAnJHtyZXF1ZXN0fSdgKTtcblx0XHR0aHJvdyBPYmplY3QuYXNzaWduKGVyciwgeyBjb2RlOiAnTU9EVUxFX05PVF9GT1VORCcgfSk7XG5cdH07XG5cblx0Z2V0UmVzb3VyY2VVUkxGcm9tSUQoaWQsIHF1ZXJ5KSB7XG5cdFx0cmV0dXJuIGFzc2VtYmxlUmVzb3VyY2VVUkwodGhpcy5iYXNlVVJMLCBpZCwgcXVlcnkpO1xuXHR9XG5cblx0cmVzb2x2ZVVSTChyZXF1ZXN0LCBwYXJlbnQsIHF1ZXJ5KSB7XG5cdFx0Y29uc3QgbW9kdWxlSWQgPSB0aGlzLnJlc29sdmUocmVxdWVzdCwgcGFyZW50KTtcblx0XHRyZXR1cm4gdGhpcy5nZXRSZXNvdXJjZVVSTEZyb21JRChtb2R1bGVJZCwgcXVlcnkpO1xuXHR9XG5cblx0YXN5bmMgZmV0Y2hNYW5pZmVzdEpTT04oaWQsIHF1ZXJ5KSB7XG5cdFx0Y29uc3QgcGF0aG5hbWUgPSBQYXRoLmpvaW4odGhpcy5iYXNlVVJMLnBhdGhuYW1lLCAnbWFuaWZlc3QnLCBpZCk7XG5cdFx0Y29uc3QgdXJsID0gVXJsLmZvcm1hdCh7IC4uLnRoaXMuYmFzZVVSTCwgcGF0aG5hbWUsIHF1ZXJ5IH0pO1xuXHRcdGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZmV0Y2godXJsKTtcblx0XHRpZiAoIXJlcy5vaykge1xuXHRcdFx0dGhyb3cgT2JqZWN0LmFzc2lnbihuZXcgRXJyb3IoKSwgYXdhaXQgcmVzLmpzb24oKSk7XG5cdFx0fVxuXHRcdC8vIExpbmsgdGhlIHJlcXVlc3RlZCBpZCB0byB0aGUgcmVzb2x2ZWQgcGlkXG5cdFx0dGhpcy5yZWdpc3RyeS5sbihpZCwgTnVtYmVyKHJlcy5oZWFkZXJzWyd4LXBvaW50ZXItaWQnXSkpO1xuXHRcdHJldHVybiByZXMuanNvbigpO1xuXHR9XG5cblx0Z2V0TWFuaWZlc3QoaWQpIHtcblx0XHRyZXR1cm4gdGhpcy50cmFuc3BvcnQuZ2V0TWFuaWZlc3RKU09OKGlkKTtcblx0fVxuXG5cdGFzeW5jIGZldGNoKHVybCwgeyBtZXRob2QgPSAnR0VUJywgLi4ub3RoZXIgfSA9IHt9KSB7XG5cdFx0Y29uc3QgcmVzID0gYXdhaXQgdGhpcy5yZXF1ZXN0KHVybCwgeyBtZXRob2QsIC4uLm90aGVyIH0pO1xuXHRcdGNvbnN0IG1vZHVsZUlkID0gcmVzLmhlYWRlcnNbJ3gtbW9kdWxlLWlkJ107XG5cdFx0Y29uc3QgcGlkID0gTnVtYmVyKHJlcy5oZWFkZXJzWyd4LXBvaW50ZXItaWQnXSk7XG5cblx0XHRpZiAocmVzLm9rICYmIG1vZHVsZUlkKSB7XG5cdFx0XHR0aGlzLnJlZ2lzdHJ5LmxuKG1vZHVsZUlkLCBwaWQpO1xuXHRcdH1cblxuXHRcdHJldHVybiByZXM7XG5cdH1cblxuXHRnZXRGcm9tQ29udGV4dChwaWQpIHtcblx0XHRyZXR1cm4gdGhpcy5jb250ZXh0W2BwaWQ6JHtwaWR9YF07XG5cdH1cblxuXHRhc3luYyByZXNldChmbikge1xuXHRcdGNvbnN0IHByZWRpY2F0ZSA9IHRoaXMudHJhbnNwb3J0LmdldFJlc2V0UHJlZGljYXRlKCk7XG5cdFx0bGV0IHJlc3VsdDtcblx0XHRpZiAocHJlZGljYXRlKSB7XG5cdFx0XHQvLyBCcm93c2VyIG9ubHlcblx0XHRcdHRoaXMucmVnaXN0cnkuZm9yRWFjaChtb2R1bGUgPT4ge1xuXHRcdFx0XHRpZiAoIW1vZHVsZS5leHRlcm5hbCkge1xuXHRcdFx0XHRcdG1vZHVsZS5yZXNldCgpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHRcdHJlc3VsdCA9IGZuICYmIChhd2FpdCBmbigpKTtcblx0XHRcdHByZWRpY2F0ZSgpO1xuXHRcdH0gZWxzZSBpZiAoZm4pIHtcblx0XHRcdHJlc3VsdCA9IGF3YWl0IGZuKCk7XG5cdFx0fVxuXHRcdHJldHVybiByZXN1bHQ7XG5cdH1cblxuXHRyZWdpc3Rlcih7IGlkLCBwaWQsIC4uLm90aGVyIH0pIHtcblx0XHRjb25zdCB7IHJlZ2lzdHJ5IH0gPSB0aGlzO1xuXHRcdGxldCBtb2R1bGUgPSByZWdpc3RyeS5nZXQocGlkKTtcblx0XHRpZiAoIW1vZHVsZSkge1xuXHRcdFx0bW9kdWxlID0gbmV3IEFzeW5jTW9kdWxlKHRoaXMsIHsgaWQsIHBpZCwgLi4ub3RoZXIgfSk7XG5cdFx0XHRyZWdpc3RyeS5zZXQocGlkLCBtb2R1bGUpO1xuXHRcdFx0cmVnaXN0cnkubG4oaWQsIHBpZCk7XG5cdFx0XHQvKipcblx0XHRcdCAqIExpbmsgbWFpbiBtb2R1bGVzIHRvIHRoZSBkZWZhdWx0IHJlcXVlc3QgaWYgaXQgZG9lc24ndCBhbHJlYWR5IGV4aXN0XG5cdFx0XHQgKi9cblx0XHRcdGlmIChtb2R1bGUuaXNNYWluICYmICFyZWdpc3RyeS5oYXNMaW5rKCcnKSkge1xuXHRcdFx0XHRyZWdpc3RyeS5sbignJywgcGlkKTtcblx0XHRcdH1cblx0XHR9XG5cdFx0cmV0dXJuIG1vZHVsZTtcblx0fVxuXG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjbGFzcy1tZXRob2RzLXVzZS10aGlzXG5cdHJlc29sdmUocmVxdWVzdCA9ICcnLCBwYXJlbnQpIHtcblx0XHRsZXQgcmVzb2x2ZWQ7XG5cdFx0aWYgKHR5cGVvZiByZXF1ZXN0ID09PSAnc3RyaW5nJykge1xuXHRcdFx0cmVzb2x2ZWQgPSByZXF1ZXN0LnJlcGxhY2UoL15cXC8/Oj8vLCAnJyk7XG5cdFx0fVxuXHRcdGlmIChwYXJlbnQpIHtcblx0XHRcdHJlc29sdmVkID0gcGFyZW50Lm1hbmlmZXN0LmdldE1vZHVsZUlkKHJlcXVlc3QpIHx8IHJlcXVlc3Q7XG5cdFx0fVxuXHRcdHJldHVybiByZXNvbHZlZDtcblx0fVxuXG5cdHJlc29sdmVQaWQocmVxdWVzdCwgcGFyZW50KSB7XG5cdFx0Y29uc3QgeyByZWdpc3RyeSB9ID0gdGhpcztcblx0XHRsZXQgcmVzb2x2ZWQ7XG5cdFx0aWYgKFJlbW90ZUxvYWRlci5pc0V4dGVybmFsKHJlcXVlc3QsIHBhcmVudCkpIHtcblx0XHRcdGlmIChyZWdpc3RyeS5oYXNMaW5rKHJlcXVlc3QpKSB7XG5cdFx0XHRcdHJlc29sdmVkID0gcmVnaXN0cnkubG9va3VwKHJlcXVlc3QpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0cmVzb2x2ZWQgPSBjYWxjdWxhdGVQSUQocmVxdWVzdCk7XG5cdFx0XHRcdHJlZ2lzdHJ5LmxuKHJlcXVlc3QsIHJlc29sdmVkKTtcblx0XHRcdH1cblx0XHR9IGVsc2Uge1xuXHRcdFx0cmVzb2x2ZWQgPSB0aGlzLnJlc29sdmUocmVxdWVzdCwgcGFyZW50KTtcblx0XHRcdGlmICh0eXBlb2YgcmVzb2x2ZWQgIT09ICdudW1iZXInKSB7XG5cdFx0XHRcdGlmIChwYXJlbnQpIHtcblx0XHRcdFx0XHRyZXNvbHZlZCA9IHBhcmVudC5tYW5pZmVzdC5nZXRQaWQocmVzb2x2ZWQpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHJlc29sdmVkID0gcmVnaXN0cnkubG9va3VwKHJlc29sdmVkKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblx0XHRyZXR1cm4gdHlwZW9mIHJlc29sdmVkID09PSAnbnVtYmVyJyA/IHJlc29sdmVkIDogdW5kZWZpbmVkO1xuXHR9XG5cblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNsYXNzLW1ldGhvZHMtdXNlLXRoaXNcblx0cmVzb2x2ZUR5bmFtaWMocmVxdWVzdCwgcGFyZW50KSB7XG5cdFx0cmV0dXJuIGlzUmVsYXRpdmVQYXRoKHJlcXVlc3QpXG5cdFx0XHQ/IGAuLyR7UGF0aC5ub3JtYWxpemUoYCR7cGFyZW50ID8gUGF0aC5kaXJuYW1lKHBhcmVudC5pZCkgOiAnJ30vJHtyZXF1ZXN0fWApfWBcblx0XHRcdDogcmVxdWVzdDtcblx0fVxuXG5cdGFzeW5jIGVuc3VyZShlbnRyeU1vZHVsZSkge1xuXHRcdGNvbnN0IHsgbWFuaWZlc3QgfSA9IGVudHJ5TW9kdWxlO1xuXHRcdGNvbnN0IG1vZHVsZUlkcyA9IEFycmF5LmZyb20oXG5cdFx0XHRtYW5pZmVzdFxuXHRcdFx0XHQubGlzdCgpXG5cdFx0XHRcdC5yZWR1Y2UoKGFjYywgbW9kdWxlSWQpID0+IHtcblx0XHRcdFx0XHRjb25zdCBhc3NldElkID0gbWFuaWZlc3QuZ2V0QXNzZXRJZChtb2R1bGVJZCk7XG5cdFx0XHRcdFx0aWYgKCFhY2MuaGFzKGFzc2V0SWQpICYmICFSZW1vdGVMb2FkZXIuaXNFeHRlcm5hbChtb2R1bGVJZCwgZW50cnlNb2R1bGUpKSB7XG5cdFx0XHRcdFx0XHRhY2Muc2V0KGFzc2V0SWQsIG1vZHVsZUlkKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0cmV0dXJuIGFjYztcblx0XHRcdFx0fSwgbmV3IE1hcChbW21hbmlmZXN0Lm1ldGEoJ2Fzc2V0SWQnKSwgbWFuaWZlc3QubWV0YSgnbW9kdWxlSWQnKV1dKSlcblx0XHRcdFx0LnZhbHVlcygpXG5cdFx0KTtcblxuXHRcdGF3YWl0IFByb21pc2UuYWxsKG1vZHVsZUlkcy5tYXAoaWQgPT4gdGhpcy5sb2FkKGlkLCBlbnRyeU1vZHVsZSkpKTtcblxuXHRcdHJldHVybiBQcm9taXNlLmFsbChcblx0XHRcdG1hbmlmZXN0Lmxpc3QoKS5yZWR1Y2UoKGFjYywgaWQpID0+IHtcblx0XHRcdFx0aWYgKG1hbmlmZXN0LmdldFR5cGUoaWQpID09PSAnanMnKSB7XG5cdFx0XHRcdFx0YWNjLnB1c2godGhpcy5sb2FkKGlkLCBlbnRyeU1vZHVsZSkpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdHJldHVybiBhY2M7XG5cdFx0XHR9LCBbXSlcblx0XHQpO1xuXHR9XG5cblx0YXN5bmMgaW1wb3J0KHJlcXVlc3QsIHBhcmVudCkge1xuXHRcdC8qKlxuXHRcdCAqIFN3ZWVwIHRoZSByZWdpc3RyeSBjYWNoZSBvbiBlbnRyeXBvaW50IHJlcXVlc3RzXG5cdFx0ICovXG5cdFx0aWYgKCFwYXJlbnQgJiYgIXRoaXMudHJhbnNwb3J0LnBlbmRpbmcuc2l6ZSkge1xuXHRcdFx0dGhpcy5yZWdpc3RyeS5zd2VlcCgpO1xuXHRcdH1cblx0XHRjb25zdCBtb2R1bGUgPSBhd2FpdCB0aGlzLmxvYWQocmVxdWVzdCk7XG5cdFx0aWYgKCFtb2R1bGUubG9hZGVkKSB7XG5cdFx0XHRhd2FpdCBtb2R1bGUubG9hZCgpO1xuXHRcdH1cblx0XHRyZXR1cm4gbW9kdWxlLmV4ZWMoKTtcblx0fVxuXG5cdGFzeW5jIHJlc29sdmVBc3luYyhyZXF1ZXN0LCBwYXJlbnQpIHtcblx0XHRjb25zdCB1cmwgPSB0aGlzLnJlc29sdmVVUkwocmVxdWVzdCwgcGFyZW50KTtcblx0XHRjb25zdCByZXMgPSBhd2FpdCB0aGlzLmZldGNoKHVybCwgeyBtZXRob2Q6ICdIRUFEJyB9KTtcblx0XHRpZiAoIXJlcy5vaykge1xuXHRcdFx0dGhpcy5fdGhyb3dOb3RGb3VuZChyZXF1ZXN0KTtcblx0XHR9XG5cdFx0cmV0dXJuIHtcblx0XHRcdG1vZHVsZUlkOiByZXMuaGVhZGVyc1sneC1tb2R1bGUtaWQnXSxcblx0XHRcdHBpZDogTnVtYmVyKHJlcy5oZWFkZXJzWyd4LXBvaW50ZXItaWQnXSlcblx0XHR9O1xuXHR9XG5cblx0cmVxdWlyZShwaWQsIHBhcmVudCkge1xuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1zeW5jXG5cdFx0Y29uc3QgbW9kdWxlID0gdGhpcy5sb2FkU3luYyhwaWQsIHBhcmVudCk7XG5cdFx0aWYgKCFtb2R1bGUgJiYgKCFwYXJlbnQgfHwgcGFyZW50Lm1hbmlmZXN0LmdldFR5cGUocGlkKSA9PT0gJ2pzJykpIHtcblx0XHRcdHRoaXMuX3Rocm93Tm90Rm91bmQodGhpcy5yZXNvbHZlKHBpZCwgcGFyZW50KSk7XG5cdFx0fVxuXHRcdHJldHVybiBtb2R1bGUgJiYgbW9kdWxlLmV4ZWMoKTtcblx0fVxuXG5cdGxvYWRTeW5jKHJlcXVlc3QsIHBhcmVudCkge1xuXHRcdGNvbnN0IHsgZXh0ZXJuYWxSZXF1aXJlLCByZWdpc3RyeSB9ID0gdGhpcztcblx0XHRjb25zdCBtb2R1bGVJZCA9IHRoaXMucmVzb2x2ZShyZXF1ZXN0LCBwYXJlbnQpO1xuXHRcdGNvbnN0IHBpZCA9IHRoaXMucmVzb2x2ZVBpZChyZXF1ZXN0LCBwYXJlbnQpO1xuXHRcdGxldCBtb2R1bGU7XG5cdFx0aWYgKHJlZ2lzdHJ5LmhhcyhwaWQpKSB7XG5cdFx0XHRtb2R1bGUgPSByZWdpc3RyeS5nZXQocGlkKTtcblx0XHR9IGVsc2UgaWYgKFJlbW90ZUxvYWRlci5pc0V4dGVybmFsKG1vZHVsZUlkLCBwYXJlbnQpKSB7XG5cdFx0XHRtb2R1bGUgPSB7XG5cdFx0XHRcdGlkOiBtb2R1bGVJZCxcblx0XHRcdFx0ZXh0ZXJuYWw6IHRydWUsXG5cdFx0XHRcdGV4ZWM6ICgpID0+IHtcblx0XHRcdFx0XHRtb2R1bGUuZXhwb3J0cyA9IGV4dGVybmFsUmVxdWlyZShtb2R1bGVJZCk7XG5cdFx0XHRcdFx0cmV0dXJuIG1vZHVsZS5leHBvcnRzO1xuXHRcdFx0XHR9XG5cdFx0XHR9O1xuXHRcdFx0cmVnaXN0cnkuc2V0KHBpZCwgbW9kdWxlKTtcblx0XHR9XG5cdFx0cmV0dXJuIG1vZHVsZTtcblx0fVxuXG5cdGFzeW5jIGxvYWQocmVxdWVzdCA9ICcnLCBwYXJlbnQpIHtcblx0XHQvKipcblx0XHQgKiBJTVBPUlRBTlQ6IFRoZXJlIGlzIG5vIGd1YXJhbnRlZSB0aGF0IHRoZSByZXF1ZXN0IHdpbGwgYmVcblx0XHQgKiByZXNvbHZlZCB0byB0aGUgY2Fub25pY2FsIG1vZHVsZUlkIGlmIHBhcmVudCBpcyB1bmRlZmluZWRcblx0XHQgKi9cblx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tc3luY1xuXHRcdGxldCBtb2R1bGUgPSB0aGlzLmxvYWRTeW5jKHJlcXVlc3QsIHBhcmVudCk7XG5cdFx0aWYgKCFtb2R1bGUpIHtcblx0XHRcdG1vZHVsZSA9IGF3YWl0IHRoaXMudHJhbnNwb3J0LmluaXRpYWxpemUocmVxdWVzdCwgcGFyZW50KTtcblx0XHRcdGlmICghcGFyZW50KSB7XG5cdFx0XHRcdHRoaXMucmVnaXN0cnkubG4ocmVxdWVzdCwgbW9kdWxlLnBpZCk7XG5cdFx0XHR9XG5cdFx0XHRhd2FpdCBtb2R1bGUubG9hZCgpO1xuXHRcdH1cblx0XHRyZXR1cm4gbW9kdWxlO1xuXHR9XG59XG4iXX0=