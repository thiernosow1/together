"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _manifest = _interopRequireDefault(require("../../lib/manifest"));

var _pid = _interopRequireDefault(require("../../lib/helpers/pid"));

var _defineProperties = _interopRequireDefault(require("../../lib/helpers/defineProperties"));

var _noop = _interopRequireDefault(require("../../lib/helpers/noop"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function getMainTag(request) {
  const mainTag = document.querySelector('*[data-remote-modules][data-main]:not([data-mark-sweep])');
  return mainTag && (mainTag.getAttribute('data-module-id') || '').includes(request) ? mainTag : null;
}

function getMainModuleId(request) {
  const mainTag = getMainTag(request);
  return mainTag && mainTag.getAttribute('data-module-id') || undefined;
}

function getMainPid(request) {
  const mainTag = getMainTag(request);
  return mainTag && Number(mainTag.getAttribute('data-pid')) || undefined;
}

function getMainType(request) {
  const mainTag = getMainTag(request);
  return mainTag && (mainTag.tagName === 'LINK' || mainTag.tagName === 'STYLE') ? 'css' : 'js';
}

function getExistingTag(pid) {
  return document.querySelector(`*[data-remote-modules][data-pid="${pid}"]:not([data-mark-sweep])`);
}

class ModuleTransport {
  constructor(loader) {
    _defineProperty(this, "pending", (0, _defineProperties.default)({}, {
      size: {
        get: () => Object.keys(this.pending).length
      }
    }));

    this.loader = loader;
  }

  // eslint-disable-next-line class-methods-use-this
  getResetPredicate() {
    const existing = document.querySelectorAll('*[data-remote-modules]:not([data-mark-sweep])');
    existing.forEach(element => {
      // eslint-disable-next-line no-param-reassign
      element.dataset.markSweep = '';
    });
    return () => {
      existing.forEach(element => {
        element.parentNode.removeChild(element);
      });
    };
  }

  async loadResource(request, parent) {
    const {
      loader
    } = this;
    let {
      moduleId,
      pid,
      type
    } = this.getModuleMeta(request, parent);

    if (!loader.getFromContext(pid)) {
      if (pid) {
        const url = loader.resolveURL(request, parent);

        if (type === 'css') {
          if (!getExistingTag(pid)) {
            await new Promise((resolve, reject) => {
              const link = document.createElement('link');

              link.onload = () => resolve();

              link.onerror = () => reject(new Error(`Failed to load '${url}'`));

              link.rel = 'stylesheet';
              link.href = url;
              link.dataset.pid = pid;
              link.dataset.remoteModules = '';
              document.head.appendChild(link);
            });
          }
        } else {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');

            script.onload = () => resolve();

            script.onerror = () => reject(new Error(`Failed to load '${url}'`));

            script.src = url;
            script.dataset.pid = pid;
            script.dataset.remoteModules = '';
            document.head.appendChild(script);
          });
        }
      } else {
        await Promise.all([this.getManifestJSON(request).then(manifestJSON => {
          const script = document.createElement('script');
          script.type = 'application/json';
          script.dataset.moduleId = manifestJSON.meta.moduleId;
          script.dataset.remoteModules = '';
          script.innerHTML = JSON.stringify(manifestJSON);
          document.head.appendChild(script);
        }), loader.fetch(loader.resolveURL(request, parent)).then(async res => {
          if (res.ok) {
            moduleId = res.headers['x-module-id'];
            pid = Number(res.headers['x-pointer-id']);
            type = res.headers['x-resource-type'];
            const element = document.createElement(type === 'css' ? 'style' : 'script');
            element.dataset.pid = pid;
            element.dataset.remoteModules = '';
            element.innerHTML = await res.text();
            document.head.appendChild(element); // JSDOM doesn't execute scripts synchronously

            if (type === 'js' && process.env.NODE_ENV !== 'production' && !loader.getFromContext(pid)) {
              await new Promise(resolve => {
                element.addEventListener('load', resolve);
              });
            }
          } else {
            const _ref = await res.json(),
                  {
              message
            } = _ref,
                  other = _objectWithoutProperties(_ref, ["message"]);

            const messageWithContext = parent ? `${message}${parent.trace()}` : message;
            throw Object.assign(new Error(messageWithContext), other);
          }
        })]);
      }
    }

    return {
      content: loader.context,
      moduleId,
      pid,
      type
    };
  }

  getModuleMeta(request, parent) {
    const pid = this.loader.resolvePid(request, parent);
    const moduleId = this.loader.resolve(request, parent);
    const type = parent && parent.manifest.getType(pid) || 'js';
    let meta;

    if (pid) {
      meta = {
        pid,
        moduleId,
        type
      };
    } else if (this.loader.getFromContext((0, _pid.default)(moduleId))) {
      meta = {
        pid: (0, _pid.default)(moduleId),
        moduleId,
        type
      };
    } else {
      meta = {
        pid: getMainPid(moduleId),
        moduleId: getMainModuleId(moduleId),
        type: getMainType(moduleId)
      };
    }

    return meta;
  }

  getManifestJSON(id) {
    const manifestScript = document.querySelector(`script[type="application/json"][data-module-id="${id}"]:not([data-mark-sweep])`);
    const json = manifestScript && JSON.parse(manifestScript.innerText || manifestScript.innerHTML);
    return json ? Promise.resolve(json) : this.loader.fetchManifestJSON(id, {
      types: 'css,js'
    });
  }

  initialize(request, parent) {
    const {
      loader,
      pending
    } = this;

    if (!pending[request]) {
      pending[request] = new Promise(async (resolve, reject) => {
        try {
          const {
            content,
            moduleId,
            pid,
            type
          } = await this.loadResource(request, parent);

          if (type === 'js') {
            resolve(loader.register({
              id: moduleId,
              pid,
              content,
              parent
            }));
          } else {
            const m = {
              id: moduleId,
              isMain: !parent,
              exports: {},
              loaded: false,
              manifest: null,
              exec: () => m.exports,
              load: async () => {
                if (m.isMain) {
                  const json = await this.getManifestJSON(m.id);
                  m.manifest = _manifest.default.load(json);
                  await loader.ensure(m);
                }

                m.loaded = true;
                return m;
              }
            };
            resolve(m);
          }
        } catch (err) {
          reject(err);
        }
      });
      pending[request].catch(_noop.default).then(() => {
        delete pending[request];
      });
    }

    return pending[request];
  }

}

exports.default = ModuleTransport;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGllbnQvbW9kdWxlLXRyYW5zcG9ydC9icm93c2VyLmpzIl0sIm5hbWVzIjpbImdldE1haW5UYWciLCJyZXF1ZXN0IiwibWFpblRhZyIsImRvY3VtZW50IiwicXVlcnlTZWxlY3RvciIsImdldEF0dHJpYnV0ZSIsImluY2x1ZGVzIiwiZ2V0TWFpbk1vZHVsZUlkIiwidW5kZWZpbmVkIiwiZ2V0TWFpblBpZCIsIk51bWJlciIsImdldE1haW5UeXBlIiwidGFnTmFtZSIsImdldEV4aXN0aW5nVGFnIiwicGlkIiwiTW9kdWxlVHJhbnNwb3J0IiwiY29uc3RydWN0b3IiLCJsb2FkZXIiLCJzaXplIiwiZ2V0IiwiT2JqZWN0Iiwia2V5cyIsInBlbmRpbmciLCJsZW5ndGgiLCJnZXRSZXNldFByZWRpY2F0ZSIsImV4aXN0aW5nIiwicXVlcnlTZWxlY3RvckFsbCIsImZvckVhY2giLCJlbGVtZW50IiwiZGF0YXNldCIsIm1hcmtTd2VlcCIsInBhcmVudE5vZGUiLCJyZW1vdmVDaGlsZCIsImxvYWRSZXNvdXJjZSIsInBhcmVudCIsIm1vZHVsZUlkIiwidHlwZSIsImdldE1vZHVsZU1ldGEiLCJnZXRGcm9tQ29udGV4dCIsInVybCIsInJlc29sdmVVUkwiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImxpbmsiLCJjcmVhdGVFbGVtZW50Iiwib25sb2FkIiwib25lcnJvciIsIkVycm9yIiwicmVsIiwiaHJlZiIsInJlbW90ZU1vZHVsZXMiLCJoZWFkIiwiYXBwZW5kQ2hpbGQiLCJzY3JpcHQiLCJzcmMiLCJhbGwiLCJnZXRNYW5pZmVzdEpTT04iLCJ0aGVuIiwibWFuaWZlc3RKU09OIiwibWV0YSIsImlubmVySFRNTCIsIkpTT04iLCJzdHJpbmdpZnkiLCJmZXRjaCIsInJlcyIsIm9rIiwiaGVhZGVycyIsInRleHQiLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJhZGRFdmVudExpc3RlbmVyIiwianNvbiIsIm1lc3NhZ2UiLCJvdGhlciIsIm1lc3NhZ2VXaXRoQ29udGV4dCIsInRyYWNlIiwiYXNzaWduIiwiY29udGVudCIsImNvbnRleHQiLCJyZXNvbHZlUGlkIiwibWFuaWZlc3QiLCJnZXRUeXBlIiwiaWQiLCJtYW5pZmVzdFNjcmlwdCIsInBhcnNlIiwiaW5uZXJUZXh0IiwiZmV0Y2hNYW5pZmVzdEpTT04iLCJ0eXBlcyIsImluaXRpYWxpemUiLCJyZWdpc3RlciIsIm0iLCJpc01haW4iLCJleHBvcnRzIiwibG9hZGVkIiwiZXhlYyIsImxvYWQiLCJNYW5pZmVzdCIsImVuc3VyZSIsImVyciIsImNhdGNoIiwibm9vcCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7Ozs7O0FBRUEsU0FBU0EsVUFBVCxDQUFvQkMsT0FBcEIsRUFBNkI7QUFDNUIsUUFBTUMsT0FBTyxHQUFHQyxRQUFRLENBQUNDLGFBQVQsQ0FDZiwwREFEZSxDQUFoQjtBQUdBLFNBQU9GLE9BQU8sSUFBSSxDQUFDQSxPQUFPLENBQUNHLFlBQVIsQ0FBcUIsZ0JBQXJCLEtBQTBDLEVBQTNDLEVBQStDQyxRQUEvQyxDQUF3REwsT0FBeEQsQ0FBWCxHQUNKQyxPQURJLEdBRUosSUFGSDtBQUdBOztBQUVELFNBQVNLLGVBQVQsQ0FBeUJOLE9BQXpCLEVBQWtDO0FBQ2pDLFFBQU1DLE9BQU8sR0FBR0YsVUFBVSxDQUFDQyxPQUFELENBQTFCO0FBQ0EsU0FBUUMsT0FBTyxJQUFJQSxPQUFPLENBQUNHLFlBQVIsQ0FBcUIsZ0JBQXJCLENBQVosSUFBdURHLFNBQTlEO0FBQ0E7O0FBRUQsU0FBU0MsVUFBVCxDQUFvQlIsT0FBcEIsRUFBNkI7QUFDNUIsUUFBTUMsT0FBTyxHQUFHRixVQUFVLENBQUNDLE9BQUQsQ0FBMUI7QUFDQSxTQUFRQyxPQUFPLElBQUlRLE1BQU0sQ0FBQ1IsT0FBTyxDQUFDRyxZQUFSLENBQXFCLFVBQXJCLENBQUQsQ0FBbEIsSUFBeURHLFNBQWhFO0FBQ0E7O0FBRUQsU0FBU0csV0FBVCxDQUFxQlYsT0FB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Q0FBQ1YsUUFBRixHQUFhZ0Isa0JBQVNELElBQVQsQ0FBY3hCLElBQWQsQ0FBYjtBQUNBLHdCQUFNeEQsTUFBTSxDQUFDa0YsTUFBUCxDQUFjUCxDQUFkLENBQU47QUFDQTs7QUFDREEsZ0JBQUFBLENBQUMsQ0FBQ0csTUFBRixHQUFXLElBQVg7QUFDQSx1QkFBT0gsQ0FBUDtBQUNBO0FBZlEsYUFBVjtBQWlCQWxELFlBQUFBLE9BQU8sQ0FBQ2tELENBQUQsQ0FBUDtBQUNBO0FBQ0QsU0F4QkQsQ0F3QkUsT0FBT1EsR0FBUCxFQUFZO0FBQ2J6RCxVQUFBQSxNQUFNLENBQUN5RCxHQUFELENBQU47QUFDQTtBQUNELE9BNUJrQixDQUFuQjtBQTZCQTlFLE1BQUFBLE9BQU8sQ0FBQ3JCLE9BQUQsQ0FBUCxDQUFpQm9HLEtBQWpCLENBQXVCQyxhQUF2QixFQUE2QjVDLElBQTdCLENBQWtDLE1BQU07QUFDdkMsZUFBT3BDLE9BQU8sQ0FBQ3JCLE9BQUQsQ0FBZDtBQUNBLE9BRkQ7QUFHQTs7QUFDRCxXQUFPcUIsT0FBTyxDQUFDckIsT0FBRCxDQUFkO0FBQ0E7O0FBeEttQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1lbnYgYnJvd3NlciAqL1xuXG5pbXBvcnQgTWFuaWZlc3QgZnJvbSAnLi4vLi4vbGliL21hbmlmZXN0JztcbmltcG9ydCBjYWxjdWxhdGVQSUQgZnJvbSAnLi4vLi4vbGliL2hlbHBlcnMvcGlkJztcbmltcG9ydCBkZWZpbmVQcm9wZXJ0aWVzIGZyb20gJy4uLy4uL2xpYi9oZWxwZXJzL2RlZmluZVByb3BlcnRpZXMnO1xuaW1wb3J0IG5vb3AgZnJvbSAnLi4vLi4vbGliL2hlbHBlcnMvbm9vcCc7XG5cbmZ1bmN0aW9uIGdldE1haW5UYWcocmVxdWVzdCkge1xuXHRjb25zdCBtYWluVGFnID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihcblx0XHQnKltkYXRhLXJlbW90ZS1tb2R1bGVzXVtkYXRhLW1haW5dOm5vdChbZGF0YS1tYXJrLXN3ZWVwXSknXG5cdCk7XG5cdHJldHVybiBtYWluVGFnICYmIChtYWluVGFnLmdldEF0dHJpYnV0ZSgnZGF0YS1tb2R1bGUtaWQnKSB8fCAnJykuaW5jbHVkZXMocmVxdWVzdClcblx0XHQ/IG1haW5UYWdcblx0XHQ6IG51bGw7XG59XG5cbmZ1bmN0aW9uIGdldE1haW5Nb2R1bGVJZChyZXF1ZXN0KSB7XG5cdGNvbnN0IG1haW5UYWcgPSBnZXRNYWluVGFnKHJlcXVlc3QpO1xuXHRyZXR1cm4gKG1haW5UYWcgJiYgbWFpblRhZy5nZXRBdHRyaWJ1dGUoJ2RhdGEtbW9kdWxlLWlkJykpIHx8IHVuZGVmaW5lZDtcbn1cblxuZnVuY3Rpb24gZ2V0TWFpblBpZChyZXF1ZXN0KSB7XG5cdGNvbnN0IG1haW5UYWcgPSBnZXRNYWluVGFnKHJlcXVlc3QpO1xuXHRyZXR1cm4gKG1haW5UYWcgJiYgTnVtYmVyKG1haW5UYWcuZ2V0QXR0cmlidXRlKCdkYXRhLXBpZCcpKSkgfHwgdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiBnZXRNYWluVHlwZShyZXF1ZXN0KSB7XG5cdGNvbnN0IG1haW5UYWcgPSBnZXRNYWluVGFnKHJlcXVlc3QpO1xuXHRyZXR1cm4gbWFpblRhZyAmJiAobWFpblRhZy50YWdOYW1lID09PSAnTElOSycgfHwgbWFpblRhZy50YWdOYW1lID09PSAnU1RZTEUnKSA/ICdjc3MnIDogJ2pzJztcbn1cblxuZnVuY3Rpb24gZ2V0RXhpc3RpbmdUYWcocGlkKSB7XG5cdHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAqW2RhdGEtcmVtb3RlLW1vZHVsZXNdW2RhdGEtcGlkPVwiJHtwaWR9XCJdOm5vdChbZGF0YS1tYXJrLXN3ZWVwXSlgKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTW9kdWxlVHJhbnNwb3J0IHtcblx0Y29uc3RydWN0b3IobG9hZGVyKSB7XG5cdFx0dGhpcy5sb2FkZXIgPSBsb2FkZXI7XG5cdH1cblxuXHRwZW5kaW5nID0gZGVmaW5lUHJvcGVydGllcyhcblx0XHR7fSxcblx0XHR7XG5cdFx0XHRzaXplOiB7XG5cdFx0XHRcdGdldDogKCkgPT4gT2JqZWN0LmtleXModGhpcy5wZW5kaW5nKS5sZW5ndGhcblx0XHRcdH1cblx0XHR9XG5cdCk7XG5cblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNsYXNzLW1ldGhvZHMtdXNlLXRoaXNcblx0Z2V0UmVzZXRQcmVkaWNhdGUoKSB7XG5cdFx0Y29uc3QgZXhpc3RpbmcgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcqW2RhdGEtcmVtb3RlLW1vZHVsZXNdOm5vdChbZGF0YS1tYXJrLXN3ZWVwXSknKTtcblx0XHRleGlzdGluZy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuXHRcdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXBhcmFtLXJlYXNzaWduXG5cdFx0XHRlbGVtZW50LmRhdGFzZXQubWFya1N3ZWVwID0gJyc7XG5cdFx0fSk7XG5cdFx0cmV0dXJuICgpID0+IHtcblx0XHRcdGV4aXN0aW5nLmZvckVhY2goZWxlbWVudCA9PiB7XG5cdFx0XHRcdGVsZW1lbnQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbGVtZW50KTtcblx0XHRcdH0pO1xuXHRcdH07XG5cdH1cblxuXHRhc3luYyBsb2FkUmVzb3VyY2UocmVxdWVzdCwgcGFyZW50KSB7XG5cdFx0Y29uc3QgeyBsb2FkZXIgfSA9IHRoaXM7XG5cdFx0bGV0IHsgbW9kdWxlSWQsIHBpZCwgdHlwZSB9ID0gdGhpcy5nZXRNb2R1bGVNZXRhKHJlcXVlc3QsIHBhcmVudCk7XG5cblx0XHRpZiAoIWxvYWRlci5nZXRGcm9tQ29udGV4dChwaWQpKSB7XG5cdFx0XHRpZiAocGlkKSB7XG5cdFx0XHRcdGNvbnN0IHVybCA9IGxvYWRlci5yZXNvbHZlVVJMKHJlcXVlc3QsIHBhcmVudCk7XG5cdFx0XHRcdGlmICh0eXBlID09PSAnY3NzJykge1xuXHRcdFx0XHRcdGlmICghZ2V0RXhpc3RpbmdUYWcocGlkKSkge1xuXHRcdFx0XHRcdFx0YXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRjb25zdCBsaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpO1xuXHRcdFx0XHRcdFx0XHRsaW5rLm9ubG9hZCA9ICgpID0+IHJlc29sdmUoKTtcblx0XHRcdFx0XHRcdFx0bGluay5vbmVycm9yID0gKCkgPT4gcmVqZWN0KG5ldyBFcnJvcihgRmFpbGVkIHRvIGxvYWQgJyR7dXJsfSdgKSk7XG5cdFx0XHRcdFx0XHRcdGxpbmsucmVsID0gJ3N0eWxlc2hlZXQnO1xuXHRcdFx0XHRcdFx0XHRsaW5rLmhyZWYgPSB1cmw7XG5cdFx0XHRcdFx0XHRcdGxpbmsuZGF0YXNldC5waWQgPSBwaWQ7XG5cdFx0XHRcdFx0XHRcdGxpbmsuZGF0YXNldC5yZW1vdGVNb2R1bGVzID0gJyc7XG5cdFx0XHRcdFx0XHRcdGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQobGluayk7XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0YXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0XHRcdFx0Y29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG5cdFx0XHRcdFx0XHRzY3JpcHQub25sb2FkID0gKCkgPT4gcmVzb2x2ZSgpO1xuXHRcdFx0XHRcdFx0c2NyaXB0Lm9uZXJyb3IgPSAoKSA9PiByZWplY3QobmV3IEVycm9yKGBGYWlsZWQgdG8gbG9hZCAnJHt1cmx9J2ApKTtcblx0XHRcdFx0XHRcdHNjcmlwdC5zcmMgPSB1cmw7XG5cdFx0XHRcdFx0XHRzY3JpcHQuZGF0YXNldC5waWQgPSBwaWQ7XG5cdFx0XHRcdFx0XHRzY3JpcHQuZGF0YXNldC5yZW1vdGVNb2R1bGVzID0gJyc7XG5cdFx0XHRcdFx0XHRkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGF3YWl0IFByb21pc2UuYWxsKFtcblx0XHRcdFx0XHR0aGlzLmdldE1hbmlmZXN0SlNPTihyZXF1ZXN0KS50aGVuKG1hbmlmZXN0SlNPTiA9PiB7XG5cdFx0XHRcdFx0XHRjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcblx0XHRcdFx0XHRcdHNjcmlwdC50eXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nO1xuXHRcdFx0XHRcdFx0c2NyaXB0LmRhdGFzZXQubW9kdWxlSWQgPSBtYW5pZmVzdEpTT04ubWV0YS5tb2R1bGVJZDtcblx0XHRcdFx0XHRcdHNjcmlwdC5kYXRhc2V0LnJlbW90ZU1vZHVsZXMgPSAnJztcblx0XHRcdFx0XHRcdHNjcmlwdC5pbm5lckhUTUwgPSBKU09OLnN0cmluZ2lmeShtYW5pZmVzdEpTT04pO1xuXHRcdFx0XHRcdFx0ZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpO1xuXHRcdFx0XHRcdH0pLFxuXHRcdFx0XHRcdGxvYWRlci5mZXRjaChsb2FkZXIucmVzb2x2ZVVSTChyZXF1ZXN0LCBwYXJlbnQpKS50aGVuKGFzeW5jIHJlcyA9PiB7XG5cdFx0XHRcdFx0XHRpZiAocmVzLm9rKSB7XG5cdFx0XHRcdFx0XHRcdG1vZHVsZUlkID0gcmVzLmhlYWRlcnNbJ3gtbW9kdWxlLWlkJ107XG5cdFx0XHRcdFx0XHRcdHBpZCA9IE51bWJlcihyZXMuaGVhZGVyc1sneC1wb2ludGVyLWlkJ10pO1xuXHRcdFx0XHRcdFx0XHR0eXBlID0gcmVzLmhlYWRlcnNbJ3gtcmVzb3VyY2UtdHlwZSddO1xuXG5cdFx0XHRcdFx0XHRcdGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHR5cGUgPT09ICdjc3MnID8gJ3N0eWxlJyA6ICdzY3JpcHQnKTtcblx0XHRcdFx0XHRcdFx0ZWxlbWVudC5kYXRhc2V0LnBpZCA9IHBpZDtcblx0XHRcdFx0XHRcdFx0ZWxlbWVudC5kYXRhc2V0LnJlbW90ZU1vZHVsZXMgPSAnJztcblx0XHRcdFx0XHRcdFx0ZWxlbWVudC5pbm5lckhUTUwgPSBhd2FpdCByZXMudGV4dCgpO1xuXHRcdFx0XHRcdFx0XHRkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGVsZW1lbnQpO1xuXG5cdFx0XHRcdFx0XHRcdC8vIEpTRE9NIGRvZXNuJ3QgZXhlY3V0ZSBzY3JpcHRzIHN5bmNocm9ub3VzbHlcblx0XHRcdFx0XHRcdFx0aWYgKFxuXHRcdFx0XHRcdFx0XHRcdHR5cGUgPT09ICdqcycgJiZcblx0XHRcdFx0XHRcdFx0XHRwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmXG5cdFx0XHRcdFx0XHRcdFx0IWxvYWRlci5nZXRGcm9tQ29udGV4dChwaWQpXG5cdFx0XHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0XHRcdGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdFx0ZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgcmVzb2x2ZSk7XG5cdFx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IHsgbWVzc2FnZSwgLi4ub3RoZXIgfSA9IGF3YWl0IHJlcy5qc29uKCk7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IG1lc3NhZ2VXaXRoQ29udGV4dCA9IHBhcmVudCA/IGAke21lc3NhZ2V9JHtwYXJlbnQudHJhY2UoKX1gIDogbWVzc2FnZTtcblx0XHRcdFx0XHRcdFx0dGhyb3cgT2JqZWN0LmFzc2lnbihuZXcgRXJyb3IobWVzc2FnZVdpdGhDb250ZXh0KSwgb3RoZXIpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdF0pO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB7IGNvbnRlbnQ6IGxvYWRlci5jb250ZXh0LCBtb2R1bGVJZCwgcGlkLCB0eXBlIH07XG5cdH1cblxuXHRnZXRNb2R1bGVNZXRhKHJlcXVlc3QsIHBhcmVudCkge1xuXHRcdGNvbnN0IHBpZCA9IHRoaXMubG9hZGVyLnJlc29sdmVQaWQocmVxdWVzdCwgcGFyZW50KTtcblx0XHRjb25zdCBtb2R1bGVJZCA9IHRoaXMubG9hZGVyLnJlc29sdmUocmVxdWVzdCwgcGFyZW50KTtcblx0XHRjb25zdCB0eXBlID0gKHBhcmVudCAmJiBwYXJlbnQubWFuaWZlc3QuZ2V0VHlwZShwaWQpKSB8fCAnanMnO1xuXHRcdGxldCBtZXRhO1xuXHRcdGlmIChwaWQpIHtcblx0XHRcdG1ldGEgPSB7IHBpZCwgbW9kdWxlSWQsIHR5cGUgfTtcblx0XHR9IGVsc2UgaWYgKHRoaXMubG9hZGVyLmdldEZyb21Db250ZXh0KGNhbGN1bGF0ZVBJRChtb2R1bGVJZCkpKSB7XG5cdFx0XHRtZXRhID0geyBwaWQ6IGNhbGN1bGF0ZVBJRChtb2R1bGVJZCksIG1vZHVsZUlkLCB0eXBlIH07XG5cdFx0fSBlbHNlIHtcblx0XHRcdG1ldGEgPSB7XG5cdFx0XHRcdHBpZDogZ2V0TWFpblBpZChtb2R1bGVJZCksXG5cdFx0XHRcdG1vZHVsZUlkOiBnZXRNYWluTW9kdWxlSWQobW9kdWxlSWQpLFxuXHRcdFx0XHR0eXBlOiBnZXRNYWluVHlwZShtb2R1bGVJZClcblx0XHRcdH07XG5cdFx0fVxuXHRcdHJldHVybiBtZXRhO1xuXHR9XG5cblx0Z2V0TWFuaWZlc3RKU09OKGlkKSB7XG5cdFx0Y29uc3QgbWFuaWZlc3RTY3JpcHQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFxuXHRcdFx0YHNjcmlwdFt0eXBlPVwiYXBwbGljYXRpb24vanNvblwiXVtkYXRhLW1vZHVsZS1pZD1cIiR7aWR9XCJdOm5vdChbZGF0YS1tYXJrLXN3ZWVwXSlgXG5cdFx0KTtcblx0XHRjb25zdCBqc29uID0gbWFuaWZlc3RTY3JpcHQgJiYgSlNPTi5wYXJzZShtYW5pZmVzdFNjcmlwdC5pbm5lclRleHQgfHwgbWFuaWZlc3RTY3JpcHQuaW5uZXJIVE1MKTtcblx0XHRyZXR1cm4ganNvbiA/IFByb21pc2UucmVzb2x2ZShqc29uKSA6IHRoaXMubG9hZGVyLmZldGNoTWFuaWZlc3RKU09OKGlkLCB7IHR5cGVzOiAnY3NzLGpzJyB9KTtcblx0fVxuXG5cdGluaXRpYWxpemUocmVxdWVzdCwgcGFyZW50KSB7XG5cdFx0Y29uc3QgeyBsb2FkZXIsIHBlbmRpbmcgfSA9IHRoaXM7XG5cdFx0aWYgKCFwZW5kaW5nW3JlcXVlc3RdKSB7XG5cdFx0XHRwZW5kaW5nW3JlcXVlc3RdID0gbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdGNvbnN0IHsgY29udGVudCwgbW9kdWxlSWQsIHBpZCwgdHlwZSB9ID0gYXdhaXQgdGhpcy5sb2FkUmVzb3VyY2UocmVxdWVzdCwgcGFyZW50KTtcblx0XHRcdFx0XHRpZiAodHlwZSA9PT0gJ2pzJykge1xuXHRcdFx0XHRcdFx0cmVzb2x2ZShsb2FkZXIucmVnaXN0ZXIoeyBpZDogbW9kdWxlSWQsIHBpZCwgY29udGVudCwgcGFyZW50IH0pKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0Y29uc3QgbSA9IHtcblx0XHRcdFx0XHRcdFx0aWQ6IG1vZHVsZUlkLFxuXHRcdFx0XHRcdFx0XHRpc01haW46ICFwYXJlbnQsXG5cdFx0XHRcdFx0XHRcdGV4cG9ydHM6IHt9LFxuXHRcdFx0XHRcdFx0XHRsb2FkZWQ6IGZhbHNlLFxuXHRcdFx0XHRcdFx0XHRtYW5pZmVzdDogbnVsbCxcblx0XHRcdFx0XHRcdFx0ZXhlYzogKCkgPT4gbS5leHBvcnRzLFxuXHRcdFx0XHRcdFx0XHRsb2FkOiBhc3luYyAoKSA9PiB7XG5cdFx0XHRcdFx0XHRcdFx0aWYgKG0uaXNNYWluKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRjb25zdCBqc29uID0gYXdhaXQgdGhpcy5nZXRNYW5pZmVzdEpTT04obS5pZCk7XG5cdFx0XHRcdFx0XHRcdFx0XHRtLm1hbmlmZXN0ID0gTWFuaWZlc3QubG9hZChqc29uKTtcblx0XHRcdFx0XHRcdFx0XHRcdGF3YWl0IGxvYWRlci5lbnN1cmUobSk7XG5cdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdG0ubG9hZGVkID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gbTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fTtcblx0XHRcdFx0XHRcdHJlc29sdmUobSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdFx0XHRyZWplY3QoZXJyKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0XHRwZW5kaW5nW3JlcXVlc3RdLmNhdGNoKG5vb3ApLnRoZW4oKCkgPT4ge1xuXHRcdFx0XHRkZWxldGUgcGVuZGluZ1tyZXF1ZXN0XTtcblx0XHRcdH0pO1xuXHRcdH1cblx0XHRyZXR1cm4gcGVuZGluZ1tyZXF1ZXN0XTtcblx0fVxufVxuIl19