"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ContextMiddleware = ContextMiddleware;
exports.ExternalMiddleware = ExternalMiddleware;
exports.RewriteMiddleware = RewriteMiddleware;
exports.NullMiddleware = NullMiddleware;
exports.ResourceMiddleware = ResourceMiddleware;
exports.UnionMiddleware = void 0;

var _interpolator = _interopRequireDefault(require("../interpolator"));

var _defineProperties = _interopRequireDefault(require("../helpers/defineProperties"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class Middleware {
  static parseArgs(args) {
    const apply = args.pop();
    let test = args.pop() || /.*/;

    if (test instanceof RegExp) {
      const regexp = test;

      test = ({
        moduleId,
        request = moduleId
      }) => regexp.test(request);
    }

    if (typeof apply !== 'function' || typeof test !== 'function') {
      throw new TypeError('middleware signature is ([RegExp|Function], Function)');
    }

    return {
      test,
      apply
    };
  }

  constructor(descriptors) {
    _defineProperty(this, "fn", (...args) => this.test(...args) ? this.apply(...args) : undefined);

    if (!descriptors.type) {
      throw new Error('Middleware type is required');
    }

    (0, _defineProperties.default)(this, descriptors, {
      enumerable: true
    });
  }

}

function ContextMiddleware(...args) {
  return new Middleware(_objectSpread({
    type: 'context',
    name: 'ContextMiddleware'
  }, Middleware.parseArgs(args)));
}

function ExternalMiddleware(test) {
  return new Middleware(_objectSpread({
    type: 'context',
    name: 'ExternalMiddleware'
  }, Middleware.parseArgs([test, ctx => {
    ctx.external = true;
    ctx.force = ctx.request;
  }])));
}

function RewriteMiddleware(...args) {
  const {
    test,
    apply
  } = Middleware.parseArgs(args);
  return new Middleware({
    type: 'context',
    name: 'RewriteMiddleware',
    apply: ctx => {
      const result = apply(ctx);

      if (result !== undefined) {
        ctx.request = result;
      }
    },
    test
  });
}

function NullMiddleware(test) {
  return RewriteMiddleware(test, () => null);
}

function ResourceMiddleware(...args) {
  const {
    test,
    apply
  } = Middleware.parseArgs(args);
  return new Middleware({
    type: 'resource',
    name: 'ResourceMiddleware',
    test: (resource, ctx) => resource.isNormal() && resource.adapter.outputType !== 'raw' && test(resource, ctx),
    apply
  });
}

const UnionMiddleware = (() => {
  const interpolator = new _interpolator.default();
  let privateInstanceCounter = 0; // eslint-disable-next-line no-shadow

  return function UnionMiddleware(_ref = {}) {
    let {
      template,
      test
    } = _ref,
        options = _objectWithoutProperties(_ref, ["template", "test"]);

    const instanceId = privateInstanceCounter;
    privateInstanceCounter += 1;

    function getUnionId(resource) {
      return interpolator([instanceId, template, '{async}', '{adapter.outputType}'].filter(v => v !== undefined).join('_'), resource);
    }

    const {
      test: testFn,
      apply
    } = Middleware.parseArgs([test, resource => {
      resource.addToUnion(getUnionId(resource), options);
    }]);
    return new Middleware({
      type: 'resource',
      name: 'UnionMiddleware',
      test: (resource, ctx) => resource.isNormal() && resource.adapter.outputType !== 'raw' && testFn(resource, ctx),
      apply
    });
  };
})();

exports.UnionMiddleware = UnionMiddleware;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvY29uZmlnLXN0b3JlL21pZGRsZXdhcmUuanMiXSwibmFtZXMiOlsiTWlkZGxld2FyZSIsInBhcnNlQXJncyIsImFyZ3MiLCJhcHBseSIsInBvcCIsInRlc3QiLCJSZWdFeHAiLCJyZWdleHAiLCJtb2R1bGVJZCIsInJlcXVlc3QiLCJUeXBlRXJyb3IiLCJjb25zdHJ1Y3RvciIsImRlc2NyaXB0b3JzIiwidW5kZWZpbmVkIiwidHlwZSIsIkVycm9yIiwiZW51bWVyYWJsZSIsIkNvbnRleHRNaWRkbGV3YXJlIiwibmFtZSIsIkV4dGVybmFsTWlkZGxld2FyZSIsImN0eCIsImV4dGVybmFsIiwiZm9yY2UiLCJSZXdyaXRlTWlkZGxld2FyZSIsInJlc3VsdCIsIk51bGxNaWRkbGV3YXJlIiwiUmVzb3VyY2VNaWRkbGV3YXJlIiwicmVzb3VyY2UiLCJpc05vcm1hbCIsImFkYXB0ZXIiLCJvdXRwdXRUeXBlIiwiVW5pb25NaWRkbGV3YXJlIiwiaW50ZXJwb2xhdG9yIiwiSW50ZXJwb2xhdG9yIiwicHJpdmF0ZUluc3RhbmNlQ291bnRlciIsInRlbXBsYXRlIiwib3B0aW9ucyIsImluc3RhbmNlSWQiLCJnZXRVbmlvbklkIiwiZmlsdGVyIiwidiIsImpvaW4iLCJ0ZXN0Rm4iLCJhZGRUb1VuaW9uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7Ozs7Ozs7Ozs7O0FBRUEsTUFBTUEsVUFBTixDQUFpQjtBQUNoQixTQUFPQyxTQUFQLENBQWlCQyxJQUFqQixFQUF1QjtBQUN0QixVQUFNQyxLQUFLLEdBQUdELElBQUksQ0FBQ0UsR0FBTCxFQUFkO0FBQ0EsUUFBSUMsSUFBSSxHQUFHSCxJQUFJLENBQUNFLEdBQUwsTUFBYyxJQUF6Qjs7QUFDQSxRQUFJQyxJQUFJLFlBQVlDLE1BQXBCLEVBQTRCO0FBQzNCLFlBQU1DLE1BQU0sR0FBR0YsSUFBZjs7QUFDQUEsTUFBQUEsSUFBSSxHQUFHLENBQUM7QUFBRUcsUUFBQUEs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LElBQUksRUFBRSxVQURlO0FBRXJCSSxNQUFBQSxJQUFJLEVBQUUsaUJBRmU7QUFHckJiLE1BQUFBLElBQUksRUFBRSxDQUFDc0IsUUFBRCxFQUFXUCxHQUFYLEtBQ0xPLFFBQVEsQ0FBQ0MsUUFBVCxNQUF1QkQsUUFBUSxDQUFDRSxPQUFULENBQWlCQyxVQUFqQixLQUFnQyxLQUF2RCxJQUFnRVksTUFBTSxDQUFDZixRQUFELEVBQVdQLEdBQVgsQ0FKbEQ7QUFLckJqQixNQUFBQTtBQUxxQixLQUFmLENBQVA7QUFPQSxHQTNCRDtBQTRCQSxDQWpDOEIsR0FBeEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgSW50ZXJwb2xhdG9yIGZyb20gJy4uL2ludGVycG9sYXRvcic7XG5pbXBvcnQgZGVmaW5lUHJvcGVydGllcyBmcm9tICcuLi9oZWxwZXJzL2RlZmluZVByb3BlcnRpZXMnO1xuXG5jbGFzcyBNaWRkbGV3YXJlIHtcblx0c3RhdGljIHBhcnNlQXJncyhhcmdzKSB7XG5cdFx0Y29uc3QgYXBwbHkgPSBhcmdzLnBvcCgpO1xuXHRcdGxldCB0ZXN0ID0gYXJncy5wb3AoKSB8fCAvLiovO1xuXHRcdGlmICh0ZXN0IGluc3RhbmNlb2YgUmVnRXhwKSB7XG5cdFx0XHRjb25zdCByZWdleHAgPSB0ZXN0O1xuXHRcdFx0dGVzdCA9ICh7IG1vZHVsZUlkLCByZXF1ZXN0ID0gbW9kdWxlSWQgfSkgPT4gcmVnZXhwLnRlc3QocmVxdWVzdCk7XG5cdFx0fVxuXHRcdGlmICh0eXBlb2YgYXBwbHkgIT09ICdmdW5jdGlvbicgfHwgdHlwZW9mIHRlc3QgIT09ICdmdW5jdGlvbicpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoJ21pZGRsZXdhcmUgc2lnbmF0dXJlIGlzIChbUmVnRXhwfEZ1bmN0aW9uXSwgRnVuY3Rpb24pJyk7XG5cdFx0fVxuXHRcdHJldHVybiB7IHRlc3QsIGFwcGx5IH07XG5cdH1cblxuXHRjb25zdHJ1Y3RvcihkZXNjcmlwdG9ycykge1xuXHRcdGlmICghZGVzY3JpcHRvcnMudHlwZSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdNaWRkbGV3YXJlIHR5cGUgaXMgcmVxdWlyZWQnKTtcblx0XHR9XG5cdFx0ZGVmaW5lUHJvcGVydGllcyh0aGlzLCBkZXNjcmlwdG9ycywgeyBlbnVtZXJhYmxlOiB0cnVlIH0pO1xuXHR9XG5cblx0Zm4gPSAoLi4uYXJncykgPT4gKHRoaXMudGVzdCguLi5hcmdzKSA/IHRoaXMuYXBwbHkoLi4uYXJncykgOiB1bmRlZmluZWQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gQ29udGV4dE1pZGRsZXdhcmUoLi4uYXJncykge1xuXHRyZXR1cm4gbmV3IE1pZGRsZXdhcmUoe1xuXHRcdHR5cGU6ICdjb250ZXh0Jyxcblx0XHRuYW1lOiAnQ29udGV4dE1pZGRsZXdhcmUnLFxuXHRcdC4uLk1pZGRsZXdhcmUucGFyc2VBcmdzKGFyZ3MpXG5cdH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gRXh0ZXJuYWxNaWRkbGV3YXJlKHRlc3QpIHtcblx0cmV0dXJuIG5ldyBNaWRkbGV3YXJlKHtcblx0XHR0eXBlOiAnY29udGV4dCcsXG5cdFx0bmFtZTogJ0V4dGVybmFsTWlkZGxld2FyZScsXG5cdFx0Li4uTWlkZGxld2FyZS5wYXJzZUFyZ3MoW1xuXHRcdFx0dGVzdCxcblx0XHRcdGN0eCA9PiB7XG5cdFx0XHRcdGN0eC5leHRlcm5hbCA9IHRydWU7XG5cdFx0XHRcdGN0eC5mb3JjZSA9IGN0eC5yZXF1ZXN0O1xuXHRcdFx0fVxuXHRcdF0pXG5cdH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gUmV3cml0ZU1pZGRsZXdhcmUoLi4uYXJncykge1xuXHRjb25zdCB7IHRlc3QsIGFwcGx5IH0gPSBNaWRkbGV3YXJlLnBhcnNlQXJncyhhcmdzKTtcblx0cmV0dXJuIG5ldyBNaWRkbGV3YXJlKHtcblx0XHR0eXBlOiAnY29udGV4dCcsXG5cdFx0bmFtZTogJ1Jld3JpdGVNaWRkbGV3YXJlJyxcblx0XHRhcHBseTogY3R4ID0+IHtcblx0XHRcdGNvbnN0IHJlc3VsdCA9IGFwcGx5KGN0eCk7XG5cdFx0XHRpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0Y3R4LnJlcXVlc3QgPSByZXN1bHQ7XG5cdFx0XHR9XG5cdFx0fSxcblx0XHR0ZXN0XG5cdH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gTnVsbE1pZGRsZXdhcmUodGVzdCkge1xuXHRyZXR1cm4gUmV3cml0ZU1pZGRsZXdhcmUodGVzdCwgKCkgPT4gbnVsbCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBSZXNvdXJjZU1pZGRsZXdhcmUoLi4uYXJncykge1xuXHRjb25zdCB7IHRlc3QsIGFwcGx5IH0gPSBNaWRkbGV3YXJlLnBhcnNlQXJncyhhcmdzKTtcblx0cmV0dXJuIG5ldyBNaWRkbGV3YXJlKHtcblx0XHR0eXBlOiAncmVzb3VyY2UnLFxuXHRcdG5hbWU6ICdSZXNvdXJjZU1pZGRsZXdhcmUnLFxuXHRcdHRlc3Q6IChyZXNvdXJjZSwgY3R4KSA9PlxuXHRcdFx0cmVzb3VyY2UuaXNOb3JtYWwoKSAmJiByZXNvdXJjZS5hZGFwdGVyLm91dHB1dFR5cGUgIT09ICdyYXcnICYmIHRlc3QocmVzb3VyY2UsIGN0eCksXG5cdFx0YXBwbHlcblx0fSk7XG59XG5cbmV4cG9ydCBjb25zdCBVbmlvbk1pZGRsZXdhcmUgPSAoKCkgPT4ge1xuXHRjb25zdCBpbnRlcnBvbGF0b3IgPSBuZXcgSW50ZXJwb2xhdG9yKCk7XG5cdGxldCBwcml2YXRlSW5zdGFuY2VDb3VudGVyID0gMDtcblxuXHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tc2hhZG93XG5cdHJldHVybiBmdW5jdGlvbiBVbmlvbk1pZGRsZXdhcmUoeyB0ZW1wbGF0ZSwgdGVzdCwgLi4ub3B0aW9ucyB9ID0ge30pIHtcblx0XHRjb25zdCBpbnN0YW5jZUlkID0gcHJpdmF0ZUluc3RhbmNlQ291bnRlcjtcblx0XHRwcml2YXRlSW5zdGFuY2VDb3VudGVyICs9IDE7XG5cblx0XHRmdW5jdGlvbiBnZXRVbmlvbklkKHJlc291cmNlKSB7XG5cdFx0XHRyZXR1cm4gaW50ZXJwb2xhdG9yKFxuXHRcdFx0XHRbaW5zdGFuY2VJZCwgdGVtcGxhdGUsICd7YXN5bmN9JywgJ3thZGFwdGVyLm91dHB1dFR5cGV9J11cblx0XHRcdFx0XHQuZmlsdGVyKHYgPT4gdiAhPT0gdW5kZWZpbmVkKVxuXHRcdFx0XHRcdC5qb2luKCdfJyksXG5cdFx0XHRcdHJlc291cmNlXG5cdFx0XHQpO1xuXHRcdH1cblxuXHRcdGNvbnN0IHsgdGVzdDogdGVzdEZuLCBhcHBseSB9ID0gTWlkZGxld2FyZS5wYXJzZUFyZ3MoW1xuXHRcdFx0dGVzdCxcblx0XHRcdHJlc291cmNlID0+IHtcblx0XHRcdFx0cmVzb3VyY2UuYWRkVG9VbmlvbihnZXRVbmlvbklkKHJlc291cmNlKSwgb3B0aW9ucyk7XG5cdFx0XHR9XG5cdFx0XSk7XG5cblx0XHRyZXR1cm4gbmV3IE1pZGRsZXdhcmUoe1xuXHRcdFx0dHlwZTogJ3Jlc291cmNlJyxcblx0XHRcdG5hbWU6ICdVbmlvbk1pZGRsZXdhcmUnLFxuXHRcdFx0dGVzdDogKHJlc291cmNlLCBjdHgpID0+XG5cdFx0XHRcdHJlc291cmNlLmlzTm9ybWFsKCkgJiYgcmVzb3VyY2UuYWRhcHRlci5vdXRwdXRUeXBlICE9PSAncmF3JyAmJiB0ZXN0Rm4ocmVzb3VyY2UsIGN0eCksXG5cdFx0XHRhcHBseVxuXHRcdH0pO1xuXHR9O1xufSkoKTtcbiJdfQ==